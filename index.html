<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Devis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: white;
            color: black;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #f4e600;
            background-color: white;
            padding: 15px;
        }

        .section {
            border: 2px solid #f4e600;
            background-color: white;
            margin-bottom: 20px;
            padding: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .quote-type-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .quote-type-btn {
            background-color: #f4e600;
            border: 2px solid #f4e600;
            padding: 15px 30px;
            margin: 0 10px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        .quote-type-btn.active {
            background-color: black;
            color: white;
        }

        .add-product-btn {
            background-color: #999;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .add-product-btn:hover {
            background-color: #777;
        }

        .product-line {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .product-line select {
            flex: 2;
        }

        .product-line input {
            flex: 1;
        }

        .remove-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .payment-options {
            margin-top: 15px;
        }

        .payment-options label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }

        .payment-options input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .total-section {
            background-color: #f9f9f9;
            border: 2px solid #f4e600;
            padding: 20px;
            margin-top: 30px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .total-line.grand-total {
            font-weight: bold;
            font-size: 20px;
            border-top: 2px solid #f4e600;
            padding-top: 10px;
        }

        .export-btn {
            background-color: #f4e600;
            border: 2px solid #f4e600;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            width: 100%;
        }

        .export-btn:hover {
            background-color: #e6d000;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
            
            .product-line {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Générateur de Devis</h1>

        <!-- Sélecteur de type de devis -->
        <div class="quote-type-selector">
            <button class="quote-type-btn active" onclick="setQuoteType('alarm')">Devis Alarme</button>
            <button class="quote-type-btn" onclick="setQuoteType('camera')">Devis Caméra de Surveillance</button>
        </div>

        <!-- Informations client -->
        <div class="section">
            <h2>Informations Client</h2>
            <div class="two-columns">
                <div>
                    <div class="form-group">
                        <label for="clientName">Nom :</label>
                        <input type="text" id="clientName" placeholder="Nom du client">
                    </div>
                    <div class="form-group">
                        <label for="clientFirstName">Prénom :</label>
                        <input type="text" id="clientFirstName" placeholder="Prénom du client">
                    </div>
                    <div class="form-group">
                        <label for="clientCompany">Société :</label>
                        <input type="text" id="clientCompany" placeholder="Nom de la société">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="clientAddress">Adresse :</label>
                        <textarea id="clientAddress" rows="4" placeholder="Adresse complète du client"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="advisor">Conseiller :</label>
                        <select id="advisor">
                            <option value="">Sélectionner un conseiller</option>
                            <option value="Arnaud Bloch">Arnaud Bloch</option>
                            <option value="Alikhan Guisseinov">Alikhan Guisseinov</option>
                            <option value="Benali Kodad">Benali Kodad</option>
                            <option value="Heythem Ziaya">Heythem Ziaya</option>
                            <option value="Matys Goiot">Matys Goiot</option>
                            <option value="Mohamed Tartik">Mohamed Tartik</option>
                            <option value="Nassim Jaza">Nassim Jaza</option>
                            <option value="Samir Ouhameni">Samir Ouhameni</option>
                            <option value="Thomas Garcia">Thomas Garcia</option>
                            <option value="Wassim Tahiri">Wassim Tahiri</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sections de devis dynamiques -->
        <div id="quote-sections"></div>

        <!-- Section totaux -->
        <div class="total-section">
            <h2>Totaux</h2>
            <div id="totals"></div>
            <button class="export-btn" onclick="exportToPDF()">Exporter en PDF</button>
        </div>
    </div>

    <script>
        let currentQuoteType = 'alarm';
        let quoteData = {
            alarm: {
                material: [],
                installation: [],
                admin: []
            },
            camera: {
                material: [],
                installation: [],
                remote: { enabled: false, products: [] },
                maintenance: []
            }
        };

        const TVA_RATE = 0.077; // TVA 7.7%

        // Catalogue de produits (prix HT)
        const catalog = {};
        
        catalog['alarm-material'] = [
            { id: 1, name: 'Bouton panique/Montre d\'urgence (radio)', price: 35.00 },
            { id: 2, name: 'Barrière extérieure 2x12 mètres (radio)', price: 35.00 },
            { id: 3, name: 'Badge x 4', price: 25.00 },
            { id: 4, name: 'Centrale AX Pro', price: 6900.00 },
            { id: 5, name: 'Centrale Jablotron', price: 990.00 },
            { id: 6, name: 'Centrale Titane', price: 690.00 },
            { id: 7, name: 'Clavier (radio)', price: 45.00 },
            { id: 8, name: 'Détecteur volumétrique (radio)', price: 25.00 },
            { id: 9, name: 'Détecteur volumétrique caméra (radio)', price: 25.00 },
            { id: 10, name: 'Détecteur d\'ouverture (radio)', price: 25.00 },
            { id: 11, name: 'Détecteur de choc (radio)', price: 25.00 },
            { id: 12, name: 'Détecteur de bris de verre (radio)', price: 25.00 },
            { id: 13, name: 'Détecteur de fumée (radio)', price: 120.00 },
            { id: 14, name: 'Détecteur de mouvement extérieur (caméra)', price: 25.00 },
            { id: 15, name: 'Détecteur de rideau intérieur (radio)', price: 25.00 },
            { id: 16, name: 'Interphonie (radio sur secteur)', price: 120.00 },
            { id: 17, name: 'Sonde innondation (radio)', price: 25.00 },
            { id: 18, name: 'Sirène déportée (radio)', price: 35.00 },
            { id: 19, name: 'Télécommande (radio)', price: 120.00 }
        ];
        
        catalog['alarm-installation'] = [
            { id: 20, name: 'Installation, paramétrages, tests, mise en service & formation des utilisateurs', price: 0 }
        ];
        
        catalog['alarm-admin'] = [
            { id: 21, name: 'Carte SIM + activation', price: 50.00 },
            { id: 22, name: 'Frais de dossier', price: 190.00 }
        ];
        
        catalog['camera-material'] = [
            { id: 23, name: 'Bullet Mini', price: 390.00 },
            { id: 24, name: 'Bullet XL Varifocale Night', price: 640.00 },
            { id: 25, name: 'Bullet Zone Alarme', price: 740.00 },
            { id: 26, name: 'Bullet Zoom x23', price: 990.00 },
            { id: 27, name: 'Caméra de comptage', price: 860.00 },
            { id: 28, name: 'Coffret NVR 4P', price: 240.00 },
            { id: 29, name: 'Coffret NVR 8P', price: 360.00 },
            { id: 30, name: 'Disque dur 4 To', price: 270.00 },
            { id: 31, name: 'Dôme Antivandale', price: 390.00 },
            { id: 32, name: 'Dôme Mini Antivandale', price: 390.00 },
            { id: 33, name: 'Dôme Night', price: 540.00 },
            { id: 34, name: 'Dôme Plat Motorisé', price: 390.00 },
            { id: 35, name: 'Dôme XL Varifocale', price: 590.00 },
            { id: 36, name: 'Dôme Zone Alarme', price: 740.00 },
            { id: 37, name: 'HDMI Ext.', price: 190.00 },
            { id: 38, name: 'Modem 4G', price: 290.00 },
            { id: 39, name: 'Moniteur Vidéo 22"', price: 190.00 },
            { id: 40, name: 'Moniteur Vidéo 28" 4K', price: 460.00 },
            { id: 41, name: 'Moniteur Vidéo 32"', price: 490.00 },
            { id: 42, name: 'Onduleur 1000 - 60min', price: 360.00 },
            { id: 43, name: 'Onduleur 1500 - 90min', price: 600.00 },
            { id: 44, name: 'Onduleur 2200 - 120min', price: 830.00 },
            { id: 45, name: 'Onduleur 700 - 30min', price: 240.00 },
            { id: 46, name: 'Reo 4G + P.Solaire', price: 490.00 },
            { id: 47, name: 'Reo 4G motorisé + P.solaire', price: 640.00 },
            { id: 48, name: 'Support Mural Articulé', price: 100.00 },
            { id: 49, name: 'Switch POE', price: 270.00 }
        ];
        
        catalog['camera-installation'] = [
            { id: 50, name: 'Installation, paramétrages, tests, mise en service & formation des utilisateurs - pour 1/2 journée', price: 690.00 }
        ];
        
        catalog['camera-remote'] = [
            { id: 51, name: 'Accès à distance sécurisé sur Modem indépendant', price: 20.00 }
        ];
        
        catalog['camera-maintenance'] = [
            { id: 52, name: 'Assistance hotline, déplacement(s), matériels pièce(s), main d\'œuvre et support téléphonique', price: 0 }
        ];

        function setQuoteType(type) {
            currentQuoteType = type;
            document.querySelectorAll('.quote-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderQuoteSections();
            updateTotals();
        }

        function renderQuoteSections() {
            const container = document.getElementById('quote-sections');
            container.innerHTML = '';

            if (currentQuoteType === 'alarm') {
                renderAlarmSections(container);
            } else {
                renderCameraSections(container);
            }
        }

        function renderAlarmSections(container) {
            // Section Matériel
            const materialSection = createSection('Matériel', 'material', 'alarm-material', true);
            container.appendChild(materialSection);

            // Section Installation et matériel supplémentaire
            const installSection = createSection('Installation et matériel supplémentaire', 'installation', 'alarm-installation', true);
            container.appendChild(installSection);

            // Section Frais de dossier
            const adminSection = createSection('Frais de dossier', 'admin', 'alarm-admin', false);
            const adminContent = adminSection.querySelector('.section-content');
            adminContent.innerHTML = `
                <div class="fixed-items">
                    <div>1 carte SIM + activation = 50 CHF HT</div>
                    <div>1 frais de dossier = 190 CHF HT</div>
                </div>
            `;
            container.appendChild(adminSection);
        }

        function renderCameraSections(container) {
            // Section Matériel
            const materialSection = createSection('Matériel', 'material', 'camera-material', true);
            container.appendChild(materialSection);

            // Section Installation
            const installSection = createSection('Installation', 'installation', 'camera-installation', true);
            container.appendChild(installSection);

            // Section Vision à distance (optionnelle)
            const remoteSection = createSection('Vision à distance (optionnel)', 'remote', 'camera-remote', false);
            const remoteContent = remoteSection.querySelector('.section-content');
            remoteContent.innerHTML = `
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="remote-enabled" onchange="toggleRemoteSection()">
                        Inclure la vision à distance (20 CHF HT/mois)
                    </label>
                </div>
                <div id="remote-products" style="display: none; margin-top: 15px;">
                    <div>Accès à distance sécurisé sur Modem indépendant = 20 CHF HT/mois</div>
                </div>
            `;
            container.appendChild(remoteSection);

            // Section Maintenance et garantie
            const maintenanceSection = createSection('Maintenance et garantie', 'maintenance', 'camera-maintenance', false);
            const maintenanceContent = maintenanceSection.querySelector('.section-content');
            maintenanceContent.innerHTML = `
                <div class="fixed-items">
                    <div>Assistance hotline, déplacement(s), matériels pièce(s), main d'œuvre et support téléphonique - OFFERT</div>
                </div>
            `;
            container.appendChild(maintenanceSection);
        }

        function createSection(title, sectionKey, catalogKey, hasPaymentOptions) {
            const section = document.createElement('div');
            section.className = 'section';
            section.innerHTML = `
                <h2>${title}</h2>
                <div class="section-content">
                    ${catalogKey ? `<button class="add-product-btn" onclick="addProduct('${sectionKey}', '${catalogKey}')">Ajouter un produit</button>` : ''}
                    <div id="${sectionKey}-products"></div>
                    ${hasPaymentOptions ? `
                        <div class="payment-options">
                            <h3>Facilités de paiement :</h3>
                            <label><input type="radio" name="${sectionKey}-payment" value="cash" checked onchange="updateTotals()"> Comptant</label>
                            <label><input type="radio" name="${sectionKey}-payment" value="24" onchange="updateTotals()"> 24 mois</label>
                            <label><input type="radio" name="${sectionKey}-payment" value="36" onchange="updateTotals()"> 36 mois</label>
                            <label><input type="radio" name="${sectionKey}-payment" value="48" onchange="updateTotals()"> 48 mois</label>
                        </div>
                    ` : ''}
                </div>
            `;
            return section;
        }

        function addProduct(sectionKey, catalogKey) {
            const productId = Date.now();
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.id = `product-${productId}`;
            
            const options = catalog[catalogKey].map(product => 
                `<option value="${product.id}" data-price="${product.price}">${product.name} - ${product.price.toFixed(2)} CHF HT</option>`
            ).join('');

            productLine.innerHTML = `
                <select onchange="updateProductPrice(${productId})" id="product-select-${productId}">
                    <option value="">Sélectionner un produit...</option>
                    ${options}
                </select>
                <input type="number" min="1" value="1" placeholder="Qté" id="qty-${productId}" onchange="updateTotals()">
                <input type="text" readonly placeholder="Prix unitaire HT" id="price-${productId}">
                <button class="remove-btn" onclick="removeProduct(${productId}, '${sectionKey}')">Supprimer</button>
            `;

            document.getElementById(`${sectionKey}-products`).appendChild(productLine);
            
            if (!quoteData[currentQuoteType][sectionKey]) {
                quoteData[currentQuoteType][sectionKey] = [];
            }
            quoteData[currentQuoteType][sectionKey].push({ id: productId, productId: null, quantity: 1, price: 0 });
        }

        function updateProductPrice(productLineId) {
            const select = document.getElementById(`product-select-${productLineId}`);
            const priceInput = document.getElementById(`price-${productLineId}`);
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const price = parseFloat(selectedOption.dataset.price);
                priceInput.value = `${price.toFixed(2)} CHF HT`;
                
                // Mettre à jour les données
                for (let section in quoteData[currentQuoteType]) {
                    const items = quoteData[currentQuoteType][section];
                    if (Array.isArray(items)) {
                        const item = items.find(item => item.id === productLineId);
                        if (item) {
                            item.productId = parseInt(selectedOption.value);
                            item.price = price;
                            break;
                        }
                    }
                }
                updateTotals();
            }
        }

        function removeProduct(productId, sectionKey) {
            document.getElementById(`product-${productId}`).remove();
            const items = quoteData[currentQuoteType][sectionKey];
            if (Array.isArray(items)) {
                const index = items.findIndex(item => item.id === productId);
                if (index > -1) {
                    items.splice(index, 1);
                }
            }
            updateTotals();
        }

        function toggleRemoteSection() {
            const checkbox = document.getElementById('remote-enabled');
            const productsDiv = document.getElementById('remote-products');
            quoteData[currentQuoteType].remote.enabled = checkbox.checked;
            productsDiv.style.display = checkbox.checked ? 'block' : 'none';
            updateTotals();
        }

        function getPaymentMultiplier(sectionKey) {
            const selectedPayment = document.querySelector(`input[name="${sectionKey}-payment"]:checked`);
            if (!selectedPayment) return 1;
            
            switch (selectedPayment.value) {
                case '24': return 1.10;
                case '36': return 1.15;
                case '48': return 1.20;
                default: return 1;
            }
        }

        function getPaymentMonths(sectionKey) {
            const selectedPayment = document.querySelector(`input[name="${sectionKey}-payment"]:checked`);
            if (!selectedPayment) return 0;
            
            switch (selectedPayment.value) {
                case '24': return 24;
                case '36': return 36;
                case '48': return 48;
                default: return 0;
            }
        }

        function getQuantity(productId) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            return qtyInput ? parseInt(qtyInput.value) || 1 : 1;
        }

        function updateTotals() {
            const totalsDiv = document.getElementById('totals');
            let html = '';
            let totalHT = 0;
            let monthlyHT = 0;
            let cashOnlyHT = 0;

            if (currentQuoteType === 'alarm') {
                // Matériel
                let materialHT = 0;
                quoteData.alarm.material.forEach(item => {
                    if (item.productId && item.price) {
                        materialHT += item.price * getQuantity(item.id);
                    }
                });
                const materialMultiplier = getPaymentMultiplier('material');
                const materialFinalHT = materialHT * materialMultiplier;
                const materialMonths = getPaymentMonths('material');
                
                // Installation
                let installHT = 0;
                quoteData.alarm.installation.forEach(item => {
                    if (item.productId && item.price) {
                        installHT += item.price * getQuantity(item.id);
                    }
                });
                const installMultiplier = getPaymentMultiplier('installation');
                const installFinalHT = installHT * installMultiplier;
                const installMonths = getPaymentMonths('installation');

                // Frais de dossier (toujours comptant)
                const adminHT = 50 + 190; // SIM + Frais de dossier

                html += `<div class="total-line">Matériel HT: ${materialFinalHT.toFixed(2)} CHF</div>`;
                html += `<div class="total-line">Installation HT: ${installFinalHT.toFixed(2)} CHF</div>`;
                html += `<div class="total-line">Frais de dossier HT: ${adminHT.toFixed(2)} CHF</div>`;

                totalHT = materialFinalHT + installFinalHT + adminHT;
                monthlyHT = materialFinalHT + installFinalHT;
                cashOnlyHT = adminHT;

                // Calcul des mensualités
                if (materialMonths > 0 || installMonths > 0) {
                    let monthlyAmount = 0;
                    if (materialMonths > 0) monthlyAmount += materialFinalHT / materialMonths;
                    if (installMonths > 0) monthlyAmount += installFinalHT / installMonths;
                    
                    html += `<div class="total-line">Mensualités HT: ${monthlyAmount.toFixed(2)} CHF/mois</div>`;
                    html += `<div class="total-line">Montant comptant HT: ${cashOnlyHT.toFixed(2)} CHF</div>`;
                }

            } else { // camera
                // Matériel
                let materialHT = 0;
                quoteData.camera.material.forEach(item => {
                    if (item.productId && item.price) {
                        materialHT += item.price * getQuantity(item.id);
                    }
                });
                const materialMultiplier = getPaymentMultiplier('material');
                const materialFinalHT = materialHT * materialMultiplier;
                const materialMonths = getPaymentMonths('material');

                // Installation
                let installHT = 0;
                quoteData.camera.installation.forEach(item => {
                    if (item.productId && item.price) {
                        installHT += item.price * getQuantity(item.id);
                    }
                });
                const installMultiplier = getPaymentMultiplier('installation');
                const installFinalHT = installHT * installMultiplier;
                const installMonths = getPaymentMonths('installation');

                // Vision à distance
                const remoteHT = quoteData.camera.remote.enabled ? 20 : 0;

                html += `<div class="total-line">Matériel HT: ${materialFinalHT.toFixed(2)} CHF</div>`;
                html += `<div class="total-line">Installation HT: ${installFinalHT.toFixed(2)} CHF</div>`;
                if (remoteHT > 0) {
                    html += `<div class="total-line">Vision à distance HT: ${remoteHT.toFixed(2)} CHF/mois</div>`;
                }
                html += `<div class="total-line">Maintenance et garantie: OFFERT</div>`;

                totalHT = materialFinalHT + installFinalHT;

                // Calcul des mensualités
                if (materialMonths > 0 || installMonths > 0) {
                    let monthlyAmount = 0;
                    if (materialMonths > 0) monthlyAmount += materialFinalHT / materialMonths;
                    if (installMonths > 0) monthlyAmount += installFinalHT / installMonths;
                    
                    html += `<div class="total-line">Mensualités HT: ${monthlyAmount.toFixed(2)} CHF/mois</div>`;
                }
                
                if (remoteHT > 0) {
                    html += `<div class="total-line">Abonnement mensuel HT: ${remoteHT.toFixed(2)} CHF/mois</div>`;
                }
            }

            // Totaux avec TVA
            const tva = totalHT * TVA_RATE;
            const totalTTC = totalHT + tva;

            html += `<div class="total-line">Sous-total HT: ${totalHT.toFixed(2)} CHF</div>`;
            html += `<div class="total-line">TVA (8.1%): ${tva.toFixed(2)} CHF</div>`;
            html += `<div class="total-line grand-total">TOTAL TTC: ${totalTTC.toFixed(2)} CHF</div>`;

            totalsDiv.innerHTML = html;
        }

        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `DEV-${year}${month}${day}-${random}`;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.width;
            let yPosition = 20;

            // En-tête avec coordonnées entreprise et client
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Dialarme', 20, yPosition);
            yPosition += 7;
            doc.setFont(undefined, 'normal');
            doc.text('Rue Blavignac 10', 20, yPosition);
            yPosition += 7;
            doc.text('1227 Carouge', 20, yPosition);

            // Coordonnées client (côté droit)
            const clientName = document.getElementById('clientName').value;
            const clientFirstName = document.getElementById('clientFirstName').value;
            const clientCompany = document.getElementById('clientCompany').value;
            const clientAddress = document.getElementById('clientAddress').value;

            let clientY = 20;
            if (clientName || clientFirstName) {
                doc.text(`${clientFirstName} ${clientName}`, pageWidth - 20, clientY, { align: 'right' });
                clientY += 7;
            }
            if (clientCompany) {
                doc.text(clientCompany, pageWidth - 20, clientY, { align: 'right' });
                clientY += 7;
            }
            if (clientAddress) {
                const addressLines = clientAddress.split('\n');
                addressLines.forEach(line => {
                    doc.text(line, pageWidth - 20, clientY, { align: 'right' });
                    clientY += 7;
                });
            }

            yPosition = Math.max(yPosition, clientY) + 20;

            // Titre et numéro de devis
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Proposition commerciale', pageWidth/2, yPosition, { align: 'center' });
            yPosition += 15;

            doc.setFontSize(12);
            const quoteNumber = generateQuoteNumber();
            doc.text(`N° de devis: ${quoteNumber}`, pageWidth/2, yPosition, { align: 'center' });
            yPosition += 20;

            // Conseiller
            const advisor = document.getElementById('advisor').value;
            if (advisor) {
                doc.setFont(undefined, 'normal');
                doc.text(`Devis proposé par votre conseiller : ${advisor}`, 20, yPosition);
                yPosition += 15;
            }

            // Sections avec tableaux
            if (currentQuoteType === 'alarm') {
                yPosition = addAlarmSectionsToPDF(doc, yPosition);
            } else {
                yPosition = addCameraSectionsToPDF(doc, yPosition);
            }

            // Totaux
            yPosition = addTotalsToPDF(doc, yPosition);

            // Date
            yPosition += 15;
            const today = new Date().toLocaleDateString('fr-FR');
            doc.text(`Date: ${today}`, 20, yPosition);

            // Sauvegarde
            const fileName = `Devis_${currentQuoteType}_${clientName || 'Client'}_${today.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }

        function addTableToPDF(doc, yPosition, title, items, sectionKey) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(title, 20, yPosition);
            yPosition += 10;

            if (items.length === 0) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Aucun produit sélectionné', 20, yPosition);
                return yPosition + 10;
            }

            // En-têtes du tableau
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Qté', 20, yPosition);
            doc.text('Produit', 40, yPosition);
            doc.text('Prix Unit. HT', 130, yPosition);
            doc.text('Total HT', 170, yPosition);
            yPosition += 7;

            // Ligne de séparation
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 5;

            // Données du tableau
            doc.setFont(undefined, 'normal');
            let sectionTotal = 0;

            items.forEach(item => {
                if (item.productId && item.price) {
                    const product = findProductById(item.productId);
                    if (product) {
                        const quantity = getQuantity(item.id);
                        const unitPrice = item.price;
                        const lineTotal = unitPrice * quantity;
                        sectionTotal += lineTotal;

                        doc.text(quantity.toString(), 20, yPosition);
                        
                        // Nom du produit (avec gestion du texte long)
                        const productName = doc.splitTextToSize(product.name, 85);
                        doc.text(productName, 40, yPosition);
                        
                        doc.text(`${unitPrice.toFixed(2)} CHF`, 130, yPosition);
                        doc.text(`${lineTotal.toFixed(2)} CHF`, 170, yPosition);
                        yPosition += Math.max(7, productName.length * 7);
                    }
                }
            });

            // Facilité de paiement
            const multiplier = getPaymentMultiplier(sectionKey);
            if (multiplier > 1) {
                const finalTotal = sectionTotal * multiplier;
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 5;
                doc.setFont(undefined, 'bold');
                doc.text(`Sous-total avec facilité: ${finalTotal.toFixed(2)} CHF`, 130, yPosition);
                yPosition += 7;
            }

            return yPosition + 10;
        }

        function addAlarmSectionsToPDF(doc, yPosition) {
            // Matériel
            yPosition = addTableToPDF(doc, yPosition, 'MATÉRIEL', quoteData.alarm.material, 'material');
            
            // Installation
            yPosition = addTableToPDF(doc, yPosition, 'INSTALLATION ET MATÉRIEL SUPPLÉMENTAIRE', quoteData.alarm.installation, 'installation');
            
            // Frais de dossier
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('FRAIS DE DOSSIER', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Qté', 20, yPosition);
            doc.text('Produit', 40, yPosition);
            doc.text('Prix Unit. HT', 130, yPosition);
            doc.text('Total HT', 170, yPosition);
            yPosition += 7;

            doc.line(20, yPosition, 190, yPosition);
            yPosition += 5;

            doc.setFont(undefined, 'normal');
            doc.text('1', 20, yPosition);
            doc.text('Carte SIM + activation', 40, yPosition);
            doc.text('50.00 CHF', 130, yPosition);
            doc.text('50.00 CHF', 170, yPosition);
            yPosition += 7;

            doc.text('1', 20, yPosition);
            doc.text('Frais de dossier', 40, yPosition);
            doc.text('190.00 CHF', 130, yPosition);
            doc.text('190.00 CHF', 170, yPosition);
            yPosition += 15;

            return yPosition;
        }

        function addCameraSectionsToPDF(doc, yPosition) {
            // Matériel
            yPosition = addTableToPDF(doc, yPosition, 'MATÉRIEL', quoteData.camera.material, 'material');
            
            // Installation
            yPosition = addTableToPDF(doc, yPosition, 'INSTALLATION', quoteData.camera.installation, 'installation');
            
            // Vision à distance
            if (quoteData.camera.remote.enabled) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('VISION À DISTANCE', 20, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Qté', 20, yPosition);
                doc.text('Produit', 40, yPosition);
                doc.text('Prix Unit. HT', 130, yPosition);
                doc.text('Total HT', 170, yPosition);
                yPosition += 7;

                doc.line(20, yPosition, 190, yPosition);
                yPosition += 5;

                doc.setFont(undefined, 'normal');
                doc.text('1', 20, yPosition);
                doc.text('Accès à distance sécurisé sur Modem indépendant', 40, yPosition);
                doc.text('20.00 CHF/mois', 130, yPosition);
                doc.text('20.00 CHF/mois', 170, yPosition);
                yPosition += 15;
            }
            
            // Maintenance
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('MAINTENANCE ET GARANTIE', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Assistance hotline, déplacement(s), matériels pièce(s), main d\'œuvre et support téléphonique - OFFERT', 20, yPosition);
            yPosition += 15;

            return yPosition;
        }

        function addTotalsToPDF(doc, yPosition) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAUX', 20, yPosition);
            yPosition += 10;

            const totalsText = document.getElementById('totals').innerText;
            const totalLines = totalsText.split('\n').filter(line => line.trim());
            
            doc.setFontSize(12);
            totalLines.forEach(line => {
                if (line.includes('TOTAL TTC')) {
                    doc.setFont(undefined, 'bold');
                } else {
                    doc.setFont(undefined, 'normal');
                }
                doc.text(line, 20, yPosition);
                yPosition += 7;
            });

            return yPosition;
        }

        function findProductById(productId) {
            for (let catalogKey in catalog) {
                const product = catalog[catalogKey].find(p => p.id === productId);
                if (product) return product;
            }
            return null;
        }

        // Initialisation
        renderQuoteSections();
        updateTotals();
    </script>
</body>
</html>
