<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Devis Dialarme</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .header {
            background: linear-gradient(135deg, #f4e600 0%, #e6d200 100%);
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #333;
            position: relative;
        }

        .catalog-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(51, 51, 51, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .catalog-btn:hover {
            background: rgba(51, 51, 51, 1);
            transform: translateY(-2px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            width: 60px;
            height: 60px;
            background: #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .company-info h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .company-info p {
            opacity: 0.8;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            padding: 20px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .nav-tab.active {
            color: #f4e600;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #f4e600;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #f4e600;
            box-shadow: 0 0 0 3px rgba(244, 230, 0, 0.1);
        }

        .quote-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .quote-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .add-product-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-product-btn:hover {
            background: #218838;
        }

        .product-line {
            display: grid;
            grid-template-columns: 3fr 1fr auto 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .product-line:last-child {
            border-bottom: none;
        }

        .product-select {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            width: 100%;
        }

        .quantity-input {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            width: 80px;
        }

        .discount-input {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            width: 100px;
        }

        .price-display {
            font-weight: bold;
            text-align: right;
            padding: 8px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .discount-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .discount-section select, .discount-section input {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .payment-option {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            font-size: 14px;
        }

        .payment-option:hover {
            border-color: #f4e600;
        }

        .payment-option.active {
            border-color: #f4e600;
            background: #fffbf0;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .quote-summary {
            background: #000000;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .quote-summary h3 {
            margin-bottom: 20px;
            font-size: 22px;
            color: white;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .monthly-payment {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f4e600 0%, #e6d200 100%);
            color: #333;
            box-shadow: 0 5px 15px rgba(244, 230, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 230, 0, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .free-label {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .rental-option {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .rental-option label {
            font-weight: bold;
            color: #856404;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #f4e600;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .rental-toggle-container {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .service-select {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            width: 200px;
        }

        .catalog-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            overflow-y: auto;
        }

        .catalog-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .catalog-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .catalog-header {
            background: #333;
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .catalog-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-catalog {
            background: transparent;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-catalog:hover {
            background: rgba(255,255,255,0.1);
        }

        .catalog-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .catalog-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .catalog-tab:hover {
            background: #e9ecef;
        }

        .catalog-tab.active {
            color: #f4e600;
            background: white;
        }

        .catalog-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #f4e600;
        }

        .catalog-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .catalog-section {
            display: none;
        }

        .catalog-section.active {
            display: block;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .product-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 13px;
        }

        .product-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .product-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }

        .product-table input:focus {
            outline: none;
            border-color: #f4e600;
        }

        .product-table .actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .icon-btn:hover {
            background: #f8f9fa;
        }

        .icon-btn.delete {
            color: #dc3545;
        }

        .icon-btn.delete:hover {
            background: #ffe6e6;
        }

        .add-product-row {
            margin-top: 15px;
        }

        .catalog-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .catalog-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-reset:hover {
            background: #5a6268;
        }

        .commercial-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .commercial-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .commercial-item input {
            flex: 1;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .checkbox-field {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-field input[type="checkbox"] {
            width: auto;
        }

        .centrale-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .centrale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .centrale-header h4 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .centrale-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .kit-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .kit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kit-header h5 {
            margin: 0;
            font-size: 16px;
            color: #495057;
        }

        .kit-product-line {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .kit-product-line select,
        .kit-product-line input {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }

        .btn-add:hover {
            background: #218838;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .payment-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            .product-line {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="catalog-btn" onclick="openCatalogModal()">
                ⚙️ Catalogue
            </button>
            <div class="logo">
                <div class="logo-img">D</div>
                <div class="company-info">
                    <h1>Dialarme</h1>
                    <p>Générateur de devis professionnel</p>
                </div>
            </div>
            <div>
                <span id="currentDate"></span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('alarm', this)">
                🚨 Alarme
            </button>
            <button class="nav-tab" onclick="showTab('camera', this)">
                📹 Caméra de surveillance
            </button>
            <button class="nav-tab" onclick="showTab('fog', this)">
                💨 Générateur de brouillard
            </button>
        </div>

        <!-- Tab Alarm -->
        <div id="alarm-tab" class="tab-content active">
            <div class="rental-toggle-container">
                <span>Mode vente</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="alarm-rental-mode" onchange="toggleRentalMode('alarm')">
                    <span class="toggle-slider"></span>
                </label>
                <span>Location</span>
            </div>

            <div class="form-section">
                <h3>📋 Informations Client</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Nom du client</label>
                        <input type="text" id="clientName" placeholder="Nom complet du client">
                    </div>
                    <div class="form-group">
                        <label for="commercial">Commercial</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <select id="commercial" onchange="handleCommercialSelection(this)" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                <option value="">Sélectionner un commercial</option>
                                <option value="Alikhan Guisseinov">Alikhan Guisseinov</option>
                                <option value="Arnaud Bloch">Arnaud Bloch</option>
                                <option value="Benali Kodad">Benali Kodad</option>
                                <option value="Bryan Debrosse">Bryan Debrosse</option>
                                <option value="Cédric Boldron">Cédric Boldron</option>
                                <option value="Emin Comert">Emin Comert</option>
                                <option value="Gérald Clausen">Gérald Clausen</option>
                                <option value="Heythem Ziaya">Heythem Ziaya</option>
                                <option value="Iyed Baccouche">Iyed Baccouche</option>
                                <option value="Matys Goiot">Matys Goiot</option>
                                <option value="Mohamed Tartik">Mohamed Tartik</option>
                                <option value="Nassim Jaza">Nassim Jaza</option>
                                <option value="Nora Sassi">Nora Sassi</option>
                                <option value="Rodolphe De Vito">Rodolphe De Vito</option>
                                <option value="Sabine Balducci">Sabine Balducci</option>
                                <option value="Samir Ouhameni">Samir Ouhameni</option>
                                <option value="Thilan Curt">Thilan Curt</option>
                                <option value="Thomas Garcia">Thomas Garcia</option>
                                <option value="Wassim Tahiri">Wassim Tahiri</option>
                                <option value="autre" style="font-style: italic; color: #007bff;">➕ Autre (saisir le nom)</option>
                            </select>
                            <input type="text" id="commercial-custom" placeholder="Entrez le nom du commercial" style="display: none; padding: 12px 15px; border: 2px solid #007bff; border-radius: 8px; font-size: 14px; background: #f0f8ff;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 1: Kit de base -->
            <div class="quote-section">
                <h3>🛡️ 1. Kit de base <button class="add-product-btn" onclick="showKitSelector()">+</button></h3>
                <div id="alarm-material-products">
                    <!-- Kit will be added here -->
                </div>
                <div class="discount-section">
                    <label>Réduction:</label>
                    <select id="alarm-material-discount-type">
                        <option value="percent">%</option>
                        <option value="amount">CHF</option>
                    </select>
                    <input type="number" id="alarm-material-discount-value" placeholder="0" min="0" class="discount-input" oninput="updateTotals()">
                </div>
            </div>

            <!-- Section 2: Installation et matériel supplémentaire -->
            <div class="quote-section">
                <h3>🔧 2. Installation et matériel supplémentaire <button class="add-product-btn" onclick="addProductLine('alarm-installation')">+</button></h3>
                <div class="product-line" style="background: #f0f8ff;">
                    <div>Installation, paramétrages, tests, mise en service & formation</div>
                    <div>
                        <label style="margin-right: 5px; font-size: 12px;">Nombre:</label>
                        <input type="number" id="alarm-installation-qty" value="1" min="1" max="10" class="quantity-input" oninput="updateAlarmInstallationPrice()">
                    </div>
                    <input type="number" id="alarm-installation-price" value="690" class="discount-input" placeholder="Prix" readonly style="background: #f0f0f0;">
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="alarm-installation-offered" class="offered-checkbox" onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display" id="alarm-installation-display">690.00 CHF</div>
                </div>
                <div id="alarm-installation-products">
                    <!-- Products will be added here -->
                </div>
                <div class="discount-section">
                    <label>Réduction:</label>
                    <select id="alarm-installation-discount-type">
                        <option value="percent">%</option>
                        <option value="amount">CHF</option>
                    </select>
                    <input type="number" id="alarm-installation-discount-value" placeholder="0" min="0" class="discount-input" oninput="updateTotals()">
                </div>
            </div>

            <!-- Section 3: Frais de dossier -->
            <div class="quote-section">
                <h3>📄 3. Frais de dossier</h3>
                <div class="product-line">
                    <div>Carte SIM + Activation</div>
                    <input type="number" value="1" class="quantity-input" readonly>
                    <div></div>
                    <div class="price-display">50.00 CHF HT</div>
                    <div></div>
                </div>
                <div class="product-line">
                    <div>Frais de dossier</div>
                    <input type="number" value="1" class="quantity-input" readonly>
                    <div></div>
                    <div class="price-display">190.00 CHF HT</div>
                    <div></div>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">* Les frais de dossier se payent à l'installation</p>
            </div>

            <!-- Section 4: Services -->
            <div class="quote-section">
                <h3>🔧 4. Services</h3>
                <div class="product-line">
                    <div>Test Cyclique</div>
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="test-cyclique-selected" checked onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">Inclure</label>
                    </div>
                    <input type="number" id="test-cyclique-price" value="0" class="discount-input" placeholder="Prix" oninput="updateTotals()">
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="test-cyclique-offered" class="offered-checkbox" checked onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display" id="test-cyclique-total">OFFERT</div>
                </div>
                <div class="product-line">
                    <div>Service de surveillance</div>
                    <div>
                        <select id="surveillance-type" class="service-select" onchange="updateSurveillancePrice()">
                            <option value="">Aucun</option>
                            <option value="telesurveillance">Télésurveillance Particulier</option>
                            <option value="telesurveillance-pro">Télésurveillance Professionnel</option>
                            <option value="autosurveillance">Autosurveillance</option>
                        </select>
                    </div>
                    <input type="number" id="surveillance-price" value="0" class="discount-input" placeholder="Prix/mois" oninput="updateTotals()">
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="surveillance-offered" class="offered-checkbox" onchange="updateTotals()" disabled>
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display" id="surveillance-total">0.00 CHF/mois</div>
                </div>
            </div>

            <!-- Section 5: Mode de paiement -->
            <div class="quote-section" id="alarm-payment-section">
                <h3>💳 5. Mode de paiement</h3>
                <div class="payment-options" id="alarm-global-payment">
                    <div class="payment-option" data-months="0" onclick="selectGlobalPayment(this, 'alarm')">Comptant</div>
                    <div class="payment-option" data-months="24" onclick="selectGlobalPayment(this, 'alarm')">24 mois</div>
                    <div class="payment-option" data-months="36" onclick="selectGlobalPayment(this, 'alarm')">36 mois</div>
                    <div class="payment-option active" data-months="48" onclick="selectGlobalPayment(this, 'alarm')">48 mois</div>
                </div>
            </div>

            <div class="quote-summary">
                <h3>📊 Récapitulatif du devis</h3>
                <div class="summary-item">
                    <span>Matériel</span>
                    <span id="alarm-material-total">0.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>Installation</span>
                    <span id="alarm-installation-total">690.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>Frais de dossier</span>
                    <span>240.00 CHF HT</span>
                </div>
                <div class="summary-item">
                    <span>Service de surveillance</span>
                    <span id="surveillance-summary">0.00 CHF/mois</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL HT (hors surveillance)</span>
                    <span id="alarm-total-ht">930.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL TTC (hors surveillance)</span>
                    <span id="alarm-total-ttc">1004.40 CHF</span>
                </div>
                <div class="monthly-payment" id="alarm-monthly-payment" style="display: none;">
                    <strong>Mensualités globales: <span id="alarm-monthly-amount">0 CHF</span>/mois pendant <span id="alarm-monthly-count">0</span> mois</strong>
                </div>
                <div class="monthly-payment" id="alarm-cash-payment" style="display: none;">
                    <strong>Montant comptant: <span id="alarm-cash-amount">0 CHF</span></strong>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generatePDF('alarm')">
                    📄 Générer le PDF
                </button>
                <button class="btn btn-secondary" onclick="exportQuote()">
                    💾 Exporter
                </button>
            </div>
        </div>

        <!-- Tab Camera -->
        <div id="camera-tab" class="tab-content">
            <div class="rental-toggle-container">
                <span>Mode vente</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="camera-rental-mode" onchange="toggleRentalMode('camera')">
                    <span class="toggle-slider"></span>
                </label>
                <span>Location</span>
            </div>

            <div class="form-section">
                <h3>📋 Informations Client</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientNameCamera">Nom du client</label>
                        <input type="text" id="clientNameCamera" placeholder="Nom complet du client">
                    </div>
                    <div class="form-group">
                        <label for="commercialCamera">Commercial</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <select id="commercialCamera" onchange="handleCommercialSelectionCamera(this)" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                <option value="">Sélectionner un commercial</option>
                                <option value="Alikhan Guisseinov">Alikhan Guisseinov</option>
                                <option value="Arnaud Bloch">Arnaud Bloch</option>
                                <option value="Benali Kodad">Benali Kodad</option>
                                <option value="Bryan Debrosse">Bryan Debrosse</option>
                                <option value="Cédric Boldron">Cédric Boldron</option>
                                <option value="Emin Comert">Emin Comert</option>
                                <option value="Gérald Clausen">Gérald Clausen</option>
                                <option value="Heythem Ziaya">Heythem Ziaya</option>
                                <option value="Iyed Baccouche">Iyed Baccouche</option>
                                <option value="Matys Goiot">Matys Goiot</option>
                                <option value="Mohamed Tartik">Mohamed Tartik</option>
                                <option value="Nassim Jaza">Nassim Jaza</option>
                                <option value="Nora Sassi">Nora Sassi</option>
                                <option value="Rodolphe De Vito">Rodolphe De Vito</option>
                                <option value="Sabine Balducci">Sabine Balducci</option>
                                <option value="Samir Ouhameni">Samir Ouhameni</option>
                                <option value="Thilan Curt">Thilan Curt</option>
                                <option value="Thomas Garcia">Thomas Garcia</option>
                                <option value="Wassim Tahiri">Wassim Tahiri</option>
                                <option value="autre" style="font-style: italic; color: #007bff;">➕ Autre (saisir le nom)</option>
                            </select>
                            <input type="text" id="commercialCamera-custom" placeholder="Entrez le nom du commercial" style="display: none; padding: 12px 15px; border: 2px solid #007bff; border-radius: 8px; font-size: 14px; background: #f0f8ff;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 1: Matériel -->
            <div class="quote-section">
                <h3>📹 1. Matériel <button class="add-product-btn" onclick="addProductLine('camera-material')">+</button></h3>
                <div id="camera-material-products">
                    <!-- Products will be added here -->
                </div>
                <div class="discount-section">
                    <label>Réduction:</label>
                    <select id="camera-material-discount-type">
                        <option value="percent">%</option>
                        <option value="amount">CHF</option>
                    </select>
                    <input type="number" id="camera-material-discount-value" placeholder="0" min="0" class="discount-input" oninput="updateTotals()">
                </div>
            </div>

            <!-- Section 2: Installation -->
            <div class="quote-section">
                <h3>🔧 2. Installation</h3>
                <div class="product-line">
                    <div>Installation, paramétrages, tests, mise en service & formation des utilisateurs</div>
                    <div>
                        <label style="margin-right: 5px;">Nombre:</label>
                        <input type="number" id="camera-installation-qty" value="1" min="1" max="10" class="quantity-input" oninput="updateCameraInstallationPrice()">
                    </div>
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="camera-installation-offered" class="offered-checkbox" onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display" id="camera-installation-price">690.00 CHF</div>
                    <div></div>
                </div>
            </div>

            <!-- Section 3: Vision à distance -->
            <div class="quote-section" id="camera-remote-section">
                <h3>🌐 3. Vision à distance</h3>
                <div class="checkbox-option">
                    <input type="checkbox" id="camera-remote-access" onchange="updateTotals()">
                    <label for="camera-remote-access">Accès à distance sécurisé sur Modem indépendant - 20 CHF/mois</label>
                </div>
            </div>

            <!-- Section 4: Maintenance et garantie -->
            <div class="quote-section" id="camera-maintenance-section">
                <h3>🔧 4. Maintenance et garantie</h3>
                <div class="product-line">
                    <div>Assistance hotline, déplacement(s), matériels pièce(s), main d'œuvre et support téléphonique</div>
                    <input type="number" value="1" class="quantity-input" readonly>
                    <div></div>
                    <div class="price-display"><span class="free-label">OFFERT</span></div>
                    <div></div>
                </div>
            </div>

            <!-- Section 5: Mode de paiement -->
            <div class="quote-section" id="camera-payment-section">
                <h3>💳 5. Mode de paiement</h3>
                <div class="payment-options" id="camera-global-payment">
                    <div class="payment-option" data-months="0" onclick="selectGlobalPayment(this, 'camera')">Comptant</div>
                    <div class="payment-option" data-months="24" onclick="selectGlobalPayment(this, 'camera')">24 mois</div>
                    <div class="payment-option" data-months="36" onclick="selectGlobalPayment(this, 'camera')">36 mois</div>
                    <div class="payment-option active" data-months="48" onclick="selectGlobalPayment(this, 'camera')">48 mois</div>
                </div>
            </div>

            <div class="quote-summary">
                <h3>📊 Récapitulatif du devis</h3>
                <div class="summary-item">
                    <span>Matériel</span>
                    <span id="camera-material-total">0.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>Installation</span>
                    <span id="camera-installation-total">690.00 CHF</span>
                </div>
                <div class="summary-item" id="camera-remote-summary">
                    <span>Vision à distance</span>
                    <span id="camera-remote-total">0.00 CHF/mois</span>
                </div>
                <div class="summary-item" id="camera-maintenance-summary">
                    <span>Maintenance</span>
                    <span>OFFERT</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL HT</span>
                    <span id="camera-total-ht">690.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL TTC</span>
                    <span id="camera-total-ttc">745.29 CHF</span>
                </div>
                <div class="monthly-payment" id="camera-monthly-payment" style="display: none;">
                    <strong>Mensualités: <span id="camera-monthly-amount">0 CHF</span> x <span id="camera-monthly-count">0</span> mois</strong>
                    <div id="camera-remote-monthly" style="margin-top: 5px; display: none;">
                        + Vision à distance: <strong>20 CHF/mois</strong>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generatePDF('camera')">
                    📄 Générer le PDF
                </button>
                <button class="btn btn-secondary" onclick="exportQuote()">
                    💾 Exporter
                </button>
            </div>
        </div>

        <!-- Tab Générateur de brouillard -->
        <div id="fog-tab" class="tab-content">
            <div class="rental-toggle-container">
                <span>Mode vente</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="fog-rental-mode" onchange="toggleRentalMode('fog')">
                    <span class="toggle-slider"></span>
                </label>
                <span>Location</span>
            </div>

            <div class="form-section">
                <h3>📋 Informations Client</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientNameFog">Nom du client</label>
                        <input type="text" id="clientNameFog" placeholder="Nom complet du client">
                    </div>
                    <div class="form-group">
                        <label for="commercialFog">Commercial</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <select id="commercialFog" onchange="handleCommercialSelectionFog(this)" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                <option value="">Sélectionner un commercial</option>
                                <option value="Alikhan Guisseinov">Alikhan Guisseinov</option>
                                <option value="Arnaud Bloch">Arnaud Bloch</option>
                                <option value="Benali Kodad">Benali Kodad</option>
                                <option value="Bryan Debrosse">Bryan Debrosse</option>
                                <option value="Cédric Boldron">Cédric Boldron</option>
                                <option value="Emin Comert">Emin Comert</option>
                                <option value="Gérald Clausen">Gérald Clausen</option>
                                <option value="Heythem Ziaya">Heythem Ziaya</option>
                                <option value="Iyed Baccouche">Iyed Baccouche</option>
                                <option value="Matys Goiot">Matys Goiot</option>
                                <option value="Mohamed Tartik">Mohamed Tartik</option>
                                <option value="Nassim Jaza">Nassim Jaza</option>
                                <option value="Nora Sassi">Nora Sassi</option>
                                <option value="Rodolphe De Vito">Rodolphe De Vito</option>
                                <option value="Sabine Balducci">Sabine Balducci</option>
                                <option value="Samir Ouhameni">Samir Ouhameni</option>
                                <option value="Thilan Curt">Thilan Curt</option>
                                <option value="Thomas Garcia">Thomas Garcia</option>
                                <option value="Wassim Tahiri">Wassim Tahiri</option>
                                <option value="autre" style="font-style: italic; color: #007bff;">➕ Autre (saisir le nom)</option>
                            </select>
                            <input type="text" id="commercialFog-custom" placeholder="Entrez le nom du commercial" style="display: none; padding: 12px 15px; border: 2px solid #007bff; border-radius: 8px; font-size: 14px; background: #f0f8ff;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 1: Matériel -->
            <div class="quote-section">
                <h3>💨 1. Matériel <button class="add-product-btn" onclick="addProductLine('fog-material')">+</button></h3>
                <div id="fog-material-products">
                    <!-- Products will be added here -->
                </div>
                <div class="discount-section">
                    <label>Réduction:</label>
                    <select id="fog-material-discount-type">
                        <option value="percent">%</option>
                        <option value="amount">CHF</option>
                    </select>
                    <input type="number" id="fog-material-discount-value" placeholder="0" min="0" class="discount-input" oninput="updateTotals()">
                </div>
            </div>

            <!-- Section 2: Installation -->
            <div class="quote-section">
                <h3>🔧 2. Installation</h3>
                <div class="product-line">
                    <div>Installation, paramétrages, tests, mise en service & formation</div>
                    <div>
                        <input type="number" value="1" class="quantity-input" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" id="fog-installation-offered" class="offered-checkbox" onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display" id="fog-installation-price">490.00 CHF</div>
                    <div></div>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">* Installation uniquement au comptant (pas de mensualités)</p>
            </div>

            <!-- Section 3: Maintenance et garantie -->
            <div class="quote-section" id="fog-maintenance-section">
                <h3>🔧 3. Maintenance et garantie</h3>
                <div class="product-line">
                    <div>Assistance hotline, déplacement(s), matériels pièce(s), main d'œuvre et support téléphonique</div>
                    <input type="number" value="1" class="quantity-input" readonly>
                    <div></div>
                    <div class="price-display"><span class="free-label">OFFERT</span></div>
                    <div></div>
                </div>
            </div>

            <!-- Section 4: Mode de paiement -->
            <div class="quote-section" id="fog-payment-section">
                <h3>💳 4. Mode de paiement</h3>
                <div class="payment-options" id="fog-global-payment">
                    <div class="payment-option" data-months="0" onclick="selectGlobalPayment(this, 'fog')">Comptant</div>
                    <div class="payment-option" data-months="24" onclick="selectGlobalPayment(this, 'fog')">24 mois</div>
                    <div class="payment-option" data-months="36" onclick="selectGlobalPayment(this, 'fog')">36 mois</div>
                    <div class="payment-option active" data-months="48" onclick="selectGlobalPayment(this, 'fog')">48 mois</div>
                </div>
            </div>

            <div class="quote-summary">
                <h3>📊 Récapitulatif du devis</h3>
                <div class="summary-item">
                    <span>Matériel</span>
                    <span id="fog-material-total">0.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>Installation</span>
                    <span id="fog-installation-total">690.00 CHF</span>
                </div>
                <div class="summary-item" id="fog-maintenance-summary">
                    <span>Maintenance</span>
                    <span>OFFERT</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL HT</span>
                    <span id="fog-total-ht">690.00 CHF</span>
                </div>
                <div class="summary-item">
                    <span>TOTAL TTC</span>
                    <span id="fog-total-ttc">745.29 CHF</span>
                </div>
                <div class="monthly-payment" id="fog-monthly-payment" style="display: none;">
                    <strong>Mensualités: <span id="fog-monthly-amount">0 CHF</span> x <span id="fog-monthly-count">0</span> mois</strong>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generatePDF('fog')">
                    📄 Générer le PDF
                </button>
                <button class="btn btn-secondary" onclick="exportQuote()">
                    💾 Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Catalog Management Modal -->
    <div id="catalogModal" class="catalog-modal">
        <div class="catalog-content">
            <div class="catalog-header">
                <h2>📦 Gestion du Catalogue</h2>
                <button class="close-catalog" onclick="closeCatalogModal()">×</button>
            </div>

            <div class="catalog-tabs">
                <button class="catalog-tab active" onclick="showCatalogTab('centrales-catalog')">Centrales & Kits</button>
                <button class="catalog-tab" onclick="showCatalogTab('alarm-catalog')">Alarmes</button>
                <button class="catalog-tab" onclick="showCatalogTab('camera-catalog')">Caméras</button>
                <button class="catalog-tab" onclick="showCatalogTab('fog-catalog')">Brouillard</button>
                <button class="catalog-tab" onclick="showCatalogTab('commercial-catalog')">Commerciaux</button>
            </div>

            <div class="catalog-body">
                <!-- Centrales & Kits -->
                <div id="centrales-catalog" class="catalog-section active">
                    <h3>Centrales d'alarme et kits de base</h3>
                    <div id="centrales-container">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="addNewCentrale()">+ Ajouter une centrale</button>
                </div>

                <!-- Alarm Products -->
                <div id="alarm-catalog" class="catalog-section active">
                    <h3>🔵 Produits Alarmes - Centrale Titane</h3>
                    <table class="product-table" id="alarm-titane-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">Nom du produit</th>
                                <th style="width: 20%">Prix comptant (CHF)</th>
                                <th style="width: 15%">Mensualité</th>
                                <th style="width: 15%">
                                    <div class="checkbox-field">
                                        <span>Comptant uniquement</span>
                                    </div>
                                </th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alarm-titane-body">
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addNewAlarmProduct('titane')" style="margin-bottom: 30px;">+ Ajouter un produit Titane</button>

                    <h3 style="margin-top: 30px;">🟢 Produits Alarmes - Centrale Jablotron</h3>
                    <table class="product-table" id="alarm-jablotron-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">Nom du produit</th>
                                <th style="width: 20%">Prix comptant (CHF)</th>
                                <th style="width: 15%">Mensualité</th>
                                <th style="width: 15%">
                                    <div class="checkbox-field">
                                        <span>Comptant uniquement</span>
                                    </div>
                                </th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alarm-jablotron-body">
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addNewAlarmProduct('jablotron')">+ Ajouter un produit Jablotron</button>
                </div>

                <!-- Camera Products -->
                <div id="camera-catalog" class="catalog-section">
                    <h3>Produits Caméras</h3>
                    <table class="product-table" id="camera-products-table">
                        <thead>
                            <tr>
                                <th style="width: 30%">Nom du produit</th>
                                <th style="width: 12%">Prix comptant (CHF)</th>
                                <th style="width: 10%">Mensualité 48 mois</th>
                                <th style="width: 10%">Mensualité 36 mois</th>
                                <th style="width: 10%">Mensualité 24 mois</th>
                                <th style="width: 15%">
                                    <div class="checkbox-field">
                                        <span>Comptant uniquement</span>
                                    </div>
                                </th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="camera-products-body">
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addNewCameraProduct()">+ Ajouter un produit</button>
                </div>

                <!-- Fog Products -->
                <div id="fog-catalog" class="catalog-section">
                    <h3>Produits Générateur de Brouillard</h3>
                    <table class="product-table" id="fog-products-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">Nom du produit</th>
                                <th style="width: 20%">Prix comptant (CHF)</th>
                                <th style="width: 15%">Mensualité</th>
                                <th style="width: 15%">
                                    <div class="checkbox-field">
                                        <span>Comptant uniquement</span>
                                    </div>
                                </th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fog-products-body">
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addNewFogProduct()">+ Ajouter un produit</button>
                </div>

                <!-- Commerciaux -->
                <div id="commercial-catalog" class="catalog-section">
                    <h3>Liste des Commerciaux</h3>
                    <div class="commercial-list" id="commercial-list">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="addNewCommercial()">+ Ajouter un commercial</button>
                </div>
            </div>

            <div class="catalog-actions">
                <button class="btn-reset" onclick="resetCatalog()">Réinitialiser par défaut</button>
                <button class="btn-save" onclick="saveCatalog()">💾 Enregistrer les modifications</button>
            </div>
        </div>
    </div>

    <script>
        // Générateur de devis Dialarme - Version avec prix mensuels corrigés
        class DialarmeFinalGenerator {
            constructor() {
                this.catalog = {
                    'alarm-material': [
                        { id: 5, name: "Centrale Jablotron", price: 990.00 },
                        { id: 6, name: "Centrale Titane", price: 690.00 },
                        { id: 99, name: "Autre", price: 0.00, isCustom: true },
                        { id: 3, name: "Badge x 4", priceTitane: 100.00, priceJablotron: 200.00, monthlyTitane: 3, monthlyJablotron: 5 },
                        { id: 2, name: "Barrière extérieure 2x12 mètres (radio)", priceTitane: 890.00, priceJablotron: 890.00, monthlyTitane: 22, monthlyJablotron: 22 },
                        { id: 1, name: "Bouton panique/Montre d'urgence (radio)", priceTitane: 190.00, priceJablotron: 190.00, monthlyTitane: 5, monthlyJablotron: 5 },
                        { id: 7, name: "Clavier (radio)", priceTitane: 390.00, priceJablotron: 390.00, monthlyTitane: 10, monthlyJablotron: 12 },
                        { id: 12, name: "Détecteur de bris de verre (radio)", priceTitane: 290.00, priceJablotron: 290.00, monthlyTitane: 7, monthlyJablotron: 7 },
                        { id: 11, name: "Détecteur de choc (radio)", priceTitane: 290.00, priceJablotron: 290.00, monthlyTitane: 7, monthlyJablotron: 7 },
                        { id: 13, name: "Détecteur de fumée (radio)", priceTitane: 190.00, priceJablotron: 290.00, monthlyTitane: 5, monthlyJablotron: 7 },
                        { id: 14, name: "Détecteur de mouvement extérieur (caméra)", priceTitane: 690.00, priceJablotron: 690.00, monthlyTitane: 17, monthlyJablotron: 17 },
                        { id: 10, name: "Détecteur d'ouverture (radio)", priceTitane: 190.00, priceJablotron: 240.00, monthlyTitane: 5, monthlyJablotron: 6 },
                        { id: 8, name: "Détecteur volumétrique (radio)", priceTitane: 240.00, priceJablotron: 290.00, monthlyTitane: 6, monthlyJablotron: 7 },
                        { id: 9, name: "Détecteur volumétrique caméra (radio)", priceTitane: 290.00, priceJablotron: 450.00, monthlyTitane: 7, monthlyJablotron: 11 },
                        { id: 22, name: "Lecteur de badge intérieur (filaire/radio)", priceJablotron: 490.00, requiresJablotron: true, monthlyJablotron: 12 },
                        { id: 18, name: "Sirène déportée petite (radio)", priceTitane: 390.00, priceJablotron: 390.00, monthlyTitane: 10, monthlyJablotron: 10 },
                        { id: 21, name: "Sirène déportée grande (radio)", priceJablotron: 490.00, requiresJablotron: true, monthlyJablotron: 12 },
                        { id: 17, name: "Sonde inondation (radio)", priceTitane: 290.00, priceJablotron: 390.00, monthlyTitane: 7, monthlyJablotron: 10 },
                        { id: 19, name: "Télécommande (radio)", priceTitane: 190.00, priceJablotron: 240.00, monthlyTitane: 5, monthlyJablotron: 6 }
                    ].sort((a, b) => a.name.localeCompare(b.name)),
                    'alarm-installation': [
                        { id: 99, name: "Autre", price: 0.00, isCustom: true },
                        { id: 3, name: "Badge x 4", priceTitane: 100.00, priceJablotron: 200.00, monthlyTitane: 3, monthlyJablotron: 5 },
                        { id: 2, name: "Barrière extérieure 2x12 mètres (radio)", priceTitane: 890.00, priceJablotron: 890.00, monthlyTitane: 22, monthlyJablotron: 22 },
                        { id: 1, name: "Bouton panique/Montre d'urgence (radio)", priceTitane: 190.00, priceJablotron: 190.00, monthlyTitane: 5, monthlyJablotron: 5 },
                        { id: 7, name: "Clavier (radio)", priceTitane: 390.00, priceJablotron: 390.00, monthlyTitane: 10, monthlyJablotron: 12 },
                        { id: 12, name: "Détecteur de bris de verre (radio)", priceTitane: 290.00, priceJablotron: 290.00, monthlyTitane: 7, monthlyJablotron: 7 },
                        { id: 11, name: "Détecteur de choc (radio)", priceTitane: 290.00, priceJablotron: 290.00, monthlyTitane: 7, monthlyJablotron: 7 },
                        { id: 13, name: "Détecteur de fumée (radio)", priceTitane: 190.00, priceJablotron: 290.00, monthlyTitane: 5, monthlyJablotron: 7 },
                        { id: 14, name: "Détecteur de mouvement extérieur (caméra)", priceTitane: 690.00, priceJablotron: 690.00, monthlyTitane: 17, monthlyJablotron: 17 },
                        { id: 10, name: "Détecteur d'ouverture (radio)", priceTitane: 190.00, priceJablotron: 240.00, monthlyTitane: 5, monthlyJablotron: 6 },
                        { id: 8, name: "Détecteur volumétrique (radio)", priceTitane: 240.00, priceJablotron: 290.00, monthlyTitane: 6, monthlyJablotron: 7 },
                        { id: 9, name: "Détecteur volumétrique caméra (radio)", priceTitane: 290.00, priceJablotron: 450.00, monthlyTitane: 7, monthlyJablotron: 11 },
                        { id: 20, name: "Installation, paramétrages, tests, mise en service & formation (1/2 journée)", price: 690.00 },
                        { id: 22, name: "Lecteur de badge intérieur (filaire/radio)", priceJablotron: 490.00, requiresJablotron: true, monthlyJablotron: 12 },
                        { id: 18, name: "Sirène déportée petite (radio)", priceTitane: 390.00, priceJablotron: 390.00, monthlyTitane: 10, monthlyJablotron: 10 },
                        { id: 21, name: "Sirène déportée grande (radio)", priceJablotron: 490.00, requiresJablotron: true, monthlyJablotron: 12 },
                        { id: 17, name: "Sonde inondation (radio)", priceTitane: 290.00, priceJablotron: 390.00, monthlyTitane: 7, monthlyJablotron: 10 },
                        { id: 19, name: "Télécommande (radio)", priceTitane: 190.00, priceJablotron: 240.00, monthlyTitane: 5, monthlyJablotron: 6 }
                    ].sort((a, b) => a.name.localeCompare(b.name)),
                    'camera-material': [
                        { id: 99, name: "Autre", price: 0.00, isCustom: true },
                        { id: 23, name: "Bullet Mini", price: 390.00, monthly48: 10, monthly36: 13, monthly24: 18 },
                        { id: 24, name: "Bullet XL Varifocale Night", price: 640.00, monthly48: 16, monthly36: 21, monthly24: 30 },
                        { id: 25, name: "Bullet Zone Alarme", price: 740.00, monthly48: 19, monthly36: 23, monthly24: 34 },
                        { id: 26, name: "Bullet Zoom x23", price: 990.00, monthly48: 25, monthly36: 32, monthly24: 46 },
                        { id: 27, name: "Caméra de comptage", price: 860.00 },
                        { id: 28, name: "Coffret NVR 4P", price: 240.00 },
                        { id: 29, name: "Coffret NVR 8P", price: 360.00 },
                        { id: 30, name: "Disque dur 4 To", price: 270.00 },
                        { id: 31, name: "Dôme Antivandale", price: 390.00, monthly48: 10, monthly36: 13, monthly24: 18 },
                        { id: 32, name: "Dôme Mini Antivandale", price: 390.00, monthly48: 10, monthly36: 13, monthly24: 18 },
                        { id: 33, name: "Dôme Night", price: 540.00, monthly48: 14, monthly36: 18, monthly24: 25 },
                        { id: 34, name: "Dôme Plat Motorisé", price: 390.00, monthly48: 10, monthly36: 13, monthly24: 18 },
                        { id: 35, name: "Dôme XL Varifocale", price: 590.00, monthly48: 15, monthly36: 19, monthly24: 28 },
                        { id: 36, name: "Dôme Zone Alarme", price: 740.00, monthly48: 19, monthly36: 23, monthly24: 34 },
                        { id: 37, name: "HDMI Ext.", price: 190.00 },
                        { id: 38, name: "Modem 4G", price: 290.00 },
                        { id: 39, name: "Moniteur Vidéo 22\"", price: 190.00 },
                        { id: 40, name: "Moniteur Vidéo 28\" 4K", price: 460.00 },
                        { id: 41, name: "Moniteur Vidéo 32\"", price: 490.00 },
                        { id: 50, name: "NVR 1-4 Caméras (1 mois d'enregistrement)", price: 990.00 },
                        { id: 51, name: "NVR 4-8 Caméras (1 mois d'enregistrement)", price: 1390.00 },
                        { id: 52, name: "NVR 8-16 Caméras (1 mois d'enregistrement)", price: 1690.00 },
                        { id: 42, name: "Onduleur 1000 - 60min", price: 360.00 },
                        { id: 43, name: "Onduleur 1500 - 90min", price: 600.00 },
                        { id: 44, name: "Onduleur 2200 - 120min", price: 830.00 },
                        { id: 45, name: "Onduleur 700 - 30min", price: 240.00 },
                        { id: 46, name: "Reo 4G + P.Solaire", price: 490.00, monthly48: 13, monthly36: 16, monthly24: 23 },
                        { id: 47, name: "Solar 4G + P.solaire", price: 890.00, monthly48: 22, monthly36: 28, monthly24: 41 },
                        { id: 48, name: "Support Mural Articulé", price: 100.00 },
                        { id: 49, name: "Switch POE", price: 270.00 }
                    ].sort((a, b) => a.name.localeCompare(b.name)),
                    'fog-material': [
                        { id: 105, name: "Générateur de brouillard", price: 2990.00 },
                        { id: 103, name: "Cartouche supplémentaire HY3", price: 990.00 },
                        { id: 107, name: "Clavier", price: 390.00, monthly: 9 },
                        { id: 108, name: "Détecteur d'ouverture", price: 190.00, monthly: 5 },
                        { id: 106, name: "Détecteur volumétrique", price: 240.00, monthly: 6 },
                        { id: 102, name: "Remplissage cartouche", price: 390.00 },
                        { id: 100, name: "Support mural articulé", price: 390.00, monthly: 9 },
                        { id: 101, name: "Support mural fixe", price: 290.00, monthly: 7 },
                        { id: 109, name: "Télécommande", price: 240.00, monthly: 6 },
                        { id: 99, name: "Autre", price: 0.00, isCustom: true }
                    ]
                };

                this.currentTab = 'alarm';
                this.sections = {
                    'alarm-material': { paymentMonths: 0 },
                    'alarm-installation': { paymentMonths: 0 },
                    'camera-material': { paymentMonths: 0 },
                    'camera-installation': { paymentMonths: 0 },
                    'fog-material': { paymentMonths: 0 },
                    'fog-installation': { paymentMonths: 0 }
                };

                this.globalPaymentMonths = {
                    'alarm': 48,
                    'camera': 48,
                    'fog': 48
                };

                this.rentalMode = {
                    'alarm': false,
                    'camera': false,
                    'fog': false
                };

                this.selectedCentral = null;
                this.kitOffered = false;

                this.commercialsList = [
                    'Alikhan Guisseinov', 'Arnaud Bloch', 'Benali Kodad', 'Bryan Debrosse',
                    'Cédric Boldron', 'Emin Comert', 'Gérald Clausen', 'Heythem Ziaya',
                    'Iyed Baccouche', 'Matys Goiot', 'Mohamed Tartik', 'Nassim Jaza',
                    'Nora Sassi', 'Rodolphe De Vito', 'Sabine Balducci', 'Samir Ouhameni',
                    'Thilan Curt', 'Thomas Garcia', 'Wassim Tahiri'
                ];

                this.centralesConfig = [
                    {
                        id: 'titane',
                        name: 'Centrale Titane',
                        productId: 6,
                        price: 690,
                        kits: [
                            {
                                name: 'Kit Standard',
                                products: [
                                    { id: 8, quantity: 2 },  // Détecteur volumétrique
                                    { id: 10, quantity: 1 }, // Détecteur d'ouverture
                                    { id: 7, quantity: 1 },  // Clavier
                                    { id: 18, quantity: 1 }  // Sirène petite
                                ]
                            },
                            {
                                name: 'Kit Périmétrique',
                                products: [
                                    { id: 8, quantity: 1 },  // Détecteur volumétrique
                                    { id: 10, quantity: 3 }, // Détecteur d'ouverture
                                    { id: 7, quantity: 1 },  // Clavier
                                    { id: 18, quantity: 1 }  // Sirène petite
                                ]
                            }
                        ]
                    },
                    {
                        id: 'jablotron',
                        name: 'Centrale Jablotron',
                        productId: 5,
                        price: 990,
                        kits: [
                            {
                                name: 'Kit Standard',
                                products: [
                                    { id: 8, quantity: 2 },
                                    { id: 10, quantity: 1 },
                                    { id: 7, quantity: 1 },
                                    { id: 18, quantity: 1 }
                                ]
                            },
                            {
                                name: 'Kit Périmétrique',
                                products: [
                                    { id: 8, quantity: 1 },
                                    { id: 10, quantity: 3 },
                                    { id: 7, quantity: 1 },
                                    { id: 18, quantity: 1 }
                                ]
                            }
                        ]
                    }
                ];

                this.loadCatalogFromStorage();
                this.init();
            }

            init() {
                this.updateCurrentDate();
                this.updateTotals();
                console.log('Générateur Dialarme initialisé');
            }

            roundToFiveCents(amount) {
                return Math.ceil(amount * 20) / 20;
            }

            loadCatalogFromStorage() {
                const savedCatalog = localStorage.getItem('dialarme_catalog');
                const savedCommercials = localStorage.getItem('dialarme_commercials');
                const savedCentrales = localStorage.getItem('dialarme_centrales');
                
                if (savedCatalog) {
                    try {
                        this.catalog = JSON.parse(savedCatalog);
                    } catch (e) {
                        console.error('Erreur lors du chargement du catalogue', e);
                    }
                }
                
                if (savedCommercials) {
                    try {
                        this.commercialsList = JSON.parse(savedCommercials);
                    } catch (e) {
                        console.error('Erreur lors du chargement des commerciaux', e);
                    }
                }
                
                if (savedCentrales) {
                    try {
                        this.centralesConfig = JSON.parse(savedCentrales);
                    } catch (e) {
                        console.error('Erreur lors du chargement des centrales', e);
                    }
                }
            }

            saveCatalogToStorage() {
                localStorage.setItem('dialarme_catalog', JSON.stringify(this.catalog));
                localStorage.setItem('dialarme_commercials', JSON.stringify(this.commercialsList));
                localStorage.setItem('dialarme_centrales', JSON.stringify(this.centralesConfig));
            }

            renderCatalogModal() {
                this.renderCentrales();
                this.renderAlarmProducts();
                this.renderCameraProducts();
                this.renderFogProducts();
                this.renderCommercials();
            }

            renderCentrales() {
                const container = document.getElementById('centrales-container');
                container.innerHTML = '';
                
                this.centralesConfig.forEach((centrale, centraleIndex) => {
                    const card = document.createElement('div');
                    card.className = 'centrale-card';
                    card.innerHTML = `
                        <div class="centrale-header">
                            <h4>${centrale.name}</h4>
                            <button class="icon-btn delete" onclick="deleteCentrale(${centraleIndex})">🗑️ Supprimer centrale</button>
                        </div>
                        
                        <div class="centrale-info">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Nom de la centrale</label>
                                <input type="text" value="${centrale.name}" 
                                       data-centrale="${centraleIndex}" 
                                       data-field="name" 
                                       style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Prix (CHF)</label>
                                <input type="number" step="0.01" value="${centrale.price}" 
                                       data-centrale="${centraleIndex}" 
                                       data-field="price" 
                                       style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div id="kits-container-${centraleIndex}"></div>
                        
                        <button class="btn-small btn-add" onclick="addKitToCentrale(${centraleIndex})" style="margin-top: 10px;">+ Ajouter un kit</button>
                    `;
                    container.appendChild(card);
                    
                    // Rendre les kits
                    this.renderKits(centraleIndex);
                });
            }

            renderKits(centraleIndex) {
                const centrale = this.centralesConfig[centraleIndex];
                const kitsContainer = document.getElementById(`kits-container-${centraleIndex}`);
                kitsContainer.innerHTML = '';
                
                centrale.kits.forEach((kit, kitIndex) => {
                    const kitSection = document.createElement('div');
                    kitSection.className = 'kit-section';
                    kitSection.innerHTML = `
                        <div class="kit-header">
                            <h5>📦 ${kit.name}</h5>
                            <button class="icon-btn delete" onclick="deleteKit(${centraleIndex}, ${kitIndex})">🗑️</button>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Nom du kit</label>
                            <input type="text" value="${kit.name}" 
                                   data-centrale="${centraleIndex}" 
                                   data-kit="${kitIndex}" 
                                   data-field="kitName" 
                                   style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px;">
                        </div>
                        
                        <div id="kit-products-${centraleIndex}-${kitIndex}" style="margin-top: 10px;">
                        </div>
                        
                        <button class="btn-small btn-add" onclick="addProductToKit(${centraleIndex}, ${kitIndex})">+ Ajouter un produit au kit</button>
                    `;
                    kitsContainer.appendChild(kitSection);
                    
                    // Rendre les produits du kit
                    this.renderKitProducts(centraleIndex, kitIndex);
                });
            }

            renderKitProducts(centraleIndex, kitIndex) {
                const kit = this.centralesConfig[centraleIndex].kits[kitIndex];
                const container = document.getElementById(`kit-products-${centraleIndex}-${kitIndex}`);
                container.innerHTML = '';
                
                const alarmProducts = this.catalog['alarm-material'].filter(p => !p.isCustom && p.id !== 5 && p.id !== 6);
                
                kit.products.forEach((product, productIndex) => {
                    const line = document.createElement('div');
                    line.className = 'kit-product-line';
                    
                    const selectedProduct = alarmProducts.find(p => p.id === product.id);
                    
                    line.innerHTML = `
                        <select data-centrale="${centraleIndex}" 
                                data-kit="${kitIndex}" 
                                data-product="${productIndex}">
                            <option value="">Sélectionner un produit</option>
                            ${alarmProducts.map(p => `
                                <option value="${p.id}" ${p.id === product.id ? 'selected' : ''}>
                                    ${p.name}
                                </option>
                            `).join('')}
                        </select>
                        
                        <input type="number" min="1" value="${product.quantity}" 
                               data-centrale="${centraleIndex}" 
                               data-kit="${kitIndex}" 
                               data-product="${productIndex}"
                               placeholder="Qté">
                        
                        <button class="icon-btn delete" onclick="deleteKitProduct(${centraleIndex}, ${kitIndex}, ${productIndex})">🗑️</button>
                    `;
                    
                    container.appendChild(line);
                });
            }

            renderAlarmProducts() {
                const tbodyTitane = document.getElementById('alarm-titane-body');
                const tbodyJablotron = document.getElementById('alarm-jablotron-body');
                tbodyTitane.innerHTML = '';
                tbodyJablotron.innerHTML = '';
                
                const products = this.catalog['alarm-material'].filter(p => !p.isCustom);
                
                // Produits Titane
                products.forEach((product, index) => {
                    // Si le produit a un prix Titane ou un prix générique (et n'est pas exclusif Jablotron)
                    if ((product.priceTitane !== undefined || (product.price !== undefined && !product.requiresJablotron)) && product.id !== 5) {
                        const isCentral = product.id === 6;
                        const price = product.priceTitane !== undefined ? product.priceTitane : product.price;
                        const cashOnly = !product.monthlyTitane;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="text" value="${product.name}" data-field="name" data-index="${index}" data-type="titane"></td>
                            <td><input type="number" step="0.01" value="${price || 0}" data-field="priceTitane" data-index="${index}" data-type="titane"></td>
                            <td><input type="number" step="1" value="${product.monthlyTitane || ''}" data-field="monthlyTitane" data-index="${index}" data-type="titane" ${cashOnly ? 'disabled' : ''}></td>
                            <td>
                                <div class="checkbox-field">
                                    <input type="checkbox" ${cashOnly ? 'checked' : ''} onchange="toggleAlarmCashOnly(${index}, 'titane', this.checked)">
                                </div>
                            </td>
                            <td class="actions">
                                ${!isCentral ? `<button class="icon-btn delete" onclick="deleteAlarmProduct(${index}, 'titane')">🗑️</button>` : ''}
                            </td>
                        `;
                        tbodyTitane.appendChild(row);
                    }
                });
                
                // Produits Jablotron
                products.forEach((product, index) => {
                    // Si le produit a un prix Jablotron ou est exclusif Jablotron
                    if (product.priceJablotron !== undefined || product.requiresJablotron || product.id === 5) {
                        const isCentral = product.id === 5;
                        const price = product.priceJablotron !== undefined ? product.priceJablotron : product.price;
                        const cashOnly = !product.monthlyJablotron;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="text" value="${product.name}" data-field="name" data-index="${index}" data-type="jablotron"></td>
                            <td><input type="number" step="0.01" value="${price || 0}" data-field="priceJablotron" data-index="${index}" data-type="jablotron"></td>
                            <td><input type="number" step="1" value="${product.monthlyJablotron || ''}" data-field="monthlyJablotron" data-index="${index}" data-type="jablotron" ${cashOnly ? 'disabled' : ''}></td>
                            <td>
                                <div class="checkbox-field">
                                    <input type="checkbox" ${cashOnly ? 'checked' : ''} onchange="toggleAlarmCashOnly(${index}, 'jablotron', this.checked)">
                                </div>
                            </td>
                            <td class="actions">
                                ${!isCentral ? `<button class="icon-btn delete" onclick="deleteAlarmProduct(${index}, 'jablotron')">🗑️</button>` : ''}
                            </td>
                        `;
                        tbodyJablotron.appendChild(row);
                    }
                });
            }

            renderCameraProducts() {
                const tbody = document.getElementById('camera-products-body');
                tbody.innerHTML = '';
                
                const products = this.catalog['camera-material'].filter(p => !p.isCustom);
                
                products.forEach((product, index) => {
                    const cashOnly = !product.monthly48 && !product.monthly36 && !product.monthly24;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" value="${product.name}" data-field="name" data-index="${index}"></td>
                        <td><input type="number" step="0.01" value="${product.price}" data-field="price" data-index="${index}"></td>
                        <td><input type="number" step="1" value="${product.monthly48 || ''}" data-field="monthly48" data-index="${index}" ${cashOnly ? 'disabled' : ''}></td>
                        <td><input type="number" step="1" value="${product.monthly36 || ''}" data-field="monthly36" data-index="${index}" ${cashOnly ? 'disabled' : ''}></td>
                        <td><input type="number" step="1" value="${product.monthly24 || ''}" data-field="monthly24" data-index="${index}" ${cashOnly ? 'disabled' : ''}></td>
                        <td>
                            <div class="checkbox-field">
                                <input type="checkbox" ${cashOnly ? 'checked' : ''} onchange="toggleCameraCashOnly(${index}, this.checked)">
                            </div>
                        </td>
                        <td class="actions">
                            <button class="icon-btn delete" onclick="deleteCameraProduct(${index})">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            renderFogProducts() {
                const tbody = document.getElementById('fog-products-body');
                tbody.innerHTML = '';
                
                const products = this.catalog['fog-material'].filter(p => !p.isCustom);
                
                products.forEach((product, index) => {
                    const cashOnly = !product.monthly;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" value="${product.name}" data-field="name" data-index="${index}"></td>
                        <td><input type="number" step="0.01" value="${product.price}" data-field="price" data-index="${index}"></td>
                        <td><input type="number" step="1" value="${product.monthly || ''}" data-field="monthly" data-index="${index}" ${cashOnly ? 'disabled' : ''}></td>
                        <td>
                            <div class="checkbox-field">
                                <input type="checkbox" ${cashOnly ? 'checked' : ''} onchange="toggleFogCashOnly(${index}, this.checked)">
                            </div>
                        </td>
                        <td class="actions">
                            <button class="icon-btn delete" onclick="deleteFogProduct(${index})">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            renderCommercials() {
                const container = document.getElementById('commercial-list');
                container.innerHTML = '';
                
                this.commercialsList.forEach((commercial, index) => {
                    const item = document.createElement('div');
                    item.className = 'commercial-item';
                    item.innerHTML = `
                        <input type="text" value="${commercial}" data-index="${index}">
                        <button class="icon-btn delete" onclick="deleteCommercial(${index})">🗑️</button>
                    `;
                    container.appendChild(item);
                });
            }

            collectCatalogData() {
                // Centrales configuration
                const centralesConfig = [];
                this.centralesConfig.forEach((centrale, centraleIndex) => {
                    const centraleData = {
                        id: centrale.id,
                        name: document.querySelector(`input[data-centrale="${centraleIndex}"][data-field="name"]`).value,
                        productId: centrale.productId,
                        price: parseFloat(document.querySelector(`input[data-centrale="${centraleIndex}"][data-field="price"]`).value) || 0,
                        kits: []
                    };
                    
                    centrale.kits.forEach((kit, kitIndex) => {
                        const kitName = document.querySelector(`input[data-centrale="${centraleIndex}"][data-kit="${kitIndex}"][data-field="kitName"]`).value;
                        const kitProducts = [];
                        
                        const productSelects = document.querySelectorAll(`select[data-centrale="${centraleIndex}"][data-kit="${kitIndex}"]`);
                        productSelects.forEach((select, productIndex) => {
                            const productId = parseInt(select.value);
                            const qtyInput = document.querySelector(`input[data-centrale="${centraleIndex}"][data-kit="${kitIndex}"][data-product="${productIndex}"]`);
                            const quantity = parseInt(qtyInput.value) || 1;
                            
                            if (productId) {
                                kitProducts.push({ id: productId, quantity });
                            }
                        });
                        
                        if (kitProducts.length > 0) {
                            centraleData.kits.push({
                                name: kitName,
                                products: kitProducts
                            });
                        }
                    });
                    
                    centralesConfig.push(centraleData);
                });
                
                // Alarm products - on doit fusionner les données des deux tableaux
                const alarmProducts = [];
                const productsMap = new Map();
                
                // Collecter les produits Titane
                const titaneRows = document.querySelectorAll('#alarm-titane-body tr');
                titaneRows.forEach(row => {
                    const index = parseInt(row.querySelector('input[data-field="name"]').getAttribute('data-index'));
                    const originalProduct = this.catalog['alarm-material'].filter(p => !p.isCustom)[index];
                    
                    const product = {
                        id: originalProduct.id,
                        name: row.querySelector('input[data-field="name"]').value,
                        priceTitane: parseFloat(row.querySelector('input[data-field="priceTitane"]').value) || 0
                    };
                    
                    const monthlyTitane = row.querySelector('input[data-field="monthlyTitane"]').value;
                    if (monthlyTitane) product.monthlyTitane = parseInt(monthlyTitane);
                    
                    productsMap.set(originalProduct.id, product);
                });
                
                // Collecter les produits Jablotron et fusionner
                const jablotronRows = document.querySelectorAll('#alarm-jablotron-body tr');
                jablotronRows.forEach(row => {
                    const index = parseInt(row.querySelector('input[data-field="name"]').getAttribute('data-index'));
                    const originalProduct = this.catalog['alarm-material'].filter(p => !p.isCustom)[index];
                    
                    const priceJablotron = parseFloat(row.querySelector('input[data-field="priceJablotron"]').value) || 0;
                    const monthlyJablotron = row.querySelector('input[data-field="monthlyJablotron"]').value;
                    
                    if (productsMap.has(originalProduct.id)) {
                        // Produit existe déjà (commun aux deux), ajouter les infos Jablotron
                        const product = productsMap.get(originalProduct.id);
                        product.priceJablotron = priceJablotron;
                        if (monthlyJablotron) product.monthlyJablotron = parseInt(monthlyJablotron);
                    } else {
                        // Produit exclusif Jablotron
                        const product = {
                            id: originalProduct.id,
                            name: row.querySelector('input[data-field="name"]').value,
                            priceJablotron: priceJablotron,
                            requiresJablotron: true
                        };
                        if (monthlyJablotron) product.monthlyJablotron = parseInt(monthlyJablotron);
                        productsMap.set(originalProduct.id, product);
                    }
                });
                
                // Convertir la Map en tableau
                productsMap.forEach(product => {
                    // Si le produit n'a qu'un prix (pas les deux), on le met dans price aussi
                    if (product.priceTitane !== undefined && product.priceJablotron === undefined) {
                        product.price = product.priceTitane;
                    } else if (product.priceJablotron !== undefined && product.priceTitane === undefined) {
                        product.price = product.priceJablotron;
                    }
                    alarmProducts.push(product);
                });
                
                // Camera products
                const cameraProducts = [];
                const cameraRows = document.querySelectorAll('#camera-products-body tr');
                cameraRows.forEach(row => {
                    const index = parseInt(row.querySelector('input[data-field="name"]').getAttribute('data-index'));
                    const originalProduct = this.catalog['camera-material'].filter(p => !p.isCustom)[index];
                    
                    const product = {
                        id: originalProduct.id,
                        name: row.querySelector('input[data-field="name"]').value,
                        price: parseFloat(row.querySelector('input[data-field="price"]').value) || 0
                    };
                    
                    const monthly48 = row.querySelector('input[data-field="monthly48"]').value;
                    const monthly36 = row.querySelector('input[data-field="monthly36"]').value;
                    const monthly24 = row.querySelector('input[data-field="monthly24"]').value;
                    
                    if (monthly48) product.monthly48 = parseInt(monthly48);
                    if (monthly36) product.monthly36 = parseInt(monthly36);
                    if (monthly24) product.monthly24 = parseInt(monthly24);
                    
                    cameraProducts.push(product);
                });
                
                // Fog products
                const fogProducts = [];
                const fogRows = document.querySelectorAll('#fog-products-body tr');
                fogRows.forEach(row => {
                    const index = parseInt(row.querySelector('input[data-field="name"]').getAttribute('data-index'));
                    const originalProduct = this.catalog['fog-material'].filter(p => !p.isCustom)[index];
                    
                    const product = {
                        id: originalProduct.id,
                        name: row.querySelector('input[data-field="name"]').value,
                        price: parseFloat(row.querySelector('input[data-field="price"]').value) || 0
                    };
                    
                    const monthly = row.querySelector('input[data-field="monthly"]').value;
                    if (monthly) product.monthly = parseInt(monthly);
                    
                    fogProducts.push(product);
                });
                
                // Commercials
                const commercials = [];
                const commercialInputs = document.querySelectorAll('#commercial-list input');
                commercialInputs.forEach(input => {
                    if (input.value.trim()) {
                        commercials.push(input.value.trim());
                    }
                });
                
                return {
                    centralesConfig,
                    alarmProducts,
                    cameraProducts,
                    fogProducts,
                    commercials
                };
            }

            validateCatalogData(data) {
                // Check centrales
                for (let centrale of data.centralesConfig) {
                    if (!centrale.name.trim()) {
                        alert('Toutes les centrales doivent avoir un nom');
                        return false;
                    }
                    if (centrale.price === 0 || isNaN(centrale.price)) {
                        alert(`La centrale "${centrale.name}" doit avoir un prix valide`);
                        return false;
                    }
                    if (centrale.kits.length === 0) {
                        alert(`La centrale "${centrale.name}" doit avoir au moins un kit`);
                        return false;
                    }
                    for (let kit of centrale.kits) {
                        if (!kit.name.trim()) {
                            alert(`Tous les kits de la centrale "${centrale.name}" doivent avoir un nom`);
                            return false;
                        }
                        if (kit.products.length === 0) {
                            alert(`Le kit "${kit.name}" de la centrale "${centrale.name}" doit contenir au moins un produit`);
                            return false;
                        }
                    }
                }
                
                // Check alarm products
                for (let product of data.alarmProducts) {
                    if (!product.name.trim()) {
                        alert('Tous les produits d\'alarme doivent avoir un nom');
                        return false;
                    }
                    if (product.price === 0 || isNaN(product.price)) {
                        alert(`Le produit "${product.name}" doit avoir un prix valide`);
                        return false;
                    }
                }
                
                // Check camera products
                for (let product of data.cameraProducts) {
                    if (!product.name.trim()) {
                        alert('Tous les produits caméra doivent avoir un nom');
                        return false;
                    }
                    if (product.price === 0 || isNaN(product.price)) {
                        alert(`Le produit "${product.name}" doit avoir un prix valide`);
                        return false;
                    }
                }
                
                // Check fog products
                for (let product of data.fogProducts) {
                    if (!product.name.trim()) {
                        alert('Tous les produits brouillard doivent avoir un nom');
                        return false;
                    }
                    if (product.price === 0 || isNaN(product.price)) {
                        alert(`Le produit "${product.name}" doit avoir un prix valide`);
                        return false;
                    }
                }
                
                if (data.commercials.length === 0) {
                    alert('Vous devez avoir au moins un commercial');
                    return false;
                }
                
                return true;
            }

            applyCatalogChanges(data) {
                // Update centrales config
                this.centralesConfig = data.centralesConfig;
                
                // Update alarm products
                this.catalog['alarm-material'] = [
                    ...data.alarmProducts.sort((a, b) => a.name.localeCompare(b.name)),
                    { id: 99, name: "Autre", price: 0.00, isCustom: true }
                ];
                
                this.catalog['alarm-installation'] = [
                    { id: 99, name: "Autre", price: 0.00, isCustom: true },
                    ...data.alarmProducts.filter(p => p.id !== 5 && p.id !== 6).sort((a, b) => a.name.localeCompare(b.name)),
                    { id: 20, name: "Installation, paramétrages, tests, mise en service & formation (1/2 journée)", price: 690.00 }
                ];
                
                // Update camera products
                this.catalog['camera-material'] = [
                    { id: 99, name: "Autre", price: 0.00, isCustom: true },
                    ...data.cameraProducts.sort((a, b) => a.name.localeCompare(b.name))
                ];
                
                // Update fog products
                this.catalog['fog-material'] = [
                    ...data.fogProducts.sort((a, b) => a.name.localeCompare(b.name)),
                    { id: 99, name: "Autre", price: 0.00, isCustom: true }
                ];
                
                // Update commercials
                this.commercialsList = data.commercials;
                
                // Save to storage
                this.saveCatalogToStorage();
                
                // Update all dropdowns
                this.updateAllProductSelects();
                this.updateCommercialSelects();
            }

            updateCommercialSelects() {
                const selects = ['commercial', 'commercialCamera', 'commercialFog'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        const optionsHTML = `
                            <option value="">Sélectionner un commercial</option>
                            ${this.commercialsList.map(c => `<option value="${c}">${c}</option>`).join('')}
                            <option value="autre" style="font-style: italic; color: #007bff;">➕ Autre (saisir le nom)</option>
                        `;
                        select.innerHTML = optionsHTML;
                        if (currentValue && (this.commercialsList.includes(currentValue) || currentValue === 'autre')) {
                            select.value = currentValue;
                        }
                    }
                });
            }

            updateCurrentDate() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-CH', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('currentDate').textContent = dateStr;
            }

            showTab(tabName, element) {
                this.currentTab = tabName;
                
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetTab = document.getElementById(`${tabName}-tab`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                if (element) {
                    element.classList.add('active');
                }

                this.updateTotals();
            }

            toggleRentalMode(type) {
                this.rentalMode[type] = document.getElementById(`${type}-rental-mode`).checked;
                
                if (type === 'alarm') {
                    const paymentSection = document.getElementById('alarm-payment-section');
                    if (paymentSection) {
                        paymentSection.style.display = this.rentalMode[type] ? 'none' : 'block';
                    }
                    
                    if (this.rentalMode[type]) {
                        this.globalPaymentMonths['alarm'] = 0;
                    } else {
                        this.globalPaymentMonths['alarm'] = 48;
                    }
                } else if (type === 'camera') {
                    const paymentSection = document.getElementById('camera-payment-section');
                    if (paymentSection) {
                        paymentSection.style.display = this.rentalMode[type] ? 'none' : 'block';
                    }
                    
                    document.getElementById('camera-remote-section').style.display = this.rentalMode[type] ? 'none' : 'block';
                    document.getElementById('camera-maintenance-section').style.display = this.rentalMode[type] ? 'none' : 'block';
                    document.getElementById('camera-remote-summary').style.display = this.rentalMode[type] ? 'none' : 'flex';
                    document.getElementById('camera-maintenance-summary').style.display = this.rentalMode[type] ? 'none' : 'flex';
                    
                    if (this.rentalMode[type]) {
                        this.globalPaymentMonths['camera'] = 0;
                        document.getElementById('camera-remote-access').checked = false;
                    } else {
                        this.globalPaymentMonths['camera'] = 48;
                    }
                } else if (type === 'fog') {
                    const paymentSection = document.getElementById('fog-payment-section');
                    if (paymentSection) {
                        paymentSection.style.display = this.rentalMode[type] ? 'none' : 'block';
                    }
                    
                    if (this.rentalMode[type]) {
                        this.globalPaymentMonths['fog'] = 0;
                    } else {
                        this.globalPaymentMonths['fog'] = 48;
                    }
                }
                
                this.updateTotals();
            }

            calculateInstallationPrice(qty) {
                const prices = {
                    1: 690,
                    2: 1290,
                    3: 1980,
                    4: 2580,
                    5: 3270,
                    6: 3870
                };
                
                if (qty > 6) {
                    const fullDays = Math.floor(qty / 2);
                    const halfDay = qty % 2;
                    return (fullDays * 1290) + (halfDay * 690);
                }
                
                return prices[qty] || 690;
            }

            getInstallationMonthlyPrice(qty, months) {
                const monthlyPrices = {
                    1: { 24: 32, 36: 23, 48: 18 },
                    2: { 24: 60, 36: 42, 48: 33 },
                    3: { 24: 91, 36: 64, 48: 50 },
                    4: { 24: 119, 36: 83, 48: 65 },
                    5: { 24: 151, 36: 106, 48: 83 },
                    6: { 24: 179, 36: 125, 48: 98 }
                };
                
                if (qty > 6) {
                    const fullDays = Math.floor(qty / 2);
                    const halfDay = qty % 2;
                    
                    if (months === 24) {
                        return (fullDays * 60) + (halfDay * 32);
                    } else if (months === 36) {
                        return (fullDays * 42) + (halfDay * 23);
                    } else if (months === 48) {
                        return (fullDays * 33) + (halfDay * 18);
                    }
                }
                
                if (monthlyPrices[qty] && monthlyPrices[qty][months]) {
                    return monthlyPrices[qty][months];
                }
                
                return 0;
            }

            calculateSectionMonthlyPrice(sectionId, months) {
                const container = document.getElementById(`${sectionId}-products`);
                if (!container || months === 0) return 0;
                
                let monthlyTotal = 0;
                const productLines = container.querySelectorAll('.product-line');
                
                productLines.forEach(line => {
                    const select = line.querySelector('.product-select');
                    const qtyInput = line.querySelector('.quantity-input');
                    const offeredCheckbox = line.querySelector('.offered-checkbox');
                    const nameInput = line.querySelector('.product-name-input');
                    const priceInput = line.querySelector('.price-input');
                    
                    const isOffered = offeredCheckbox?.checked || false;
                    if (isOffered) return;
                    
                    const qty = parseInt(qtyInput?.value) || 0;
                    if (qty === 0) return;
                    
                    if (nameInput && nameInput.style.display !== 'none' && nameInput.value) {
                        const priceHT = parseFloat(priceInput?.value) || 0;
                        monthlyTotal += (priceHT / months) * qty;
                        return;
                    }
                    
                    if (!select || !select.value) return;
                    
                    const productId = parseInt(select.value);
                    const product = this.catalog[sectionId]?.find(p => p.id === productId);
                    
                    if (!product) return;
                    
                    let monthlyPrice = 0;
                    
                    if (sectionId === 'alarm-material' || sectionId === 'alarm-installation') {
                        if (this.selectedCentral === 'titane' && product.monthlyTitane !== undefined) {
                            monthlyPrice = product.monthlyTitane;
                        } else if (this.selectedCentral === 'jablotron' && product.monthlyJablotron !== undefined) {
                            monthlyPrice = product.monthlyJablotron;
                        }
                    } else if (sectionId === 'camera-material') {
                        if (months === 48 && product.monthly48 !== undefined) {
                            monthlyPrice = product.monthly48;
                        } else if (months === 36 && product.monthly36 !== undefined) {
                            monthlyPrice = product.monthly36;
                        } else if (months === 24 && product.monthly24 !== undefined) {
                            monthlyPrice = product.monthly24;
                        }
                    } else if (sectionId === 'fog-material') {
                        if (product.monthly !== undefined) {
                            monthlyPrice = product.monthly;
                        }
                    }
                    
                    if (monthlyPrice === 0) {
                        const priceHT = this.getProductPrice(product);
                        monthlyPrice = priceHT / months;
                    }
                    
                    monthlyPrice = this.roundToFiveCents(monthlyPrice);
                    monthlyTotal += monthlyPrice * qty;
                });
                
                return monthlyTotal;
            }
            
            calculateCameraInstallationPrice() {
                const qtyInput = document.getElementById('camera-installation-qty');
                const qty = parseInt(qtyInput.value) || 1;
                return this.calculateInstallationPrice(qty);
            }

            updateAlarmInstallationPrice() {
                const qtyInput = document.getElementById('alarm-installation-qty');
                const priceInput = document.getElementById('alarm-installation-price');
                const qty = parseInt(qtyInput.value) || 1;
                const price = this.calculateInstallationPrice(qty);
                priceInput.value = price;
                
                this.updateTotals();
            }

            updateCameraInstallationPrice() {
                const qtyInput = document.getElementById('camera-installation-qty');
                const qty = parseInt(qtyInput.value) || 1;
                const price = this.calculateInstallationPrice(qty);
                
                const priceDisplay = document.getElementById('camera-installation-price');
                const offeredCheckbox = document.getElementById('camera-installation-offered');
                
                if (!offeredCheckbox.checked) {
                    priceDisplay.textContent = `${price.toFixed(2)} CHF`;
                }
                
                this.updateTotals();
            }

            showKitSelector() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;
                
                // Créer les options de centrales dynamiquement
                const centralesHTML = this.centralesConfig.map(centrale => `
                    <div id="central-${centrale.id}" style="background: #f8f9fa; padding: 20px; border-radius: 10px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                         onmouseover="this.style.borderColor='#f4e600'" 
                         onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='transparent'"
                         onclick="selectCentralType('${centrale.id}')">
                        <h4 style="margin-bottom: 10px; color: #333;">${centrale.name}</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Système de sécurité</p>
                        <p style="font-weight: bold; color: #28a745;">${centrale.price.toFixed(2)} CHF</p>
                    </div>
                `).join('');
                
                modal.innerHTML = `
                    <h2 style="margin-bottom: 20px; color: #333;">🛡️ Sélection du Kit de Base</h2>
                    <p style="margin-bottom: 20px; color: #666;">Choisissez d'abord votre centrale, puis le kit de base inclus</p>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">1️⃣ Choisissez votre centrale</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            ${centralesHTML}
                        </div>
                    </div>
                    
                    <div id="kit-selection" style="display: none;">
                        <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">2️⃣ Choisissez votre kit OFFERT</h3>
                        <div id="kit-options"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="validate-kit-btn" onclick="validateKitSelection()" disabled style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; opacity: 0.5;">
                            Valider la sélection
                        </button>
                        <button onclick="closeKitSelector()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            Annuler
                        </button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                window.selectedCentralType = null;
                window.selectedKitType = null;
                
                window.selectCentralType = (centraleId) => {
                    // Réinitialiser tous les styles
                    this.centralesConfig.forEach(c => {
                        const el = document.getElementById(`central-${c.id}`);
                        if (el) {
                            el.classList.remove('selected');
                            el.style.borderColor = 'transparent';
                        }
                    });
                    
                    const selectedElement = document.getElementById(`central-${centraleId}`);
                    selectedElement.classList.add('selected');
                    selectedElement.style.borderColor = '#f4e600';
                    window.selectedCentralType = centraleId;
                    
                    // Trouver la centrale sélectionnée
                    const centrale = this.centralesConfig.find(c => c.id === centraleId);
                    
                    // Construire les options de kits
                    const kitsHTML = centrale.kits.map((kit, index) => {
                        // Calculer le total du kit
                        let kitTotal = 0;
                        const kitProducts = kit.products.map(p => {
                            const product = this.catalog['alarm-material'].find(prod => prod.id === p.id);
                            if (product) {
                                const price = this.getProductPrice(product);
                                kitTotal += price * p.quantity;
                                return `<li>${p.quantity}x ${product.name} (${price.toFixed(2)} CHF/u)</li>`;
                            }
                            return '';
                        }).join('');
                        
                        return `
                            <div id="kit-${index}" style="background: #f8f9fa; padding: 20px; border-radius: 10px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; margin-bottom: 10px;" 
                                 onmouseover="this.style.borderColor='#f4e600'" 
                                 onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='transparent'"
                                 onclick="selectKitType(${index})">
                                <h4 style="margin-bottom: 10px; color: #333;">📦 ${kit.name}</h4>
                                <ul style="margin: 0 0 10px 20px; padding: 0; color: #666; font-size: 14px;">
                                    ${kitProducts}
                                </ul>
                                <p style="font-weight: bold; color: #28a745;">Valeur: ${kitTotal.toFixed(2)} CHF - OFFERT</p>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('kit-options').innerHTML = kitsHTML;
                    document.getElementById('kit-selection').style.display = 'block';
                };
                
                window.selectKitType = (kitIndex) => {
                    // Réinitialiser tous les kits
                    const centrale = this.centralesConfig.find(c => c.id === window.selectedCentralType);
                    centrale.kits.forEach((kit, index) => {
                        const el = document.getElementById(`kit-${index}`);
                        if (el) {
                            el.classList.remove('selected');
                            el.style.borderColor = 'transparent';
                        }
                    });
                    
                    const selectedElement = document.getElementById(`kit-${kitIndex}`);
                    selectedElement.classList.add('selected');
                    selectedElement.style.borderColor = '#f4e600';
                    window.selectedKitType = kitIndex;
                    
                    document.getElementById('validate-kit-btn').disabled = false;
                    document.getElementById('validate-kit-btn').style.opacity = '1';
                };
                
                window.validateKitSelection = () => {
                    if (window.selectedCentralType && window.selectedKitType !== null) {
                        const centrale = this.centralesConfig.find(c => c.id === window.selectedCentralType);
                        const kit = centrale.kits[window.selectedKitType];
                        this.addCompleteKit(window.selectedCentralType, window.selectedKitType);
                        document.body.removeChild(overlay);
                        this.showNotification(`Kit ${kit.name} avec centrale ${centrale.name} ajouté`);
                    }
                };
                
                window.closeKitSelector = () => {
                    document.body.removeChild(overlay);
                };
            }

            addCompleteKit(centraleId, kitIndex) {
                const container = document.getElementById('alarm-material-products');
                container.innerHTML = '';
                
                const centrale = this.centralesConfig.find(c => c.id === centraleId);
                const kit = centrale.kits[kitIndex];
                
                this.selectedCentral = centraleId;
                this.kitOffered = true;
                
                const centralProduct = this.catalog['alarm-material'].find(p => p.id === centrale.productId);
                const centralPrice = centrale.price;
                
                const availableProducts = this.getFilteredProducts('alarm-material');
                const centralLine = document.createElement('div');
                centralLine.className = 'product-line central-line';
                centralLine.style.background = '#e3f2fd';
                centralLine.innerHTML = `
                    <div class="product-select-container" style="width: 100%;">
                        <select class="product-select" onchange="handleProductSelection(this)" data-section="alarm-material">
                            <option value="">Sélectionner un produit</option>
                            ${availableProducts.map(p => {
                                const pPrice = this.getProductPrice(p);
                                return `<option value="${p.id}" data-price="${pPrice}" data-custom="${p.isCustom ? 'true' : 'false'}" ${p.id === centrale.productId ? 'selected' : ''}>${p.name} - ${pPrice.toFixed(2)} CHF</option>`;
                            }).join('')}
                        </select>
                        <input type="text" class="product-name-input" style="display: none; width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 5px;" placeholder="Nom du produit personnalisé" oninput="updateTotals()">
                    </div>
                    <input type="number" value="1" min="1" class="quantity-input" readonly>
                    <input type="number" value="${centralPrice}" class="price-input discount-input" style="display: none;">
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" class="offered-checkbox" checked onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display">OFFERT</div>
                    <button class="remove-btn" onclick="this.closest('#alarm-material-products').innerHTML=''; generator.selectedCentral=null; generator.kitOffered=false; updateTotals();">×</button>
                `;
                container.appendChild(centralLine);
                
                // Ajouter les produits du kit
                kit.products.forEach(kitProduct => {
                    const productData = this.catalog['alarm-material'].find(p => p.id === kitProduct.id);
                    if (productData) {
                        const availableProducts = this.getFilteredProducts('alarm-material');
                        const price = this.getProductPrice(productData);
                        
                        const productLine = document.createElement('div');
                        productLine.className = 'product-line';
                        productLine.style.background = '#fffbf0';
                        
                        const lineId = 'kit-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        
                        productLine.innerHTML = `
                            <div class="product-select-container" style="width: 100%;">
                                <select class="product-select" onchange="handleProductSelection(this)" data-section="alarm-material">
                                    <option value="">Sélectionner un produit</option>
                                    ${availableProducts.map(p => {
                                        const pPrice = this.getProductPrice(p);
                                        return `<option value="${p.id}" data-price="${pPrice}" data-custom="${p.isCustom ? 'true' : 'false'}" ${p.id === kitProduct.id ? 'selected' : ''}>${p.name} - ${pPrice.toFixed(2)} CHF</option>`;
                                    }).join('')}
                                </select>
                                <input type="text" class="product-name-input" style="display: none; width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 5px;" placeholder="Nom du produit personnalisé" oninput="updateTotals()">
                            </div>
                            <input type="number" value="${kitProduct.quantity}" min="1" class="quantity-input" oninput="updateTotals()">
                            <input type="number" value="${price}" min="0" step="0.01" class="price-input discount-input" style="display: none;" placeholder="Prix unitaire" oninput="updateTotals()">
                            <div class="checkbox-option" style="margin: 0;">
                                <input type="checkbox" class="offered-checkbox" checked onchange="updateTotals()">
                                <label style="margin: 0; font-size: 12px;">OFFERT</label>
                            </div>
                            <div class="price-display">OFFERT</div>
                            <button class="remove-btn" onclick="this.closest('.product-line').remove(); updateTotals();">×</button>
                        `;
                        container.appendChild(productLine);
                    }
                });
                
                this.updateSurveillanceOptions(centraleId);
                this.updateAllProductSelects();
                this.updateTotals();
            }

            updateSurveillancePrice() {
                const surveillanceType = document.getElementById('surveillance-type').value;
                const priceInput = document.getElementById('surveillance-price');
                const offeredCheckbox = document.getElementById('surveillance-offered');
                
                offeredCheckbox.disabled = !surveillanceType;
                
                if (!surveillanceType) {
                    priceInput.value = 0;
                } else {
                    // Utiliser les prix basés sur le type de centrale
                    if (this.selectedCentral === 'titane') {
                        if (surveillanceType === 'autosurveillance') {
                            priceInput.value = 59;
                        } else if (surveillanceType === 'telesurveillance') {
                            priceInput.value = 129;
                        } else if (surveillanceType === 'telesurveillance-pro') {
                            priceInput.value = 159;
                        }
                    } else if (this.selectedCentral === 'jablotron') {
                        if (surveillanceType === 'telesurveillance') {
                            priceInput.value = 139;
                        } else if (surveillanceType === 'telesurveillance-pro') {
                            priceInput.value = 169;
                        } else {
                            priceInput.value = 0;
                        }
                    } else {
                        // Prix par défaut pour les autres centrales
                        if (surveillanceType === 'telesurveillance') {
                            priceInput.value = 129;
                        } else if (surveillanceType === 'telesurveillance-pro') {
                            priceInput.value = 159;
                        } else if (surveillanceType === 'autosurveillance') {
                            priceInput.value = 59;
                        } else {
                            priceInput.value = 0;
                        }
                    }
                }
                
                this.updateTotals();
            }

            addProductLine(sectionId) {
                const container = document.getElementById(`${sectionId}-products`);
                
                const productLine = document.createElement('div');
                productLine.className = 'product-line';
                
                let availableProducts = this.catalog[sectionId];
                if (sectionId === 'alarm-material' || sectionId === 'alarm-installation') {
                    availableProducts = this.getFilteredProducts(sectionId);
                }
                
                const lineId = 'line-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                productLine.innerHTML = `
                    <div class="product-select-container" style="width: 100%;">
                        <select class="product-select" id="select-${lineId}" onchange="handleProductSelection(this)" data-section="${sectionId}">
                            <option value="">Sélectionner un produit</option>
                            ${availableProducts.map(product => {
                                const price = this.getProductPrice(product);
                                return `<option value="${product.id}" data-price="${price}" data-custom="${product.isCustom ? 'true' : 'false'}">${product.name} - ${price.toFixed(2)} CHF</option>`;
                            }).join('')}
                        </select>
                        <input type="text" class="product-name-input" id="name-${lineId}" style="display: none; width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 5px;" placeholder="Nom du produit personnalisé" oninput="updateTotals()">
                    </div>
                    <input type="number" value="1" min="1" class="quantity-input" oninput="updateTotals()">
                    <input type="number" value="0" min="0" step="0.01" class="price-input discount-input" style="display: none;" placeholder="Prix unitaire" oninput="updateTotals()">
                    <div class="checkbox-option" style="margin: 0;">
                        <input type="checkbox" class="offered-checkbox" onchange="updateTotals()">
                        <label style="margin: 0; font-size: 12px;">OFFERT</label>
                    </div>
                    <div class="price-display">0.00 CHF</div>
                    <button class="remove-btn" onclick="this.closest('.product-line').remove(); updateTotals();">×</button>
                `;
                
                container.appendChild(productLine);
            }

            handleProductSelection(selectElement) {
                const productId = parseInt(selectElement.value);
                const sectionId = selectElement.getAttribute('data-section');
                const selectedOption = selectElement.querySelector(`option[value="${selectElement.value}"]`);
                const isCustom = selectedOption?.getAttribute('data-custom') === 'true';
                const productLine = selectElement.closest('.product-line');
                const priceInput = productLine.querySelector('.price-input');
                const nameInput = productLine.querySelector('.product-name-input');
                const selectContainer = productLine.querySelector('.product-select-container');
                
                if (isCustom && productId === 99) {
                    selectElement.style.display = 'none';
                    nameInput.style.display = 'block';
                    nameInput.focus();
                    
                    if (priceInput) {
                        priceInput.style.display = 'block';
                        priceInput.value = 0;
                    }
                    
                    if (!selectContainer.querySelector('.back-to-select-btn')) {
                        const backBtn = document.createElement('button');
                        backBtn.className = 'back-to-select-btn';
                        backBtn.innerHTML = '↩';
                        backBtn.style.cssText = 'position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #6c757d; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer; font-size: 12px;';
                        backBtn.onclick = () => {
                            selectElement.style.display = 'block';
                            nameInput.style.display = 'none';
                            priceInput.style.display = 'none';
                            selectElement.value = '';
                            nameInput.value = '';
                            priceInput.value = 0;
                            backBtn.remove();
                            if (sectionId === 'camera-material') {
                                this.updateCameraInstallationPrice();
                            }
                            this.updateTotals();
                        };
                        selectContainer.style.position = 'relative';
                        selectContainer.appendChild(backBtn);
                    }
                } else {
                    if (nameInput) {
                        nameInput.style.display = 'none';
                    }
                    if (priceInput) {
                        priceInput.style.display = 'none';
                        const price = parseFloat(selectedOption?.getAttribute('data-price')) || 0;
                        priceInput.value = price;
                    }
                    const backBtn = selectContainer.querySelector('.back-to-select-btn');
                    if (backBtn) backBtn.remove();
                }
                
                if (sectionId === 'alarm-material' && (productId === 5 || productId === 6)) {
                    this.detectSelectedCentral();
                } else if (sectionId === 'alarm-material') {
                    this.detectSelectedCentral();
                }
                
                if (sectionId === 'camera-material') {
                    this.updateCameraInstallationPrice();
                }
                
                this.updateTotals();
            }

            getFilteredProducts(sectionId) {
                const products = this.catalog[sectionId];
                
                const isInstallationSection = sectionId === 'alarm-installation';
                
                if (!this.selectedCentral) {
                    if (isInstallationSection) {
                        return products.filter(p => p.id !== 5 && p.id !== 6 && !p.requiresJablotron);
                    }
                    return products.filter(p => !p.requiresJablotron);
                }
                
                if (this.selectedCentral === 'jablotron') {
                    if (isInstallationSection) {
                        return products.filter(p => p.id !== 5 && p.id !== 6);
                    }
                    return products;
                }
                
                if (isInstallationSection) {
                    return products.filter(p => p.id !== 5 && p.id !== 6 && !p.requiresJablotron);
                }
                return products.filter(p => !p.requiresJablotron);
            }

            getProductPrice(product) {
                if (!this.selectedCentral) {
                    return product.price;
                }
                
                if (this.selectedCentral === 'titane' && product.priceTitane) {
                    return product.priceTitane;
                }
                
                if (this.selectedCentral === 'jablotron' && product.priceJablotron) {
                    return product.priceJablotron;
                }
                
                return product.price;
            }
            
            detectSelectedCentral() {
                const container = document.getElementById('alarm-material-products');
                if (!container) return;
                
                const productLines = container.querySelectorAll('.product-line');
                let detectedCentrale = null;
                
                productLines.forEach(line => {
                    const select = line.querySelector('.product-select');
                    if (select && select.value) {
                        const productId = parseInt(select.value);
                        // Chercher si ce produit correspond à une centrale
                        const centrale = this.centralesConfig.find(c => c.productId === productId);
                        if (centrale) {
                            detectedCentrale = centrale.id;
                        }
                    }
                });
                
                if (detectedCentrale) {
                    this.selectedCentral = detectedCentrale;
                    this.kitOffered = true;
                    this.updateSurveillanceOptions(detectedCentrale);
                } else {
                    this.selectedCentral = null;
                    this.kitOffered = false;
                    this.updateSurveillanceOptions(null);
                }
                
                this.updateAllProductSelects();
                this.updateSurveillancePrice();
            }
            
            updateSurveillanceOptions(centraleId) {
                const surveillanceSelect = document.getElementById('surveillance-type');
                if (!surveillanceSelect) return;
                
                const currentValue = surveillanceSelect.value;
                
                // Trouver la centrale pour déterminer ses options
                const centrale = this.centralesConfig.find(c => c.id === centraleId);
                
                if (centraleId === 'jablotron') {
                    surveillanceSelect.innerHTML = `
                        <option value="">Aucun</option>
                        <option value="telesurveillance">Télésurveillance Particulier (139 CHF)</option>
                        <option value="telesurveillance-pro">Télésurveillance Professionnel (169 CHF)</option>
                    `;
                } else if (centraleId === 'titane') {
                    surveillanceSelect.innerHTML = `
                        <option value="">Aucun</option>
                        <option value="telesurveillance">Télésurveillance Particulier (129 CHF)</option>
                        <option value="telesurveillance-pro">Télésurveillance Professionnel (159 CHF)</option>
                        <option value="autosurveillance">Autosurveillance (59 CHF)</option>
                    `;
                } else {
                    // Pour les autres centrales, options par défaut
                    surveillanceSelect.innerHTML = `
                        <option value="">Aucun</option>
                        <option value="telesurveillance">Télésurveillance Particulier</option>
                        <option value="telesurveillance-pro">Télésurveillance Professionnel</option>
                        <option value="autosurveillance">Autosurveillance</option>
                    `;
                }
                
                const options = Array.from(surveillanceSelect.options).map(o => o.value);
                if (options.includes(currentValue)) {
                    surveillanceSelect.value = currentValue;
                } else {
                    surveillanceSelect.value = '';
                }
            }

            updateAllProductSelects() {
                const materialContainer = document.getElementById('alarm-material-products');
                if (materialContainer) {
                    this.updateSelectsInContainer(materialContainer, 'alarm-material');
                }
                
                const installContainer = document.getElementById('alarm-installation-products');
                if (installContainer) {
                    this.updateSelectsInContainer(installContainer, 'alarm-installation');
                }
                
                this.updateTotals();
            }
            
            updateSelectsInContainer(container, sectionId) {
                const productLines = container.querySelectorAll('.product-line');
                productLines.forEach(line => {
                    const select = line.querySelector('.product-select');
                    if (select) {
                        const currentValue = select.value;
                        const availableProducts = this.getFilteredProducts(sectionId);
                        
                        select.innerHTML = `
                            <option value="">Sélectionner un produit</option>
                            ${availableProducts.map(product => {
                                const price = this.getProductPrice(product);
                                return `<option value="${product.id}" data-price="${price}" ${product.id == currentValue ? 'selected' : ''}>${product.name} - ${price.toFixed(2)} CHF</option>`;
                            }).join('')}
                        `;
                        
                        if (currentValue) {
                            const selectedOption = select.querySelector(`option[value="${currentValue}"]`);
                            if (selectedOption) {
                                const newPrice = parseFloat(selectedOption.getAttribute('data-price'));
                                selectedOption.setAttribute('data-price', newPrice);
                            }
                        }
                    }
                    
                    if (this.kitOffered && sectionId === 'alarm-material') {
                        const offeredCheckbox = line.querySelector('.offered-checkbox');
                        if (offeredCheckbox && !line.classList.contains('central-line')) {
                            offeredCheckbox.checked = true;
                        }
                    }
                });
            }

            calculateSectionTotal(sectionId, forPDF = false) {
                const container = document.getElementById(`${sectionId}-products`);
                if (!container) return 0;
                
                let total = 0;
                let totalWithoutDiscount = 0;
                const productLines = container.querySelectorAll('.product-line');
                
                productLines.forEach(line => {
                    const quantity = parseFloat(line.querySelector('.quantity-input')?.value) || 0;
                    const priceInput = line.querySelector('.price-input');
                    const select = line.querySelector('.product-select');
                    const nameInput = line.querySelector('.product-name-input');
                    const selectedOption = select?.querySelector(`option[value="${select?.value}"]`);
                    const isOffered = line.querySelector('.offered-checkbox')?.checked || false;
                    
                    let price = 0;
                    
                    if (nameInput && nameInput.style.display !== 'none') {
                        price = parseFloat(priceInput?.value) || 0;
                    } else if (priceInput && priceInput.style.display !== 'none') {
                        price = parseFloat(priceInput.value) || 0;
                    } else if (selectedOption) {
                        price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                    }
                    
                    let lineTotal = price * quantity;
                    totalWithoutDiscount += lineTotal;
                    
                    if (!isOffered && (!forPDF || !this.kitOffered)) {
                        total += lineTotal;
                    }
                    
                    const priceDisplay = line.querySelector('.price-display');
                    if (priceDisplay && !forPDF) {
                        priceDisplay.textContent = isOffered ? 'OFFERT' : `${lineTotal.toFixed(2)} CHF`;
                    }
                });
                
                if (!forPDF || !this.kitOffered) {
                    const discountType = document.getElementById(`${sectionId}-discount-type`)?.value || 'percent';
                    const discountValue = parseFloat(document.getElementById(`${sectionId}-discount-value`)?.value) || 0;
                    
                    if (discountValue > 0) {
                        if (discountType === 'percent') {
                            total = total * (1 - discountValue / 100);
                        } else {
                            total = Math.max(0, total - discountValue);
                        }
                    }
                }
                
                return forPDF && this.kitOffered ? { total, totalWithoutDiscount } : total;
            }

            updateTotals() {
                if (this.currentTab === 'alarm') {
                    const materialTotal = this.calculateSectionTotal('alarm-material');
                    
                    const installQty = parseFloat(document.getElementById('alarm-installation-qty')?.value) || 1;
                    const installPrice = parseFloat(document.getElementById('alarm-installation-price')?.value) || 690;
                    const installOffered = document.getElementById('alarm-installation-offered')?.checked || false;
                    const installTotal = installOffered ? 0 : installPrice;
                    
                    document.getElementById('alarm-installation-display').textContent = 
                        installOffered ? 'OFFERT' : `${installTotal.toFixed(2)} CHF`;
                    
                    const otherInstallationTotal = this.calculateSectionTotal('alarm-installation');
                    const totalInstallation = installTotal + otherInstallationTotal;
                    
                    const adminTotal = 240;
                    
                    const testCycliqueSelected = document.getElementById('test-cyclique-selected').checked;
                    const testCycliquePrice = parseFloat(document.getElementById('test-cyclique-price').value) || 0;
                    const testCycliqueOffered = document.getElementById('test-cyclique-offered').checked;
                    const testCycliqueTotal = testCycliqueSelected ? (testCycliqueOffered ? 0 : testCycliquePrice) : 0;
                    
                    const surveillanceType = document.getElementById('surveillance-type').value;
                    const surveillancePrice = parseFloat(document.getElementById('surveillance-price').value) || 0;
                    const surveillanceOffered = document.getElementById('surveillance-offered').checked;
                    const surveillanceTotal = surveillanceType ? (surveillanceOffered ? 0 : surveillancePrice) : 0;
                    
                    document.getElementById('test-cyclique-total').textContent = testCycliqueSelected ? 
                        (testCycliqueOffered ? 'OFFERT' : `${testCycliqueTotal.toFixed(2)} CHF`) : '0.00 CHF';
                    document.getElementById('surveillance-total').textContent = surveillanceType ? 
                        (surveillanceOffered ? 'OFFERT' : `${surveillanceTotal.toFixed(2)} CHF/mois`) : '0.00 CHF/mois';
                    document.getElementById('surveillance-summary').textContent = surveillanceType ? 
                        (surveillanceOffered ? 'OFFERT' : `${surveillanceTotal.toFixed(2)} CHF/mois`) : '0.00 CHF/mois';
                    
                    const totalHT = materialTotal + totalInstallation + adminTotal + testCycliqueTotal;
                    const totalTTC = this.roundToFiveCents(totalHT * 1.081);
                    
                    document.getElementById('alarm-material-total').textContent = `${materialTotal.toFixed(2)} CHF`;
                    document.getElementById('alarm-installation-total').textContent = `${totalInstallation.toFixed(2)} CHF`;
                    document.getElementById('alarm-total-ht').textContent = `${totalHT.toFixed(2)} CHF`;
                    document.getElementById('alarm-total-ttc').textContent = `${totalTTC.toFixed(2)} CHF`;
                    
                    if (!this.rentalMode['alarm']) {
                        const paymentMonths = this.globalPaymentMonths['alarm'] || 0;
                        
                        if (paymentMonths > 0) {
                            const mensualiteMatHT = this.calculateSectionMonthlyPrice('alarm-material', paymentMonths);
                            const mensualiteMatSuppHT = this.calculateSectionMonthlyPrice('alarm-installation', paymentMonths);
                            const mensualiteInstallHT = this.roundToFiveCents(this.getInstallationMonthlyPrice(installQty, paymentMonths));
                            const totalMensuelHT = mensualiteMatHT + mensualiteMatSuppHT + mensualiteInstallHT + surveillanceTotal;
                            const totalMensuelTTC = this.roundToFiveCents(totalMensuelHT * 1.081);
                            
                            document.getElementById('alarm-monthly-amount').textContent = totalMensuelTTC.toFixed(2);
                            document.getElementById('alarm-monthly-count').textContent = paymentMonths;
                            document.getElementById('alarm-monthly-payment').style.display = 'block';
                            
                            const comptantTTC = this.roundToFiveCents(adminTotal * 1.081);
                            document.getElementById('alarm-cash-amount').textContent = comptantTTC.toFixed(2);
                            document.getElementById('alarm-cash-payment').style.display = 'block';
                        } else {
                            document.getElementById('alarm-monthly-payment').style.display = 'none';
                            document.getElementById('alarm-cash-payment').style.display = 'none';
                        }
                    } else {
                        document.getElementById('alarm-monthly-payment').style.display = 'none';
                        document.getElementById('alarm-cash-payment').style.display = 'none';
                    }
                    
                } else if (this.currentTab === 'camera') {
                    const materialTotal = this.calculateSectionTotal('camera-material');
                    const installationPrice = this.calculateCameraInstallationPrice();
                    const installationOffered = document.getElementById('camera-installation-offered').checked;
                    const installationTotal = installationOffered ? 0 : installationPrice;
                    const remoteAccess = !this.rentalMode['camera'] && document.getElementById('camera-remote-access').checked;
                    const remoteAccessPrice = remoteAccess ? 20 : 0;
                    
                    const totalHT = materialTotal + installationTotal;
                    const totalTTC = this.roundToFiveCents(totalHT * 1.081);
                    
                    document.getElementById('camera-material-total').textContent = `${materialTotal.toFixed(2)} CHF`;
                    document.getElementById('camera-installation-total').textContent = `${installationTotal.toFixed(2)} CHF`;
                    document.getElementById('camera-installation-price').textContent = installationOffered ? 'OFFERT' : `${installationTotal.toFixed(2)} CHF`;
                    
                    if (!this.rentalMode['camera']) {
                        document.getElementById('camera-remote-total').textContent = remoteAccess ? '20.00 CHF/mois' : '0.00 CHF/mois';
                        
                        const paymentMonths = this.globalPaymentMonths['camera'] || 0;
                        
                        if (paymentMonths > 0) {
                            const installQty = parseFloat(document.getElementById('camera-installation-qty')?.value) || 1;
                            
                            const mensualiteMatHT = this.calculateSectionMonthlyPrice('camera-material', paymentMonths);
                            const mensualiteInstallHT = installationOffered ? 0 : this.roundToFiveCents(this.getInstallationMonthlyPrice(installQty, paymentMonths));
                            const totalMensuelHT = mensualiteMatHT + mensualiteInstallHT + remoteAccessPrice;
                            const totalMensuelTTC = this.roundToFiveCents(totalMensuelHT * 1.081);
                            
                            document.getElementById('camera-monthly-amount').textContent = totalMensuelTTC.toFixed(2);
                            document.getElementById('camera-monthly-count').textContent = paymentMonths;
                            document.getElementById('camera-monthly-payment').style.display = 'block';
                            
                            const remoteMonthly = document.getElementById('camera-remote-monthly');
                            if (remoteMonthly) {
                                remoteMonthly.style.display = remoteAccess ? 'block' : 'none';
                            }
                        } else {
                            document.getElementById('camera-monthly-payment').style.display = 'none';
                        }
                    }
                    
                    document.getElementById('camera-total-ht').textContent = `${totalHT.toFixed(2)} CHF`;
                    document.getElementById('camera-total-ttc').textContent = `${totalTTC.toFixed(2)} CHF`;
                }
                
                else if (this.currentTab === 'fog') {
                    const materialTotal = this.calculateSectionTotal('fog-material');
                    const installationOffered = document.getElementById('fog-installation-offered')?.checked;
                    
                    const installationPrice = 490;
                    const installationTotal = installationOffered ? 0 : installationPrice;
                    
                    const totalHT = materialTotal + installationTotal;
                    const totalTTC = this.roundToFiveCents(totalHT * 1.081);
                    
                    document.getElementById('fog-material-total').textContent = `${materialTotal.toFixed(2)} CHF`;
                    document.getElementById('fog-installation-total').textContent = `${installationTotal.toFixed(2)} CHF`;
                    document.getElementById('fog-installation-price').textContent = installationOffered ? 'OFFERT' : `${installationTotal.toFixed(2)} CHF`;
                    
                    if (!this.rentalMode['fog']) {
                        const paymentMonths = this.globalPaymentMonths['fog'] || 0;
                        
                        if (paymentMonths > 0) {
                            const mensualiteMatHT = this.calculateSectionMonthlyPrice('fog-material', paymentMonths);
                            const totalMensuelHT = mensualiteMatHT;
                            const totalMensuelTTC = this.roundToFiveCents(totalMensuelHT * 1.081);
                            
                            document.getElementById('fog-monthly-amount').textContent = totalMensuelTTC.toFixed(2);
                            document.getElementById('fog-monthly-count').textContent = paymentMonths;
                            document.getElementById('fog-monthly-payment').style.display = 'block';
                        } else {
                            document.getElementById('fog-monthly-payment').style.display = 'none';
                        }
                    }
                    
                    document.getElementById('fog-total-ht').textContent = `${totalHT.toFixed(2)} CHF`;
                    document.getElementById('fog-total-ttc').textContent = `${totalTTC.toFixed(2)} CHF`;
                }
            }

            selectPayment(element, sectionId) {
                const tabType = sectionId.startsWith('alarm') ? 'alarm' : (sectionId.startsWith('camera') ? 'camera' : 'fog');
                if (this.rentalMode[tabType]) return;
                
                const parent = element.closest('.payment-options');
                parent.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                element.classList.add('active');
                
                const months = parseInt(element.getAttribute('data-months')) || 0;
                this.sections[sectionId] = { paymentMonths: months };
                
                this.updateTotals();
            }

            selectGlobalPayment(element, type) {
                if (this.rentalMode[type]) return;
                
                const parent = element.closest('.payment-options');
                parent.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                element.classList.add('active');
                
                const months = parseInt(element.getAttribute('data-months')) || 0;
                this.globalPaymentMonths[type] = months;
                
                this.updateTotals();
            }

            async saveToGoogleDrive(pdfBlob, filename, commercial) {
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5ehDpX2oQApL67S7MciOhFF1JIBvbvtypXfg7ijXVBSgz6clWvPrNEXww6_WtJIIVgw/exec';
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const base64 = reader.result.split(',')[1];
                        
                        try {
                            if (isIOS || isSafari) {
                                const formData = new FormData();
                                formData.append('data', JSON.stringify({
                                    pdfBase64: base64,
                                    filename: filename,
                                    commercial: commercial
                                }));
                                
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = GOOGLE_SCRIPT_URL;
                                form.target = 'hidden_iframe';
                                form.style.display = 'none';
                                
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'data';
                                input.value = JSON.stringify({
                                    pdfBase64: base64,
                                    filename: filename,
                                    commercial: commercial
                                });
                                
                                form.appendChild(input);
                                document.body.appendChild(form);
                                
                                let iframe = document.getElementById('hidden_iframe');
                                if (!iframe) {
                                    iframe = document.createElement('iframe');
                                    iframe.id = 'hidden_iframe';
                                    iframe.name = 'hidden_iframe';
                                    iframe.style.display = 'none';
                                    document.body.appendChild(iframe);
                                }
                                
                                form.submit();
                                
                                setTimeout(() => {
                                    document.body.removeChild(form);
                                }, 2000);
                                
                                console.log('PDF envoyé à Google Drive (iOS/Safari)');
                                resolve(true);
                                
                            } else {
                                const response = await fetch(GOOGLE_SCRIPT_URL, {
                                    method: 'POST',
                                    mode: 'no-cors',
                                    headers: {
                                        'Content-Type': 'text/plain',
                                    },
                                    body: JSON.stringify({
                                        pdfBase64: base64,
                                        filename: filename,
                                        commercial: commercial
                                    })
                                });
                                
                                console.log('PDF envoyé à Google Drive');
                                resolve(true);
                            }
                        } catch (error) {
                            console.error('Erreur lors de l\'envoi à Google Drive:', error);
                            
                            if (isIOS || isSafari) {
                                const params = encodeURIComponent(JSON.stringify({
                                    pdfBase64: base64.substring(0, 100) + '...',
                                    filename: filename,
                                    commercial: commercial,
                                    error: 'Upload depuis iOS'
                                }));
                                
                                generator.showIOSUploadButton(pdfBlob, filename, commercial);
                            }
                            reject(error);
                        }
                    };
                    reader.readAsDataURL(pdfBlob);
                });
            }
            
            showIOSUploadButton(pdfBlob, filename, commercial) {
                const existingBtn = document.getElementById('ios-upload-btn');
                if (existingBtn) existingBtn.remove();
                
                const uploadBtn = document.createElement('button');
                uploadBtn.id = 'ios-upload-btn';
                uploadBtn.className = 'btn btn-primary';
                uploadBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 10000;
                    padding: 15px 30px;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    border: none;
                    border-radius: 50px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
                `;
                uploadBtn.innerHTML = '☁️ Réessayer l\'upload vers Drive';
                
                uploadBtn.onclick = () => {
                    this.saveToGoogleDrive(pdfBlob, filename, commercial)
                        .then(() => {
                            this.showNotification('Upload réussi !');
                            uploadBtn.remove();
                        })
                        .catch(() => {
                            this.showNotification('Échec - Téléchargez manuellement');
                        });
                };
                
                document.body.appendChild(uploadBtn);
                
                setTimeout(() => {
                    if (document.getElementById('ios-upload-btn')) {
                        uploadBtn.remove();
                    }
                }, 30000);
            }

            generatePDF(type) {
                const isRental = this.rentalMode[type];
                let clientNameField, commercialField, commercialCustomField;
                
                if (type === 'alarm') {
                    clientNameField = 'clientName';
                    commercialField = 'commercial';
                    commercialCustomField = 'commercial-custom';
                } else if (type === 'camera') {
                    clientNameField = 'clientNameCamera';
                    commercialField = 'commercialCamera';
                    commercialCustomField = 'commercialCamera-custom';
                } else if (type === 'fog') {
                    clientNameField = 'clientNameFog';
                    commercialField = 'commercialFog';
                    commercialCustomField = 'commercialFog-custom';
                }
                
                const clientName = document.getElementById(clientNameField)?.value || 'Client';
                const commercialSelect = document.getElementById(commercialField)?.value;
                let commercial = '';
                
                if (commercialSelect === 'autre') {
                    commercial = document.getElementById(commercialCustomField)?.value || '';
                } else {
                    commercial = commercialSelect;
                }

                if (!commercial) {
                    alert('Veuillez sélectionner un commercial avant de générer le PDF.');
                    return;
                }

                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('Erreur: Bibliothèque PDF non disponible.');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('portrait', 'pt', 'a4');

                    doc.setFillColor(51, 51, 51);
                    doc.rect(0, 0, 595, 70, 'F');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(255, 255, 255);
                    
                    let title = '';
                    if (isRental) {
                        if (type === 'camera') {
                            title = 'OFFRE LOCATION VIDÉO SURVEILLANCE';
                        } else if (type === 'fog') {
                            title = 'OFFRE LOCATION GÉNÉRATEUR DE BROUILLARD';
                        } else {
                            title = 'OFFRE LOCATION MATÉRIEL DE SÉCURITÉ';
                        }
                    } else {
                        if (type === 'camera') {
                            title = 'OFFRE DE PARTENARIAT VIDÉOSURVEILLANCE';
                        } else if (type === 'fog') {
                            title = 'OFFRE DE PARTENARIAT GÉNÉRATEUR DE BROUILLARD';
                        } else {
                            title = 'OFFRE DE PARTENARIAT MATÉRIEL DE SÉCURITÉ';
                        }
                    }
                    doc.text(title, 40, 25);
                    
                    const now = new Date();
                    const quoteNumber = `DIA-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    doc.setFontSize(10);
                    doc.text(quoteNumber, 40, 42);
                    doc.text(`DIALARME | A L'ATTENTION DE ${clientName.toUpperCase()}`, 40, 56);

                    doc.setFillColor(244, 230, 0);
                    doc.rect(0, 70, 595, 6, 'F');

                    let yPos = 90;

                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`NOM DU CONSEILLER : ${commercial}`, 40, yPos);
                    doc.text(`DATE (Devis valable 30 jours) : ${new Date().toLocaleDateString('fr-CH')}`, 350, yPos);
                    yPos += 20;
                    
                    if (isRental) {
                        doc.setFont('helvetica', 'bold');
                        doc.text('MODE LOCATION - Pas de mensualités de paiement', 40, yPos);
                        yPos += 20;
                    }

                    if (type === 'alarm') {
                        yPos = this.createPDFSection(doc, 'KIT DE BASE', 'alarm-material', yPos);

                        yPos = this.createPDFSection(doc, 'INSTALLATION & MATERIEL SUPPLEMENTAIRE', 'alarm-installation', yPos);
                        yPos = this.createAdminFeesPDF(doc, yPos);
                        yPos = this.createServicesPDF(doc, yPos);

                    } else if (type === 'camera') {
                        if (this.hasSectionProducts('camera-material')) {
                            yPos = this.createPDFSection(doc, 'MATERIEL', 'camera-material', yPos);
                        }

                        yPos = this.createCameraInstallPDF(doc, yPos);

                        if (!isRental) {
                            const remoteAccess = document.getElementById('camera-remote-access')?.checked;
                            if (remoteAccess) {
                                yPos += 15;
                                doc.setFont('helvetica', 'normal');
                                doc.setFontSize(8);
                                doc.text('Vision à distance : 20.00 CHF/mois', 40, yPos);
                                yPos += 15;
                            }
                        }
                    } else if (type === 'fog') {
                        if (this.hasSectionProducts('fog-material')) {
                            yPos = this.createPDFSection(doc, 'MATERIEL', 'fog-material', yPos);
                        }

                        yPos = this.createFogInstallPDF(doc, yPos);
                    }

                    yPos = this.createFinalSummaryPDF(doc, yPos, type, isRental);
                    this.createPDFFooter(doc, clientName);

                    this.showNotification('PDF généré avec succès!');
                    
                    const filename = `Devis-${quoteNumber}-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                    
                    const pdfBlob = doc.output('blob');
                    
                    this.saveToGoogleDrive(pdfBlob, filename, commercial)
                        .then(() => {
                            this.showNotification('PDF généré et sauvegardé sur Google Drive!');
                        })
                        .catch(error => {
                            console.error('Erreur Google Drive:', error);
                            this.showNotification('PDF généré (sauvegarde Drive échouée)');
                        });
                    
                    doc.save(filename);
                    
                } catch (error) {
                    console.error('Erreur PDF:', error);
                    alert(`Erreur lors de la génération du PDF: ${error.message}`);
                }
            }

            hasSectionProducts(sectionId) {
                const container = document.getElementById(`${sectionId}-products`);
                if (!container) return false;
                const productLines = container.querySelectorAll('.product-line');
                let hasProducts = false;
                productLines.forEach(line => {
                    const select = line.querySelector('.product-select');
                    if (select && select.value) hasProducts = true;
                });
                return hasProducts;
            }

            createPDFSection(doc, title, sectionId, yPos) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(title, 40, yPos);
                yPos += 12;

                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 14, 'F');
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(7);
                doc.setTextColor(0, 0, 0);
                doc.text('Qté', 50, yPos + 9);
                doc.text('Désignation du matériel', 120, yPos + 9);
                doc.text('Prix uni. HT', 400, yPos + 9);
                doc.text('Total HT', 480, yPos + 9);
                yPos += 14;

                const container = document.getElementById(`${sectionId}-products`);
                const productLines = container ? Array.from(container.querySelectorAll('.product-line')) : [];
                let sectionTotal = 0;
                let sectionTotalWithOffert = 0;
                let lineCount = 0;
                
                productLines.forEach(line => {
                    const select = line.querySelector('.product-select');
                    const qtyInput = line.querySelector('.quantity-input');
                    const offeredCheckbox = line.querySelector('.offered-checkbox');
                    const priceInput = line.querySelector('.price-input');
                    
                    const isCentralLine = line.classList.contains('central-line');
                    const isKitLine = line.style.background === 'rgb(255, 251, 240)' || line.style.background === '#fffbf0';
                    
                    if ((select && select.value && qtyInput) || (isCentralLine && qtyInput) || (line.querySelector('.price-input') && qtyInput)) {
                        lineCount++;
                        
                        if (isKitLine) {
                            doc.setFillColor(255, 251, 240);
                            doc.rect(40, yPos, 515, 12, 'F');
                        } else if (lineCount % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(40, yPos, 515, 12, 'F');
                        }

                        const qty = parseFloat(qtyInput.value) || 0;
                        const isOffered = offeredCheckbox?.checked || false;
                        
                        let price = 0;
                        let productName = '';
                        
                        const selectedOption = select?.querySelector(`option[value="${select.value}"]`);
                        const nameInput = line.querySelector('.product-name-input');
                        
                        if (nameInput && nameInput.style.display !== 'none' && nameInput.value) {
                            productName = nameInput.value;
                            price = parseFloat(priceInput?.value) || 0;
                        } else if (priceInput && priceInput.style.display !== 'none') {
                            price = parseFloat(priceInput.value) || 0;
                            productName = selectedOption?.text?.split(' - ')[0] || 'Produit personnalisé';
                        } else if (selectedOption) {
                            price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                            productName = selectedOption.text.split(' - ')[0] || '';
                        } else if (priceInput) {
                            productName = line.querySelector('div')?.textContent || '';
                            price = parseFloat(priceInput.value) || 0;
                        }
                        
                        let lineTotal = price * qty;
                        sectionTotalWithOffert += lineTotal;
                        if (!isOffered) {
                            sectionTotal += lineTotal;
                        }

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(6);
                        doc.setTextColor(0, 0, 0);
                        doc.text(qty.toString(), 55, yPos + 8);
                        
                        const maxNameLength = 45;
                        const displayName = productName.length > maxNameLength 
                            ? productName.substring(0, maxNameLength - 3) + '...' 
                            : productName;
                        doc.text(displayName, 90, yPos + 8);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(price.toFixed(2), 405, yPos + 8);
                        
                        if (isOffered) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(0, 150, 0);
                            doc.text('OFFERT', 485, yPos + 8);
                            doc.setFont('helvetica', 'normal');
                        } else {
                            doc.setTextColor(0, 0, 0);
                            doc.text(lineTotal.toFixed(2), 485, yPos + 8);
                        }
                        doc.setTextColor(0, 0, 0);
                        yPos += 12;
                    }
                });

                if (sectionId === 'alarm-installation') {
                    lineCount++;
                    if (lineCount % 2 === 0) {
                        doc.setFillColor(245, 245, 245);
                        doc.rect(40, yPos, 515, 12, 'F');
                    }
                    
                    const installQty = parseFloat(document.getElementById('alarm-installation-qty')?.value) || 1;
                    const installPrice = this.calculateInstallationPrice(installQty);
                    const installOffered = document.getElementById('alarm-installation-offered')?.checked || false;
                    const installTotal = installOffered ? 0 : installPrice;
                    
                    let daysText = '';
                    if (installQty === 1) daysText = ' (1/2 journée)';
                    else if (installQty === 2) daysText = ' (1 jour)';
                    else if (installQty === 3) daysText = ' (1.5 jours)';
                    else if (installQty === 4) daysText = ' (2 jours)';
                    else if (installQty === 5) daysText = ' (2.5 jours)';
                    else if (installQty === 6) daysText = ' (3 jours)';
                    else {
                        const fullDays = Math.floor(installQty / 2);
                        const halfDay = installQty % 2;
                        daysText = halfDay ? ` (${fullDays}.5 jours)` : ` (${fullDays} jours)`;
                    }
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6);
                    doc.text(installQty.toString(), 55, yPos + 8);
                    doc.text('Installation, paramétrages, tests, mise en service & formation' + daysText, 90, yPos + 8);
                    
                    if (installOffered) {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 150, 0);
                        doc.text('OFFERT', 405, yPos + 8);
                        doc.text('OFFERT', 485, yPos + 8);
                    } else {
                        doc.setTextColor(0, 0, 0);
                        doc.text(installPrice.toFixed(2), 405, yPos + 8);
                        doc.text(installTotal.toFixed(2), 485, yPos + 8);
                    }
                    
                    sectionTotal += installTotal;
                    yPos += 12;
                }

                const discountType = document.getElementById(`${sectionId}-discount-type`)?.value || 'percent';
                const discountValue = parseFloat(document.getElementById(`${sectionId}-discount-value`)?.value) || 0;
                
                if (discountValue > 0) {
                    if (discountType === 'percent') {
                        sectionTotal = sectionTotal * (1 - discountValue / 100);
                    } else {
                        sectionTotal = Math.max(0, sectionTotal - discountValue);
                    }
                }

                const totalTTC = this.roundToFiveCents(sectionTotal * 1.081);
                const tva = totalTTC - sectionTotal;

                doc.setFillColor(230, 230, 230);
                doc.rect(390, yPos, 165, 36, 'F');

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(7);
                doc.text('Total H.T.', 400, yPos + 8);
                doc.text(sectionTotal.toFixed(2), 485, yPos + 8);
                doc.text('TVA 8.1%', 400, yPos + 20);
                doc.text(tva.toFixed(2), 485, yPos + 20);
                doc.text('Total T.T.C.', 400, yPos + 32);
                doc.text(totalTTC.toFixed(2), 485, yPos + 32);

                yPos += 40;

                return yPos + 5;
            }

            createServicesPDF(doc, yPos) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('SERVICES', 40, yPos);
                yPos += 12;

                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 14, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(7);
                doc.setTextColor(0, 0, 0);
                doc.text('Service', 120, yPos + 9);
                doc.text('Prix', 400, yPos + 9);
                doc.text('Total', 480, yPos + 9);
                yPos += 14;

                const testCycliqueSelected = document.getElementById('test-cyclique-selected')?.checked || false;
                const testCycliquePrice = parseFloat(document.getElementById('test-cyclique-price')?.value) || 0;
                const testCycliqueOffered = document.getElementById('test-cyclique-offered')?.checked || false;
                
                if (testCycliqueSelected) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(40, yPos, 515, 12, 'F');
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6);
                    doc.text('Test Cyclique', 90, yPos + 8);
                    
                    if (testCycliqueOffered) {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 150, 0);
                        doc.text('OFFERT', 405, yPos + 8);
                        doc.text('OFFERT', 485, yPos + 8);
                    } else {
                        doc.setTextColor(0, 0, 0);
                        doc.text(testCycliquePrice.toFixed(2), 405, yPos + 8);
                        doc.text(testCycliquePrice.toFixed(2), 485, yPos + 8);
                    }
                    yPos += 12;
                }
                
                const surveillanceType = document.getElementById('surveillance-type')?.value;
                const surveillancePrice = parseFloat(document.getElementById('surveillance-price')?.value) || 0;
                const surveillanceOffered = document.getElementById('surveillance-offered')?.checked || false;
                
                if (surveillanceType) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6);
                    doc.setTextColor(0, 0, 0);
                    
                    let serviceName = '';
                    if (surveillanceType === 'telesurveillance') {
                        serviceName = 'Télésurveillance Particulier';
                    } else if (surveillanceType === 'telesurveillance-pro') {
                        serviceName = 'Télésurveillance Professionnel';
                    } else if (surveillanceType === 'autosurveillance') {
                        serviceName = 'Autosurveillance';
                    }
                    
                    doc.text(serviceName, 90, yPos + 8);
                    
                    if (surveillanceOffered) {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 150, 0);
                        doc.text('OFFERT', 405, yPos + 8);
                        doc.text('OFFERT', 485, yPos + 8);
                    } else {
                        doc.setTextColor(0, 0, 0);
                        doc.text(`${surveillancePrice.toFixed(2)}/mois`, 405, yPos + 8);
                        doc.text(`${surveillancePrice.toFixed(2)}/mois`, 485, yPos + 8);
                    }
                    yPos += 12;
                }

                return yPos + 5;
            }

            createAdminFeesPDF(doc, yPos) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('FRAIS DE DOSSIER (UNIQUE)', 40, yPos);
                yPos += 15;

                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 16, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text('Qté', 50, yPos + 10);
                doc.text('Description', 120, yPos + 10);
                doc.text('Prix uni. HT', 400, yPos + 10);
                doc.text('Total HT', 480, yPos + 10);
                yPos += 16;

                const adminItems = [
                    { qty: 1, desc: 'Carte SIM + Activation', price: 50 },
                    { qty: 1, desc: 'Frais de dossier', price: 190 }
                ];

                adminItems.forEach(item => {
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.rect(40, yPos, 515, 14);
                    doc.line(80, yPos, 80, yPos + 14);
                    doc.line(390, yPos, 390, yPos + 14);
                    doc.line(470, yPos, 470, yPos + 14);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text(item.qty.toString(), 55, yPos + 9);
                    doc.text(item.desc, 90, yPos + 9);
                    doc.text(item.price.toFixed(2), 405, yPos + 9);
                    doc.text(item.price.toFixed(2), 485, yPos + 9);
                    yPos += 14;
                });

                const adminTotalTTC = this.roundToFiveCents(240 * 1.081);
                const adminTVA = adminTotalTTC - 240;

                doc.setFillColor(200, 200, 200);
                doc.rect(390, yPos, 165, 42, 'F');
                doc.rect(390, yPos, 165, 42);
                doc.line(390, yPos + 14, 555, yPos + 14);
                doc.line(390, yPos + 28, 555, yPos + 28);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text('Total H.T.', 400, yPos + 9);
                doc.text('240.00', 485, yPos + 9);
                doc.text('TVA 8.1%', 400, yPos + 23);
                doc.text(adminTVA.toFixed(2), 485, yPos + 23);
                doc.text('Total T.T.C.', 400, yPos + 37);
                doc.text(adminTotalTTC.toFixed(2), 485, yPos + 37);

                yPos += 50;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('Montant à régler à l\'installation', 40, yPos);

                return yPos + 15;
            }

            createCameraInstallPDF(doc, yPos) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('INSTALLATION', 40, yPos);
                yPos += 15;

                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 16, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text('Qté', 50, yPos + 10);
                doc.text('Désignation', 120, yPos + 10);
                doc.text('Prix uni. HT', 400, yPos + 10);
                doc.text('Total HT', 480, yPos + 10);
                yPos += 16;

                const installOffered = document.getElementById('camera-installation-offered')?.checked || false;
                const installPrice = this.calculateCameraInstallationPrice();
                const installTotal = installOffered ? 0 : installPrice;
                
                const installQty = parseFloat(document.getElementById('camera-installation-qty')?.value) || 1;
                let description = '';
                
                let daysText = '';
                if (installQty === 1) daysText = ' (1/2 journée)';
                else if (installQty === 2) daysText = ' (1 jour)';
                else if (installQty === 3) daysText = ' (1.5 jours)';
                else if (installQty === 4) daysText = ' (2 jours)';
                else if (installQty === 5) daysText = ' (2.5 jours)';
                else if (installQty === 6) daysText = ' (3 jours)';
                else {
                    const fullDays = Math.floor(installQty / 2);
                    const halfDay = installQty % 2;
                    daysText = halfDay ? ` (${fullDays}.5 jours)` : ` (${fullDays} jours)`;
                }
                description = 'Installation, paramétrages, tests, mise en service & formation' + daysText;

                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(40, yPos, 515, 14);
                doc.line(80, yPos, 80, yPos + 14);
                doc.line(390, yPos, 390, yPos + 14);
                doc.line(470, yPos, 470, yPos + 14);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('1', 55, yPos + 9);
                doc.text(description, 90, yPos + 9);
                
                if (installOffered) {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 150, 0);
                    doc.text('OFFERT', 405, yPos + 9);
                    doc.text('OFFERT', 485, yPos + 9);
                } else {
                    doc.setTextColor(0, 0, 0);
                    doc.text(installPrice.toFixed(2), 405, yPos + 9);
                    doc.text(installTotal.toFixed(2), 485, yPos + 9);
                }
                yPos += 14;

                const installTotalTTC = this.roundToFiveCents(installTotal * 1.081);
                const installTVA = installTotalTTC - installTotal;

                doc.setFillColor(200, 200, 200);
                doc.rect(390, yPos, 165, 42, 'F');
                doc.rect(390, yPos, 165, 42);
                doc.line(390, yPos + 14, 555, yPos + 14);
                doc.line(390, yPos + 28, 555, yPos + 28);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text('Total H.T.', 400, yPos + 9);
                doc.text(installTotal.toFixed(2), 485, yPos + 9);
                doc.text('TVA 8.1%', 400, yPos + 23);
                doc.text(installTVA.toFixed(2), 485, yPos + 23);
                doc.text('Total T.T.C.', 400, yPos + 37);
                doc.text(installTotalTTC.toFixed(2), 485, yPos + 37);

                return yPos + 55;
            }

            createFogInstallPDF(doc, yPos) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('INSTALLATION', 40, yPos);
                yPos += 15;

                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 16, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text('Qté', 50, yPos + 10);
                doc.text('Désignation', 120, yPos + 10);
                doc.text('Prix uni. HT', 400, yPos + 10);
                doc.text('Total HT', 480, yPos + 10);
                yPos += 16;

                const installOffered = document.getElementById('fog-installation-offered')?.checked || false;
                
                const installPrice = 490;
                const description = 'Installation, paramétrages, tests, mise en service & formation';
                
                const installTotal = installOffered ? 0 : installPrice;

                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(40, yPos, 515, 14);
                doc.line(80, yPos, 80, yPos + 14);
                doc.line(390, yPos, 390, yPos + 14);
                doc.line(470, yPos, 470, yPos + 14);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('1', 55, yPos + 9);
                doc.text(description, 90, yPos + 9);
                
                if (installOffered) {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 150, 0);
                    doc.text('OFFERT', 405, yPos + 9);
                    doc.text('OFFERT', 485, yPos + 9);
                } else {
                    doc.setTextColor(0, 0, 0);
                    doc.text(installPrice.toFixed(2), 405, yPos + 9);
                    doc.text(installTotal.toFixed(2), 485, yPos + 9);
                }
                yPos += 14;
                
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.text('* Installation uniquement au comptant (non mensualisée)', 90, yPos + 5);
                yPos += 10;

                const installTotalTTC = this.roundToFiveCents(installTotal * 1.081);
                const installTVA = installTotalTTC - installTotal;

                doc.setFillColor(200, 200, 200);
                doc.rect(390, yPos, 165, 42, 'F');
                doc.rect(390, yPos, 165, 42);
                doc.line(390, yPos + 14, 555, yPos + 14);
                doc.line(390, yPos + 28, 555, yPos + 28);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text('Total H.T.', 400, yPos + 9);
                doc.text(installTotal.toFixed(2), 485, yPos + 9);
                doc.text('TVA 8.1%', 400, yPos + 23);
                doc.text(installTVA.toFixed(2), 485, yPos + 23);
                doc.text('Total T.T.C.', 400, yPos + 37);
                doc.text(installTotalTTC.toFixed(2), 485, yPos + 37);

                return yPos + 55;
            }

            createFinalSummaryPDF(doc, yPos, type, isRental) {
                yPos += 15;
                
                doc.setFillColor(244, 230, 0);
                doc.rect(40, yPos, 515, 16, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text('RÉCAPITULATIF GÉNÉRAL', 50, yPos + 10);
                yPos += 16;

                let totalMensualitesHT = 0;
                let totalComptantHT = 0;
                let monthsCount = 0;
                let surveillanceMonthlyHT = 0;
                
                if (type === 'alarm') {
                    const materialTotal = this.calculateSectionTotal('alarm-material');
                    
                    const installQty = parseFloat(document.getElementById('alarm-installation-qty')?.value) || 1;
                    const installPrice = this.calculateInstallationPrice(installQty);
                    const installOffered = document.getElementById('alarm-installation-offered')?.checked || false;
                    const installTotal = installOffered ? 0 : installPrice;
                    const otherInstallationTotal = this.calculateSectionTotal('alarm-installation');
                    const totalInstallation = installTotal + otherInstallationTotal;
                    
                    const adminTotal = 240;
                    
                    const paymentMonths = this.globalPaymentMonths['alarm'] || 0;
                    
                    const surveillanceType = document.getElementById('surveillance-type')?.value;
                    const surveillancePrice = parseFloat(document.getElementById('surveillance-price')?.value) || 0;
                    const surveillanceOffered = document.getElementById('surveillance-offered')?.checked;
                    surveillanceMonthlyHT = surveillanceType && !surveillanceOffered ? surveillancePrice : 0;
                    
                    if (paymentMonths > 0) {
                        totalMensualitesHT = materialTotal + totalInstallation;
                        monthsCount = paymentMonths;
                    } else {
                        totalComptantHT = materialTotal + totalInstallation;
                    }
                    
                    totalComptantHT += adminTotal;
                    
                } else if (type === 'camera') {
                    const materialTotal = this.calculateSectionTotal('camera-material');
                    const installOffered = document.getElementById('camera-installation-offered')?.checked || false;
                    const installPrice = this.calculateCameraInstallationPrice();
                    const installTotal = installOffered ? 0 : installPrice;
                    const paymentMonths = this.globalPaymentMonths['camera'] || 0;
                    
                    if (paymentMonths > 0) {
                        totalMensualitesHT = materialTotal + installTotal;
                        monthsCount = paymentMonths;
                    } else {
                        totalComptantHT = materialTotal + installTotal;
                    }
                    
                    if (!isRental) {
                        const remoteAccess = document.getElementById('camera-remote-access')?.checked;
                        if (remoteAccess) {
                            surveillanceMonthlyHT = 20;
                        }
                    }
                } else if (type === 'fog') {
                    const materialTotal = this.calculateSectionTotal('fog-material');
                    const installOffered = document.getElementById('fog-installation-offered')?.checked || false;
                    
                    const installPrice = 490;
                    const installTotal = installOffered ? 0 : installPrice;
                    
                    const paymentMonths = this.globalPaymentMonths['fog'] || 0;
                    
                    if (paymentMonths > 0) {
                        totalMensualitesHT = materialTotal;
                        monthsCount = paymentMonths;
                        
                        totalComptantHT = installTotal;
                    } else {
                        totalComptantHT = materialTotal + installTotal;
                    }
                }

                if (!isRental && monthsCount > 0 && totalMensualitesHT > 0) {
                    let mensualiteMatHT = 0;
                    let mensualiteInstallHT = 0;
                    
                    if (type === 'alarm') {
                        const installQty = parseFloat(document.getElementById('alarm-installation-qty')?.value) || 1;
                        const installOffered = document.getElementById('alarm-installation-offered')?.checked || false;
                        
                        mensualiteMatHT = this.calculateSectionMonthlyPrice('alarm-material', monthsCount);
                        mensualiteInstallHT = installOffered ? 0 : this.roundToFiveCents(this.getInstallationMonthlyPrice(installQty, monthsCount));
                        
                        const otherInstallMensualite = this.calculateSectionMonthlyPrice('alarm-installation', monthsCount);
                        mensualiteMatHT += otherInstallMensualite;
                    } else if (type === 'camera') {
                        const installQty = parseFloat(document.getElementById('camera-installation-qty')?.value) || 1;
                        const installOffered = document.getElementById('camera-installation-offered')?.checked || false;
                        
                        mensualiteMatHT = this.calculateSectionMonthlyPrice('camera-material', monthsCount);
                        mensualiteInstallHT = installOffered ? 0 : this.roundToFiveCents(this.getInstallationMonthlyPrice(installQty, monthsCount));
                    } else if (type === 'fog') {
                        mensualiteMatHT = this.calculateSectionMonthlyPrice('fog-material', monthsCount);
                        mensualiteInstallHT = 0;
                    }
                    
                    const totalMensuelHT = mensualiteMatHT + mensualiteInstallHT + surveillanceMonthlyHT;
                    const totalMensuelTVA = totalMensuelHT * 0.081;
                    const totalMensuelTTC = this.roundToFiveCents(totalMensuelHT * 1.081);

                    doc.setFillColor(200, 200, 200);
                    doc.rect(40, yPos, 515, 110, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(40, yPos, 515, 110);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text('MENSUALITÉS GLOBALES (' + monthsCount + ' mois)', 50, yPos + 15);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(`Matériel: ${mensualiteMatHT.toFixed(2)} CHF HT/mois`, 50, yPos + 35);
                    doc.text(`Installation: ${mensualiteInstallHT.toFixed(2)} CHF HT/mois`, 50, yPos + 50);
                    
                    if (surveillanceMonthlyHT > 0) {
                        const serviceName = type === 'alarm' ? 
                            (document.getElementById('surveillance-type')?.value === 'telesurveillance' ? 'Télésurveillance' : 'Autosurveillance') : 
                            'Vision à distance';
                        doc.text(`${serviceName}: ${surveillanceMonthlyHT.toFixed(2)} CHF HT/mois`, 50, yPos + 65);
                        doc.text(`Total mensualité HT: ${totalMensuelHT.toFixed(2)} CHF`, 50, yPos + 80);
                    } else {
                        doc.text(`Total mensualité HT: ${totalMensuelHT.toFixed(2)} CHF`, 50, yPos + 65);
                    }
                    
                    doc.text(`TVA 8.1%: ${totalMensuelTVA.toFixed(2)} CHF`, 300, yPos + (surveillanceMonthlyHT > 0 ? 80 : 65));
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text(`TOTAL MENSUALITÉ TTC: ${totalMensuelTTC.toFixed(2)} CHF/mois x ${monthsCount} mois`, 50, yPos + 100);
                    
                    yPos += 115;
                    
                    if (totalComptantHT > 0) {
                        doc.setFillColor(200, 200, 200);
                        doc.rect(40, yPos, 515, 55, 'F');
                        doc.setDrawColor(0, 0, 0);
                        doc.rect(40, yPos, 515, 55);
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(9);
                        doc.text('MONTANT À RÉGLER COMPTANT', 50, yPos + 15);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(8);
                        doc.text(`Total HT: ${totalComptantHT.toFixed(2)} CHF`, 50, yPos + 30);
                        const comptantTVA = totalComptantHT * 0.081;
                        const comptantTTC = this.roundToFiveCents(totalComptantHT * 1.081);
                        doc.text(`TVA 8.1%: ${comptantTVA.toFixed(2)} CHF`, 250, yPos + 30);
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Total TTC: ${comptantTTC.toFixed(2)} CHF`, 400, yPos + 30);
                        
                        yPos += 60;
                    }
                    
                } else {
                    const totalTVA = totalComptantHT * 0.081;
                    const totalTTC = this.roundToFiveCents(totalComptantHT * 1.081);
                    
                    doc.setFillColor(200, 200, 200);
                    doc.rect(40, yPos, 515, 55, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(40, yPos, 515, 55);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    if (isRental) {
                        doc.text('MONTANT TOTAL LOCATION (PAIEMENT COMPTANT)', 50, yPos + 15);
                    } else {
                        doc.text('MONTANT TOTAL (PAIEMENT COMPTANT)', 50, yPos + 15);
                    }
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(`Total HT: ${totalComptantHT.toFixed(2)} CHF`, 50, yPos + 30);
                    doc.text(`TVA 8.1%: ${totalTVA.toFixed(2)} CHF`, 250, yPos + 30);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Total TTC: ${totalTTC.toFixed(2)} CHF`, 400, yPos + 30);
                    
                    yPos += 60;
                }

                if (!isRental && monthsCount > 0) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;
                    doc.text(`Nous demandons à nos abonnés la signature d'un contrat de ${monthsCount} mois par habitation.`, 80, yPos);
                    yPos += 12;
                    doc.text(`La mensualité est fixée et non indexable pendant la durée contractuelle.`, 80, yPos);
                    yPos += 15;
                }

                return yPos;
            }

            createPDFFooter(doc, clientName) {
                doc.setFillColor(51, 51, 51);
                doc.rect(0, 720, 595, 122, 'F');
                
                doc.setFillColor(244, 230, 0);
                doc.rect(0, 720, 595, 6, 'F');

                doc.setFillColor(255, 255, 255);
                doc.rect(50, 745, 200, 25, 'F');
                doc.rect(350, 745, 200, 60, 'F');
                doc.rect(50, 780, 200, 25, 'F');

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text(`NOM DU CLIENT : ${clientName}`, 60, 760);
                doc.text('SIGNATURE DU CLIENT', 430, 735);
                doc.text('DATE DE SIGNATURE :', 60, 795);
            }

            exportQuote() {
                const quote = {
                    timestamp: new Date().toISOString(),
                    type: this.currentTab,
                    isRental: this.rentalMode[this.currentTab],
                    sections: this.sections
                };
                
                const dataStr = JSON.stringify(quote, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `devis-${this.currentTab}-${this.rentalMode[this.currentTab] ? 'location' : 'vente'}-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.showNotification('Devis exporté avec succès!');
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        let generator;

        function showTab(tabName, element) {
            generator.showTab(tabName, element);
        }

        function toggleRentalMode(type) {
            generator.toggleRentalMode(type);
        }

        function updateAlarmInstallationPrice() {
            generator.updateAlarmInstallationPrice();
        }

        function updateCameraInstallationPrice() {
            generator.updateCameraInstallationPrice();
        }

        function updateSurveillancePrice() {
            generator.updateSurveillancePrice();
        }

        function generatePDF(type) {
            generator.generatePDF(type);
        }

        function exportQuote() {
            generator.exportQuote();
        }

        function selectPayment(element, sectionId) {
            generator.selectPayment(element, sectionId);
        }

        function selectGlobalPayment(element, type) {
            generator.selectGlobalPayment(element, type);
        }

        function addProductLine(sectionId) {
            generator.addProductLine(sectionId);
        }

        function handleProductSelection(selectElement) {
            generator.handleProductSelection(selectElement);
        }

        function updateTotals() {
            generator.updateTotals();
        }

        function showKitSelector() {
            generator.showKitSelector();
        }

        function handleCommercialSelection(selectElement) {
            const customInput = document.getElementById('commercial-custom');
            if (selectElement.value === 'autre') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        function handleCommercialSelectionCamera(selectElement) {
            const customInput = document.getElementById('commercialCamera-custom');
            if (selectElement.value === 'autre') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        function handleCommercialSelectionFog(selectElement) {
            const customInput = document.getElementById('commercialFog-custom');
            if (selectElement.value === 'autre') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            generator = new DialarmeFinalGenerator();
        });

        function openCatalogModal() {
            generator.renderCatalogModal();
            document.getElementById('catalogModal').classList.add('active');
        }

        function closeCatalogModal() {
            document.getElementById('catalogModal').classList.remove('active');
        }

        function showCatalogTab(tabName) {
            document.querySelectorAll('.catalog-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.catalog-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleAlarmCashOnly(index, type, checked) {
            const tbody = type === 'titane' ? 'alarm-titane-body' : 'alarm-jablotron-body';
            const rows = document.querySelectorAll(`#${tbody} tr`);
            
            // Trouver la bonne ligne par l'index
            let targetRow = null;
            rows.forEach(row => {
                const rowIndex = parseInt(row.querySelector('input[data-index]').getAttribute('data-index'));
                if (rowIndex === index) targetRow = row;
            });
            
            if (targetRow) {
                const monthlyInput = targetRow.querySelector(`input[data-field="monthly${type === 'titane' ? 'Titane' : 'Jablotron'}"]`);
                if (monthlyInput) {
                    monthlyInput.disabled = checked;
                    if (checked) monthlyInput.value = '';
                }
            }
        }

        function toggleCameraCashOnly(index, checked) {
            const row = document.querySelectorAll('#camera-products-body tr')[index];
            const monthlyInputs = row.querySelectorAll('input[data-field^="monthly"]');
            
            monthlyInputs.forEach(input => {
                input.disabled = checked;
                if (checked) input.value = '';
            });
        }

        function toggleFogCashOnly(index, checked) {
            const row = document.querySelectorAll('#fog-products-body tr')[index];
            const monthlyInput = row.querySelector('input[data-field="monthly"]');
            
            monthlyInput.disabled = checked;
            if (checked) monthlyInput.value = '';
        }

        function deleteAlarmProduct(index, type) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
                const products = generator.catalog['alarm-material'].filter(p => !p.isCustom);
                const product = products[index];
                
                // Si le produit est dans les deux catalogues, on supprime seulement la partie correspondante
                if (type === 'titane' && product.priceJablotron !== undefined) {
                    // Le produit existe aussi pour Jablotron, on supprime juste la partie Titane
                    delete product.priceTitane;
                    delete product.monthlyTitane;
                    if (!product.price) product.price = product.priceJablotron;
                } else if (type === 'jablotron' && product.priceTitane !== undefined) {
                    // Le produit existe aussi pour Titane, on supprime juste la partie Jablotron
                    delete product.priceJablotron;
                    delete product.monthlyJablotron;
                    delete product.requiresJablotron;
                    if (!product.price) product.price = product.priceTitane;
                } else {
                    // Le produit n'existe que pour ce type, on le supprime complètement
                    products.splice(index, 1);
                }
                
                generator.renderAlarmProducts();
            }
        }

        function deleteCameraProduct(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
                const products = generator.catalog['camera-material'].filter(p => !p.isCustom);
                products.splice(index, 1);
                generator.renderCameraProducts();
            }
        }

        function deleteFogProduct(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
                const products = generator.catalog['fog-material'].filter(p => !p.isCustom);
                products.splice(index, 1);
                generator.renderFogProducts();
            }
        }

        function deleteCommercial(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce commercial ?')) {
                generator.commercialsList.splice(index, 1);
                generator.renderCommercials();
            }
        }

        function addNewAlarmProduct(type) {
            const products = generator.catalog['alarm-material'].filter(p => !p.isCustom);
            const maxId = Math.max(...products.map(p => p.id), 100);
            
            const newProduct = {
                id: maxId + 1,
                name: "Nouveau produit",
            };
            
            if (type === 'titane') {
                newProduct.priceTitane = 0;
                newProduct.monthlyTitane = 0;
            } else {
                newProduct.priceJablotron = 0;
                newProduct.monthlyJablotron = 0;
                newProduct.requiresJablotron = true;
            }
            
            products.push(newProduct);
            generator.renderAlarmProducts();
        }

        function addNewCameraProduct() {
            const products = generator.catalog['camera-material'].filter(p => !p.isCustom);
            const maxId = Math.max(...products.map(p => p.id));
            
            products.push({
                id: maxId + 1,
                name: "Nouveau produit",
                price: 0,
                monthly48: 0,
                monthly36: 0,
                monthly24: 0
            });
            
            generator.renderCameraProducts();
        }

        function addNewFogProduct() {
            const products = generator.catalog['fog-material'].filter(p => !p.isCustom);
            const maxId = Math.max(...products.map(p => p.id));
            
            products.push({
                id: maxId + 1,
                name: "Nouveau produit",
                price: 0,
                monthly: 0
            });
            
            generator.renderFogProducts();
        }

        function addNewCommercial() {
            generator.commercialsList.push("Nouveau commercial");
            generator.renderCommercials();
        }

        function saveCatalog() {
            const data = generator.collectCatalogData();
            
            if (!generator.validateCatalogData(data)) {
                return;
            }
            
            generator.applyCatalogChanges(data);
            generator.showNotification('Catalogue sauvegardé avec succès !');
            closeCatalogModal();
        }

        function resetCatalog() {
            if (confirm('Êtes-vous sûr de vouloir réinitialiser le catalogue aux valeurs par défaut ? Toutes vos modifications seront perdues.')) {
                localStorage.removeItem('dialarme_catalog');
                localStorage.removeItem('dialarme_commercials');
                localStorage.removeItem('dialarme_centrales');
                location.reload();
            }
        }

        function addNewCentrale() {
            const maxId = Math.max(...generator.centralesConfig.map(c => parseInt(c.id.match(/\d+/) || 0)), 0);
            generator.centralesConfig.push({
                id: `centrale${maxId + 1}`,
                name: 'Nouvelle Centrale',
                productId: 1000 + maxId,
                price: 0,
                kits: [
                    {
                        name: 'Kit de base',
                        products: []
                    }
                ]
            });
            generator.renderCentrales();
        }

        function deleteCentrale(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette centrale et tous ses kits ?')) {
                generator.centralesConfig.splice(index, 1);
                generator.renderCentrales();
            }
        }

        function addKitToCentrale(centraleIndex) {
            generator.centralesConfig[centraleIndex].kits.push({
                name: 'Nouveau kit',
                products: []
            });
            generator.renderKits(centraleIndex);
        }

        function deleteKit(centraleIndex, kitIndex) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce kit ?')) {
                generator.centralesConfig[centraleIndex].kits.splice(kitIndex, 1);
                generator.renderKits(centraleIndex);
            }
        }

        function addProductToKit(centraleIndex, kitIndex) {
            generator.centralesConfig[centraleIndex].kits[kitIndex].products.push({
                id: 0,
                quantity: 1
            });
            generator.renderKitProducts(centraleIndex, kitIndex);
        }

        function deleteKitProduct(centraleIndex, kitIndex, productIndex) {
            generator.centralesConfig[centraleIndex].kits[kitIndex].products.splice(productIndex, 1);
            generator.renderKitProducts(centraleIndex, kitIndex);
        }
    </script>
</body>
</html>
