<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="G√©n√©rateur de devis pour syst√®mes d'alarme et cam√©ras de surveillance">
    <meta name="author" content="Votre Entreprise">
    <title>G√©n√©rateur de Devis - Alarme & Surveillance</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîê</text></svg>">
    
    <!-- PWA Support -->
    <meta name="theme-color" content="#f4e600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Devis Alarme">
    
    <!-- Preload important resources -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    
    <style>
        /* Variables CSS - Th√®me Noir et Jaune */
        :root {
            --primary-color: #f4e600;
            --primary-dark: #d4c600;
            --primary-light: #f9f06a;
            --secondary-color: #1a1a1a;
            --accent-color: #333333;
            --success-color: #4ade80;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            --border-radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --tva-rate: 8.1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 50%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(26, 26, 26, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid rgba(244, 230, 0, 0.2);
        }

        .header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: var(--primary-color);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(244, 230, 0, 0.1) 50%, transparent 70%);
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 2;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .nav-tabs {
            display: flex;
            background: rgba(26, 26, 26, 0.8);
            border-bottom: 2px solid var(--primary-color);
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(51, 51, 51, 0.8);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(244, 230, 0, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            background: rgba(244, 230, 0, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-bottom-color: var(--primary-color);
            color: var(--secondary-color);
            box-shadow: 0 4px 8px rgba(244, 230, 0, 0.3);
        }

        .nav-tab.active:hover {
            color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            padding: 30px;
            background: rgba(26, 26, 26, 0.9);
        }

        .tab-content.active {
            display: block;
        }

        .catalog-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--secondary-color);
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .catalog-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(244, 230, 0, 0.4);
        }

        .catalog-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 2000;
            overflow-y: auto;
        }

        .catalog-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .catalog-modal-content {
            background: rgba(26, 26, 26, 0.95);
            border-radius: 15px;
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--primary-color);
            margin-top: 20px;
        }

        .catalog-section {
            margin-bottom: 30px;
            border: 2px solid rgba(244, 230, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(51, 51, 51, 0.3);
        }

        .catalog-header {
            background: linear-gradient(135deg, rgba(244, 230, 0, 0.2) 0%, rgba(244, 230, 0, 0.1) 100%);
            padding: 20px;
            border-bottom: 1px solid rgba(244, 230, 0, 0.3);
        }

        .catalog-header h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .catalog-controls {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(244, 230, 0, 0.1);
            color: white;
        }

        .catalog-grid:last-child {
            border-bottom: none;
        }

        .catalog-grid:nth-child(even) {
            background: rgba(244, 230, 0, 0.05);
        }

        .product-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-weight: 600;
            color: white;
        }

        .product-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .client-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(51, 51, 51, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(244, 230, 0, 0.2);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        input, textarea, select {
            padding: 12px;
            border: 2px solid rgba(244, 230, 0, 0.3);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: rgba(26, 26, 26, 0.8);
            color: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244, 230, 0, 0.2);
        }

        .sections-container {
            margin-top: 30px;
        }

        .section {
            border: 2px solid rgba(244, 230, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 25px;
            background: rgba(51, 51, 51, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 5px 15px rgba(244, 230, 0, 0.2);
            border-color: rgba(244, 230, 0, 0.6);
        }

        .section-header {
            background: linear-gradient(135deg, rgba(244, 230, 0, 0.2) 0%, rgba(244, 230, 0, 0.1) 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(244, 230, 0, 0.3);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            min-height: 36px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--secondary-color);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #22c55e 100%);
            color: white;
            font-size: 16px;
            padding: 15px 30px;
            min-height: 50px;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #22c55e 0%, var(--success-color) 100%);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 32px;
        }

        .section-content {
            padding: 25px;
        }

        .section-items {
            margin-bottom: 20px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(26, 26, 26, 0.5);
            border-radius: var(--border-radius);
            border: 1px solid rgba(244, 230, 0, 0.2);
        }

        .product-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .manual-input {
            margin-top: 10px;
        }

        .item-controls {
            display: flex;
            gap: 5px;
            flex-direction: column;
        }

        .discount-section {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
        }

        .discount-section label {
            color: var(--warning-color);
            font-weight: 600;
        }

        .payment-options {
            background: rgba(244, 230, 0, 0.1);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
        }

        .payment-options h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .payment-option {
            background: rgba(26, 26, 26, 0.8);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(244, 230, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: white;
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            background: rgba(244, 230, 0, 0.1);
        }

        .payment-option.active {
            border-color: var(--primary-color);
            background: rgba(244, 230, 0, 0.2);
            color: var(--secondary-color);
        }

        .summary {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(51, 51, 51, 0.7) 100%);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid var(--primary-color);
        }

        .summary h3 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(244, 230, 0, 0.3);
            color: white;
        }

        .summary-row.total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            margin-top: 15px;
            padding-top: 20px;
        }

        .summary-row.tva {
            color: var(--primary-light);
            font-weight: 600;
        }

        .actions {
            text-align: center;
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        .add-item-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-size: 16px;
            min-height: 50px;
        }

        .add-item-btn:hover {
            background: linear-gradient(135deg, #22c55e 0%, var(--success-color) 100%);
            transform: translateY(-1px);
        }

        .free-label {
            color: var(--success-color);
            font-weight: bold;
            font-style: italic;
        }

        .close-modal {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .close-modal:hover {
            background: #dc2626;
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
                color: black;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
                background: white;
            }
            .nav-tabs, .actions, .catalog-toggle {
                display: none;
            }
        }

        /* Responsive Design - Tablette */
        @media (max-width: 1024px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .catalog-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .catalog-controls input {
                min-width: 150px;
                flex: 1;
            }
            
            .item-row {
                grid-template-columns: 1fr 80px 100px 80px auto;
                gap: 10px;
            }
            
            .product-selector select {
                font-size: 14px;
            }

            .catalog-toggle {
                bottom: 15px;
                right: 15px;
                padding: 12px 20px;
            }
        }

        /* Responsive Design - Mobile */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 0;
                border-radius: 8px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .item-row {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .item-controls {
                flex-direction: row;
                justify-content: center;
            }
            
            .client-info {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .catalog-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .catalog-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .catalog-controls input,
            .catalog-controls button {
                width: 100%;
            }
            
            .section-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .section-content {
                padding: 20px;
            }
            
            .payment-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .payment-option {
                padding: 12px;
                text-align: center;
            }
            
            .summary {
                padding: 20px;
            }
            
            .summary h3 {
                font-size: 1.5rem;
            }
            
            .summary-row {
                padding: 10px 0;
                font-size: 14px;
            }
            
            .summary-row.total {
                font-size: 1.1rem;
            }
            
            .btn-success {
                padding: 12px 24px;
                font-size: 14px;
            }
            
            /* Am√©lioration des champs de saisie sur mobile */
            input, textarea, select {
                font-size: 16px; /* √âvite le zoom automatique sur iOS */
                padding: 15px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 13px;
                min-height: 44px; /* Taille tactile recommand√©e */
            }
            
            .add-item-btn {
                padding: 18px;
                font-size: 16px;
                min-height: 50px;
            }

            .catalog-toggle {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }

            .actions {
                flex-direction: column;
                align-items: center;
            }

            .actions .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Responsive Design - Tr√®s petits √©crans */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .client-info {
                padding: 15px;
            }
            
            .section-content {
                padding: 15px;
            }
            
            .summary {
                padding: 15px;
            }
            
            .item-row {
                padding: 12px;
            }

            .catalog-modal-content {
                padding: 15px;
                margin: 10px;
            }
        }

        /* Am√©liorations tactiles pour tablettes */
        @media (pointer: coarse) {
            .btn, button, select, input {
                min-height: 44px;
            }
            
            .nav-tab {
                min-height: 48px;
            }
            
            .payment-option {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê G√©n√©rateur de Devis</h1>
            <p>Syst√®me d'alarme & Surveillance</p>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('alarm')">üö® Syst√®me d'Alarme</div>
            <div class="nav-tab" onclick="showTab('camera')">üìπ Cam√©ra de Surveillance</div>
        </div>

        <!-- Onglet Syst√®me d'Alarme -->
        <div id="alarm-tab" class="tab-content active">
            <!-- Informations client -->
            <div class="client-info">
                <div class="form-group">
                    <label for="clientName">Nom du client *</label>
                    <input type="text" id="clientName" placeholder="Nom complet" required>
                </div>
                <div class="form-group">
                    <label for="clientAddress">Adresse</label>
                    <input type="text" id="clientAddress" placeholder="Adresse compl√®te">
                </div>
                <div class="form-group">
                    <label for="clientPhone">T√©l√©phone</label>
                    <input type="tel" id="clientPhone" placeholder="Num√©ro de t√©l√©phone">
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" placeholder="Adresse email">
                </div>
            </div>

            <!-- Sections du devis alarme -->
            <div class="sections-container" id="alarmSectionsContainer">
                <!-- Les sections seront g√©n√©r√©es dynamiquement -->
            </div>

            <!-- R√©sum√© -->
            <div class="summary" id="alarmSummary">
                <h3>üìã R√©sum√© du Devis Alarme</h3>
                <div id="alarmSummaryContent">
                    <div class="summary-row">
                        <span>Sous-total HT</span>
                        <span>0.00 CHF</span>
                    </div>
                    <div class="summary-row tva">
                        <span>TVA (8.1%)</span>
                        <span>0.00 CHF</span>
                    </div>
                    <div class="summary-row total">
                        <span>TOTAL TTC</span>
                        <span>0.00 CHF</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-success" onclick="generatePDF('alarm')">
                    üìÑ G√©n√©rer le PDF
                </button>
                <button class="btn btn-primary" onclick="resetQuote('alarm')">
                    üîÑ Nouveau Devis
                </button>
            </div>
        </div>

        <!-- Onglet Cam√©ra de Surveillance -->
        <div id="camera-tab" class="tab-content">
            <!-- Informations client -->
            <div class="client-info">
                <div class="form-group">
                    <label for="clientNameCamera">Nom du client *</label>
                    <input type="text" id="clientNameCamera" placeholder="Nom complet" required>
                </div>
                <div class="form-group">
                    <label for="clientAddressCamera">Adresse</label>
                    <input type="text" id="clientAddressCamera" placeholder="Adresse compl√®te">
                </div>
                <div class="form-group">
                    <label for="clientPhoneCamera">T√©l√©phone</label>
                    <input type="tel" id="clientPhoneCamera" placeholder="Num√©ro de t√©l√©phone">
                </div>
                <div class="form-group">
                    <label for="clientEmailCamera">Email</label>
                    <input type="email" id="clientEmailCamera" placeholder="Adresse email">
                </div>
            </div>

            <!-- Sections du devis cam√©ra -->
            <div class="sections-container" id="cameraSectionsContainer">
                <!-- Les sections seront g√©n√©r√©es dynamiquement -->
            </div>

            <!-- R√©sum√© -->
            <div class="summary" id="cameraSummary">
                <h3>üìã R√©sum√© du Devis Cam√©ra</h3>
                <div id="cameraSummaryContent">
                    <div class="summary-row">
                        <span>Sous-total HT</span>
                        <span>0.00 CHF</span>
                    </div>
                    <div class="summary-row tva">
                        <span>TVA (8.1%)</span>
                        <span>0.00 CHF</span>
                    </div>
                    <div class="summary-row total">
                        <span>TOTAL TTC</span>
                        <span>0.00 CHF</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-success" onclick="generatePDF('camera')">
                    üìÑ G√©n√©rer le PDF
                </button>
                <button class="btn btn-primary" onclick="resetQuote('camera')">
                    üîÑ Nouveau Devis
                </button>
            </div>
        </div>
    </div>

    <!-- Bouton flottant pour le catalogue -->
    <button class="catalog-toggle" onclick="toggleCatalog()">
        üì¶ Catalogue
    </button>

    <!-- Modal du catalogue -->
    <div class="catalog-modal" id="catalogModal">
        <div class="catalog-modal-content">
            <button class="close-modal" onclick="toggleCatalog()">‚ùå Fermer le Catalogue</button>
            
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">üì¶ Gestion du Catalogue Produits</h2>
            
            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üîß Mat√©riel Alarme</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Nom du produit" id="alarm-material-name">
                        <input type="text" placeholder="Description" id="alarm-material-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="alarm-material-price">
                        <button class="btn btn-primary" onclick="addProduct('alarm-material')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="alarm-material-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üî® Installation Alarme</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Service" id="alarm-installation-name">
                        <input type="text" placeholder="Description" id="alarm-installation-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="alarm-installation-price">
                        <button class="btn btn-primary" onclick="addProduct('alarm-installation')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="alarm-installation-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üìã Frais de Dossier</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Service" id="alarm-admin-name">
                        <input type="text" placeholder="Description" id="alarm-admin-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="alarm-admin-price">
                        <button class="btn btn-primary" onclick="addProduct('alarm-admin')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="alarm-admin-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üìπ Mat√©riel Cam√©ra</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Nom du produit" id="camera-material-name">
                        <input type="text" placeholder="Description" id="camera-material-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="camera-material-price">
                        <button class="btn btn-primary" onclick="addProduct('camera-material')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="camera-material-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üî® Installation Cam√©ra</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Service" id="camera-installation-name">
                        <input type="text" placeholder="Description" id="camera-installation-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="camera-installation-price">
                        <button class="btn btn-primary" onclick="addProduct('camera-installation')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="camera-installation-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>üåê Vision √† Distance</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Service" id="camera-remote-name">
                        <input type="text" placeholder="Description" id="camera-remote-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="camera-remote-price">
                        <button class="btn btn-primary" onclick="addProduct('camera-remote')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="camera-remote-list"></div>
            </div>

            <div class="catalog-section">
                <div class="catalog-header">
                    <h3>‚öôÔ∏è Maintenance et Garantie</h3>
                    <div class="catalog-controls">
                        <input type="text" placeholder="Service" id="camera-maintenance-name">
                        <input type="text" placeholder="Description" id="camera-maintenance-desc">
                        <input type="number" placeholder="Prix CHF HT" step="0.01" id="camera-maintenance-price">
                        <button class="btn btn-primary" onclick="addProduct('camera-maintenance')">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="camera-maintenance-list"></div>
            </div>

            <!-- Actions Catalogue -->
            <div class="actions">
                <button class="btn btn-success" onclick="exportCatalog()">
                    üíæ Exporter le Catalogue
                </button>
                <input type="file" id="catalog-import" accept=".json" style="display: none;" onchange="importCatalog(event)">
                <button class="btn btn-primary" onclick="document.getElementById('catalog-import').click()">
                    üìÇ Importer le Catalogue
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentQuoteType = 'alarm';
        let alarmSections = {};
        let cameraSections = {};
        let sectionCounter = 0;
        let itemCounter = 0;
        const TVA_RATE = 8.1;
        let catalog = {
            'alarm-material': [],
            'alarm-installation': [],
            'alarm-admin': [],
            'camera-material': [],
            'camera-installation': [],
            'camera-remote': [],
            'camera-maintenance': []
        };

        // Configuration des sections pour chaque type de devis
        const quoteConfig = {
            alarm: [
                { id: 'material', name: 'Mat√©riel', canFinance: true, removable: false, catalogKey: 'alarm-material' },
                { id: 'installation', name: 'Installation et mat√©riel suppl√©mentaire', canFinance: true, removable: false, catalogKey: 'alarm-installation' },
                { id: 'admin', name: 'Frais de dossier', canFinance: false, removable: false, catalogKey: 'alarm-admin' }
            ],
            camera: [
                { id: 'material', name: 'Mat√©riel', canFinance: true, removable: false, catalogKey: 'camera-material' },
                { id: 'installation', name: 'Installation', canFinance: true, removable: false, catalogKey: 'camera-installation' },
                { id: 'remote', name: 'Vision √† distance', canFinance: false, removable: true, catalogKey: 'camera-remote' },
                { id: 'maintenance', name: 'Maintenance et garantie', canFinance: false, removable: true, catalogKey: 'camera-maintenance' }
            ]
        };

        // Gestion des onglets
        function showTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Afficher l'onglet s√©lectionn√©
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            currentQuoteType = tabName;
            initializeSections(tabName);
        }

        // Gestion du catalogue modal
        function toggleCatalog() {
            const modal = document.getElementById('catalogModal');
            modal.classList.toggle('active');
        }

        // Gestion du catalogue
        function addProduct(category) {
            const name = document.getElementById(category + '-name').value.trim();
            const description = document.getElementById(category + '-desc').value.trim();
            const price = parseFloat(document.getElementById(category + '-price').value) || 0;

            if (!name) {
                alert('Veuillez renseigner au moins le nom du produit');
                return;
            }

            const product = {
                id: Date.now(),
                name: name,
                description: description,
                price: price
            };

            catalog[category].push(product);
            updateCatalogDisplay(category);
            saveCatalogToStorage();
            
            // Vider les champs
            document.getElementById(category + '-name').value = '';
            document.getElementById(category + '-desc').value = '';
            document.getElementById(category + '-price').value = '';
        }

        function updateCatalogDisplay(category) {
            const container = document.getElementById(category + '-list');
            container.innerHTML = '';

            catalog[category].forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'catalog-grid';
                
                const displayPrice = product.price === 0 ? 
                    '<span class="free-label">OFFERT</span>' : 
                    `<strong>${product.price.toFixed(2)} CHF</strong>`;
                
                productDiv.innerHTML = `
                    <div class="product-item">
                        <div class="product-name">${escapeHtml(product.name)}</div>
                        <div class="product-description">${escapeHtml(product.description)}</div>
                    </div>
                    <div>Qt√©: 1</div>
                    <div>${displayPrice}</div>
                    <button class="btn btn-danger btn-small" onclick="removeProduct('${category}', ${product.id})">üóëÔ∏è</button>
                `;
                container.appendChild(productDiv);
            });
        }

        function removeProduct(category, productId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
                catalog[category] = catalog[category].filter(p => p.id !== productId);
                updateCatalogDisplay(category);
                saveCatalogToStorage();
            }
        }

        // Sauvegarde et chargement du catalogue
        function saveCatalogToStorage() {
            try {
                localStorage.setItem('devis_catalog', JSON.stringify(catalog));
            } catch (e) {
                console.warn('Impossible de sauvegarder le catalogue:', e);
            }
        }

        function loadCatalogFromStorage() {
            try {
                const saved = localStorage.getItem('devis_catalog');
                if (saved) {
                    catalog = JSON.parse(saved);
                    Object.keys(catalog).forEach(category => {
                        updateCatalogDisplay(category);
                    });
                }
            } catch (e) {
                console.warn('Impossible de charger le catalogue sauvegard√©:', e);
            }
        }

        // Export/Import du catalogue
        function exportCatalog() {
            const dataStr = JSON.stringify(catalog, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'catalogue_produits.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importCatalog(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedCatalog = JSON.parse(e.target.result);
                    if (confirm('Cet import va remplacer votre catalogue actuel. Continuer ?')) {
                        catalog = importedCatalog;
                        Object.keys(catalog).forEach(category => {
                            updateCatalogDisplay(category);
                        });
                        saveCatalogToStorage();
                        alert('Catalogue import√© avec succ√®s !');
                    }
                } catch (error) {
                    alert('Erreur lors de l\'import du catalogue. V√©rifiez le format du fichier.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Initialisation des sections
        function initializeSections(type) {
            const container = document.getElementById(type + 'SectionsContainer');
            container.innerHTML = '';
            
            if (type === 'alarm') {
                alarmSections = {};
            } else {
                cameraSections = {};
            }
            
            sectionCounter = 0;

            const config = quoteConfig[type];
            config.forEach(sectionConfig => {
                createSection(sectionConfig, type);
            });
        }

        // Cr√©ation d'une section
        function createSection(config, type) {
            const sectionId = `${type}_section_${sectionCounter++}`;
            const sectionData = {
                id: config.id,
                name: config.name,
                canFinance: config.canFinance,
                removable: config.removable,
                catalogKey: config.catalogKey,
                items: [],
                discount: 0,
                paymentMonths: 0,
                enabled: true
            };

            if (type === 'alarm') {
                alarmSections[sectionId] = sectionData;
            } else {
                cameraSections[sectionId] = sectionData;
            }

            const container = document.getElementById(type + 'SectionsContainer');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            sectionDiv.id = sectionId;

            sectionDiv.innerHTML = `
                <div class="section-header">
                    <div class="section-title">
                        <span class="icon">${getSectionIcon(config.id)}</span>
                        ${config.name}
                    </div>
                    <div class="section-controls">
                        ${config.removable ? `<button class="btn btn-danger" onclick="removeSection('${sectionId}', '${type}')">‚ùå Supprimer</button>` : ''}
                    </div>
                </div>
                <div class="section-content">
                    <div class="section-items" id="${sectionId}_items">
                        <!-- Les items seront ajout√©s ici -->
                    </div>
                    
                    <button class="add-item-btn" onclick="addItem('${sectionId}', '${type}')">
                        ‚ûï Ajouter un article
                    </button>
                    
                    <div class="discount-section">
                        <label for="${sectionId}_discount">üí∞ Remise (%)</label>
                        <input type="number" id="${sectionId}_discount" min="0" max="100" step="0.1" value="0" onchange="updateDiscount('${sectionId}', '${type}', this.value)">
                    </div>
                    
                    ${config.canFinance ? `
                        <div class="payment-options">
                            <h4>üí≥ Facilit√©s de paiement</h4>
                            <div class="payment-grid">
                                <div class="payment-option active" onclick="setPaymentOption('${sectionId}', '${type}', 0)">
                                    <strong>Comptant</strong><br>
                                    <small>Aucun suppl√©ment</small>
                                </div>
                                <div class="payment-option" onclick="setPaymentOption('${sectionId}', '${type}', 24)">
                                    <strong>24 mois</strong><br>
                                    <small>+10% sur la mensualit√©</small>
                                </div>
                                <div class="payment-option" onclick="setPaymentOption('${sectionId}', '${type}', 36)">
                                    <strong>36 mois</strong><br>
                                    <small>+15% sur la mensualit√©</small>
                                </div>
                                <div class="payment-option" onclick="setPaymentOption('${sectionId}', '${type}', 48)">
                                    <strong>48 mois</strong><br>
                                    <small>+20% sur la mensualit√©</small>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            container.appendChild(sectionDiv);
            updateSummary(type);
        }

        function getSectionIcon(sectionId) {
            const icons = {
                material: 'üîß',
                installation: 'üî®',
                admin: 'üìã',
                remote: 'üåê',
                maintenance: '‚öôÔ∏è'
            };
            return icons[sectionId] || 'üì¶';
        }

        function removeSection(sectionId, type) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette section ?')) {
                if (type === 'alarm') {
                    delete alarmSections[sectionId];
                } else {
                    delete cameraSections[sectionId];
                }
                document.getElementById(sectionId).remove();
                updateSummary(type);
            }
        }

        function addItem(sectionId, type) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            const itemId = `item_${itemCounter++}`;
            
            section.items.push({ 
                id: itemId,
                description: '', 
                quantity: 1, 
                price: 0,
                isManual: false
            });
            
            const container = document.getElementById(`${sectionId}_items`);
            const itemIndex = section.items.length - 1;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.id = itemId;
            
            // Cr√©er les options pour la liste d√©roulante
            let productOptions = '<option value="">S√©lectionner un produit...</option>';
            if (catalog[section.catalogKey]) {
                catalog[section.catalogKey].forEach(product => {
                    productOptions += `<option value="${product.id}" data-price="${product.price}" data-description="${escapeHtml(product.description)}">${escapeHtml(product.name)}</option>`;
                });
            }
            
            itemDiv.innerHTML = `
                <div class="product-selector">
                    <select onchange="selectProduct('${sectionId}', '${type}', ${itemIndex}, this)">
                        ${productOptions}
                    </select>
                    <div class="checkbox-group">
                        <input type="checkbox" id="${itemId}_manual" onchange="toggleManualInput('${sectionId}', '${type}', ${itemIndex}, this.checked)">
                        <label for="${itemId}_manual">Saisie manuelle</label>
                    </div>
                    <div class="manual-input" id="${itemId}_manual_input" style="display: none;">
                        <input type="text" placeholder="Description personnalis√©e" onchange="updateItem('${sectionId}', '${type}', ${itemIndex}, 'description', this.value)">
                    </div>
                </div>
                <input type="number" placeholder="Quantit√©" min="1" value="1" onchange="updateItem('${sectionId}', '${type}', ${itemIndex}, 'quantity', this.value)">
                <input type="number" placeholder="Prix unitaire CHF HT" min="0" step="0.01" value="0" onchange="updateItem('${sectionId}', '${type}', ${itemIndex}, 'price', this.value)">
                <input type="number" placeholder="Total HT" readonly value="0" id="${itemId}_total">
                <div class="item-controls">
                    <button class="btn btn-danger btn-small" onclick="removeItem('${sectionId}', '${type}', ${itemIndex})">üóëÔ∏è</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
            updateSummary(type);
        }

        function selectProduct(sectionId, type, itemIndex, selectElement) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            const item = section.items[itemIndex];
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption.value) {
                const productId = parseInt(selectedOption.value);
                const product = catalog[section.catalogKey].find(p => p.id === productId);
                
                if (product) {
                    item.description = product.name;
                    item.price = product.price;
                    item.isManual = false;
                    
                    // Mettre √† jour les champs
                    const itemDiv = document.getElementById(item.id);
                    const priceInput = itemDiv.querySelector('input[placeholder="Prix unitaire CHF HT"]');
                    priceInput.value = product.price;
                    
                    // D√©sactiver la saisie manuelle
                    const manualCheckbox = itemDiv.querySelector('input[type="checkbox"]');
                    manualCheckbox.checked = false;
                    toggleManualInput(sectionId, type, itemIndex, false);
                    
                    updateItemTotal(item.id, item.quantity, item.price);
                    updateSummary(type);
                }
            }
        }

        function toggleManualInput(sectionId, type, itemIndex, isManual) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            const item = section.items[itemIndex];
            const manualInputDiv = document.getElementById(`${item.id}_manual_input`);
            const productSelect = document.getElementById(item.id).querySelector('select');
            
            if (isManual) {
                manualInputDiv.style.display = 'block';
                productSelect.value = '';
                productSelect.disabled = true;
                item.isManual = true;
            } else {
                manualInputDiv.style.display = 'none';
                productSelect.disabled = false;
                item.isManual = false;
            }
        }

        function removeItem(sectionId, type, itemIndex) {
            if (confirm('Supprimer cet article ?')) {
                const sections = type === 'alarm' ? alarmSections : cameraSections;
                const section = sections[sectionId];
                const item = section.items[itemIndex];
                
                // Supprimer l'√©l√©ment du DOM
                document.getElementById(item.id).remove();
                
                // Supprimer l'item du tableau
                section.items.splice(itemIndex, 1);
                
                updateSummary(type);
            }
        }

        function updateItem(sectionId, type, itemIndex, field, value) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            const item = section.items[itemIndex];
            
            if (!item) return;
            
            if (field === 'quantity' || field === 'price') {
                item[field] = parseFloat(value) || 0;
            } else {
                item[field] = value;
            }
            
            updateItemTotal(item.id, item.quantity, item.price);
            updateSummary(type);
        }

        function updateItemTotal(itemId, quantity, price) {
            const totalInput = document.getElementById(`${itemId}_total`);
            if (totalInput) {
                const total = (quantity || 0) * (price || 0);
                totalInput.value = total.toFixed(2);
            }
        }

        function updateDiscount(sectionId, type, discount) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            sections[sectionId].discount = parseFloat(discount) || 0;
            updateSummary(type);
        }

        function setPaymentOption(sectionId, type, months) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            section.paymentMonths = months;
            
            // Mettre √† jour l'interface
            const paymentOptions = document.querySelector(`#${sectionId} .payment-grid`).children;
            Array.from(paymentOptions).forEach(option => option.classList.remove('active'));
            
            let activeIndex = 0;
            if (months === 24) activeIndex = 1;
            else if (months === 36) activeIndex = 2;
            else if (months === 48) activeIndex = 3;
            
            paymentOptions[activeIndex].classList.add('active');
            updateSummary(type);
        }

        function calculateSectionTotal(sectionId, type) {
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            const section = sections[sectionId];
            let subtotal = 0;
            
            section.items.forEach(item => {
                subtotal += (item.quantity || 0) * (item.price || 0);
            });
            
            // Appliquer la remise
            subtotal = subtotal * (1 - (section.discount || 0) / 100);
            
            // Calculer les frais de financement
            let financingRate = 0;
            if (section.paymentMonths === 24) financingRate = 0.10;
            else if (section.paymentMonths === 36) financingRate = 0.15;
            else if (section.paymentMonths === 48) financingRate = 0.20;
            
            const financingCost = subtotal * financingRate;
            const total = subtotal + financingCost;
            
            return { subtotal, financingCost, total, monthlyPayment: section.paymentMonths > 0 ? total / section.paymentMonths : 0 };
        }

        function updateSummary(type) {
            const summaryContent = document.getElementById(type + 'SummaryContent');
            const sections = type === 'alarm' ? alarmSections : cameraSections;
            let grandTotal = 0;
            let html = '';
            
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                const calculation = calculateSectionTotal(sectionId, type);
                
                if (calculation.total > 0) {
                    html += `
                        <div class="summary-row">
                            <span><strong>${section.name}</strong></span>
                            <span>${calculation.total.toFixed(2)} CHF</span>
                        </div>
                    `;
                    
                    if (section.discount > 0) {
                        const originalTotal = calculation.subtotal / (1 - section.discount / 100);
                        const discountAmount = originalTotal - calculation.subtotal;
                        html += `
                            <div class="summary-row" style="font-size: 0.9em; color: var(--success-color);">
                                <span>  ‚Üí Remise ${section.discount}%</span>
                                <span>-${discountAmount.toFixed(2)} CHF</span>
                            </div>
                        `;
                    }
                    
                    if (calculation.financingCost > 0) {
                        html += `
                            <div class="summary-row" style="font-size: 0.9em; color: var(--danger-color);">
                                <span>  ‚Üí Financement ${section.paymentMonths} mois</span>
                                <span>+${calculation.financingCost.toFixed(2)} CHF</span>
                            </div>
                        `;
                        html += `
                            <div class="summary-row" style="font-size: 0.9em; color: var(--primary-light);">
                                <span>  ‚Üí Mensualit√©</span>
                                <span>${calculation.monthlyPayment.toFixed(2)} CHF/mois</span>
                            </div>
                        `;
                    }
                    
                    grandTotal += calculation.total;
                }
            });
            
            // Calculs TVA suisse
            const tvaAmount = grandTotal * (TVA_RATE / 100);
            const totalTTC = grandTotal + tvaAmount;
            
            html += `
                <div class="summary-row">
                    <span>Sous-total HT</span>
                    <span>${grandTotal.toFixed(2)} CHF</span>
                </div>
                <div class="summary-row tva">
                    <span>TVA (${TVA_RATE}%)</span>
                    <span>${tvaAmount.toFixed(2)} CHF</span>
                </div>
                <div class="summary-row total">
                    <span>TOTAL TTC</span>
                    <span>${totalTTC.toFixed(2)} CHF</span>
                </div>
            `;
            
            summaryContent.innerHTML = html;
        }

        function resetQuote(type) {
            if (confirm('Cr√©er un nouveau devis ? (Les donn√©es actuelles seront perdues)')) {
                // R√©initialiser les informations client
                if (type === 'alarm') {
                    document.getElementById('clientName').value = '';
                    document.getElementById('clientAddress').value = '';
                    document.getElementById('clientPhone').value = '';
                    document.getElementById('clientEmail').value = '';
                } else {
                    document.getElementById('clientNameCamera').value = '';
                    document.getElementById('clientAddressCamera').value = '';
                    document.getElementById('clientPhoneCamera').value = '';
                    document.getElementById('clientEmailCamera').value = '';
                }
                
                // R√©initialiser les sections
                initializeSections(type);
            }
        }

        function generatePDF(type) {
            // V√©rifier que jsPDF est charg√©
            if (typeof window.jspdf === 'undefined') {
                alert('Erreur: Biblioth√®que PDF non charg√©e. Veuillez recharger la page.');
                return;
            }

            // R√©cup√©rer les informations client selon le type
            let clientName, clientAddress, clientPhone, clientEmail;
            if (type === 'alarm') {
                clientName = document.getElementById('clientName').value.trim();
                clientAddress = document.getElementById('clientAddress').value.trim();
                clientPhone = document.getElementById('clientPhone').value.trim();
                clientEmail = document.getElementById('clientEmail').value.trim();
            } else {
                clientName = document.getElementById('clientNameCamera').value.trim();
                clientAddress = document.getElementById('clientAddressCamera').value.trim();
                clientPhone = document.getElementById('clientPhoneCamera').value.trim();
                clientEmail = document.getElementById('clientEmailCamera').value.trim();
            }

            if (!clientName) {
                alert('Veuillez renseigner au moins le nom du client.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuration
                const pageWidth = 210;
                const margin = 20;
                let yPosition = 30;
                
                // En-t√™te avec logo simul√©
                doc.setFillColor(26, 26, 26);
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(244, 230, 0);
                doc.text('üîê DEVIS', pageWidth / 2, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`${type === 'alarm' ? 'Syst√®me d\'Alarme' : 'Cam√©ra de Surveillance'}`, pageWidth / 2, 30, { align: 'center' });
                
                // Retour au fond blanc et texte noir
                doc.setTextColor(0, 0, 0);
                yPosition = 55;
                
                // Num√©ro de devis et date
                const today = new Date();
                const dateStr = today.toLocaleDateString('fr-CH');
                const devisNumber = `DEV-${type.toUpperCase()}-${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random() * 1000).toString().padStart(3,'0')}`;
                
                doc.setFontSize(10);
                doc.text(`N¬∞ Devis: ${devisNumber}`, margin, yPosition);
                doc.text(`Date: ${dateStr}`, pageWidth - margin, yPosition, { align: 'right' });
                yPosition += 15;
                
                // Informations entreprise (√† personnaliser)
                doc.setFont(undefined, 'bold');
                doc.text('VOTRE ENTREPRISE S√âCURIT√â', margin, yPosition);
                yPosition += 6;
                doc.setFont(undefined, 'normal');
                doc.text('Adresse de votre entreprise', margin, yPosition);
                yPosition += 4;
                doc.text('Code postal Ville', margin, yPosition);
                yPosition += 4;
                doc.text('T√©l: +41 XX XXX XX XX', margin, yPosition);
                yPosition += 4;
                doc.text('Email: contact@votre-entreprise.ch', margin, yPosition);
                yPosition += 15;
                
                // Informations client
                doc.setFont(undefined, 'bold');
                doc.text('FACTURER √Ä:', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`${clientName}`, margin, yPosition);
                yPosition += 6;
                if (clientAddress) {
                    doc.text(`${clientAddress}`, margin, yPosition);
                    yPosition += 6;
                }
                if (clientPhone) {
                    doc.text(`T√©l: ${clientPhone}`, margin, yPosition);
                    yPosition += 6;
                }
                if (clientEmail) {
                    doc.text(`Email: ${clientEmail}`, margin, yPosition);
                    yPosition += 6;
                }
                yPosition += 10;
                
                // D√©tail des sections
                const sections = type === 'alarm' ? alarmSections : cameraSections;
                let grandTotalHT = 0;
                
                Object.keys(sections).forEach(sectionId => {
                    const section = sections[sectionId];
                    const calculation = calculateSectionTotal(sectionId, type);
                    
                    if (calculation.total > 0) {
                        // V√©rifier si on a besoin d'une nouvelle page
                        if (yPosition > 240) {
                            doc.addPage();
                            yPosition = 30;
                        }
                        
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(12);
                        doc.text(section.name.toUpperCase(), margin, yPosition);
                        yPosition += 10;
                        
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        
                        // Articles
                        section.items.forEach(item => {
                            if (item.description && (item.price > 0 || item.price === 0)) {
                                const itemTotal = (item.quantity || 0) * (item.price || 0);
                                const description = item.description.length > 60 ? item.description.substring(0, 60) + '...' : item.description;
                                
                                if (item.price === 0) {
                                    doc.text(`${description}`, margin + 5, yPosition);
                                    doc.text(`${item.quantity}`, pageWidth - 80, yPosition, { align: 'right' });
                                    doc.text(`OFFERT`, pageWidth - 50, yPosition, { align: 'right' });
                                    doc.text(`OFFERT`, pageWidth - margin, yPosition, { align: 'right' });
                                } else {
                                    doc.text(`${description}`, margin + 5, yPosition);
                                    doc.text(`${item.quantity}`, pageWidth - 80, yPosition, { align: 'right' });
                                    doc.text(`${item.price.toFixed(2)}`, pageWidth - 50, yPosition, { align: 'right' });
                                    doc.text(`${itemTotal.toFixed(2)}`, pageWidth - margin, yPosition, { align: 'right' });
                                }
                                yPosition += 6;
                            }
                        });
                        
                        // Sous-total avant remise
                        const subtotalBeforeDiscount = section.items.reduce((sum, item) => sum + (item.quantity || 0) * (item.price || 0), 0);
                        if (subtotalBeforeDiscount > 0 || section.items.some(item => item.price === 0)) {
                            yPosition += 3;
                            doc.text('Sous-total:', margin + 10, yPosition);
                            doc.text(`${subtotalBeforeDiscount.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                            yPosition += 6;
                            
                            // Remise
                            if (section.discount > 0) {
                                const discountAmount = subtotalBeforeDiscount * (section.discount / 100);
                                doc.text(`Remise (${section.discount}%):`, margin + 10, yPosition);
                                doc.text(`-${discountAmount.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                                yPosition += 6;
                            }
                            
                            // Frais de financement
                            if (calculation.financingCost > 0) {
                                doc.text(`Frais financement (${section.paymentMonths} mois):`, margin + 10, yPosition);
                                doc.text(`+${calculation.financingCost.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                                yPosition += 6;
                                doc.text(`Mensualit√©:`, margin + 10, yPosition);
                                doc.text(`${calculation.monthlyPayment.toFixed(2)} CHF/mois`, pageWidth - margin, yPosition, { align: 'right' });
                                yPosition += 6;
                            }
                            
                            // Total de la section
                            doc.setFont(undefined, 'bold');
                            doc.text(`Total ${section.name} HT:`, margin + 10, yPosition);
                            doc.text(`${calculation.total.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                            yPosition += 15;
                            
                            grandTotalHT += calculation.total;
                            doc.setFont(undefined, 'normal');
                        }
                    }
                });
                
                // Totaux finaux avec TVA suisse
                yPosition += 5;
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                const tvaAmount = grandTotalHT * (TVA_RATE / 100);
                const totalTTC = grandTotalHT + tvaAmount;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                
                doc.text('SOUS-TOTAL HT:', margin, yPosition);
                doc.text(`${grandTotalHT.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                yPosition += 8;
                
                doc.text(`TVA (${TVA_RATE}%):`, margin, yPosition);
                doc.text(`${tvaAmount.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                yPosition += 10;
                
                doc.setFontSize(14);
                doc.text('TOTAL TTC:', margin, yPosition);
                doc.text(`${totalTTC.toFixed(2)} CHF`, pageWidth - margin, yPosition, { align: 'right' });
                
                // Pied de page
                yPosition = 270;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('Conditions g√©n√©rales:', margin, yPosition);
                yPosition += 4;
                doc.text('‚Ä¢ Ce devis est valable 30 jours √† compter de sa date d\'√©mission.', margin, yPosition);
                yPosition += 4;
                doc.text('‚Ä¢ Paiement selon les conditions convenues.', margin, yPosition);
                yPosition += 4;
                doc.text('‚Ä¢ TVA suisse de 8.1% incluse dans le total TTC.', margin, yPosition);
                yPosition += 4;
                doc.text('‚Ä¢ Installation selon les normes suisses en vigueur.', margin, yPosition);
                
                // Num√©ro de page
                doc.text(`Page 1`, pageWidth - margin, 285, { align: 'right' });
                
                // T√©l√©charger le PDF
                const fileName = `Devis_${type}_${clientName.replace(/\s+/g, '_')}_${dateStr.replace(/\./g, '-')}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
            }
        }

        // Utilitaires
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Initialisation avec votre catalogue r√©el
        function initializeRealCatalog() {
            // Mat√©riel Alarme
            catalog['alarm-material'] = [
                { id: 1, name: 'Bouton panique/Montre d\'urgence (radio)', description: '', price: 35.00 },
                { id: 2, name: 'Barri√®re ext√©rieure 2x12 m√®tres (radio)', description: '', price: 35.00 },
                { id: 3, name: 'Badge x 4', description: '', price: 25.00 },
                { id: 4, name: 'Centrale AX Pro', description: '', price: 350.00 },
                { id: 5, name: 'Centrale Jablotron', description: '', price: 350.00 },
                { id: 6, name: 'Centrale Titane', description: '', price: 350.00 },
                { id: 7, name: 'Clavier (radio)', description: '', price: 45.00 },
                { id: 8, name: 'D√©tecteur volum√©trique (radio)', description: '', price: 25.00 },
                { id: 9, name: 'D√©tecteur volum√©trique cam√©ra (radio)', description: '', price: 25.00 },
                { id: 10, name: 'D√©tecteur d\'ouverture (radio)', description: '', price: 25.00 },
                { id: 11, name: 'D√©tecteur de choc (radio)', description: '', price: 25.00 },
                { id: 12, name: 'D√©tecteur de bris de verre (radio)', description: '', price: 25.00 },
                { id: 13, name: 'D√©tecteur de fum√©e (radio)', description: '', price: 120.00 },
                { id: 14, name: 'D√©tecteur de mouvement ext√©rieur (cam√©ra)', description: '', price: 25.00 },
                { id: 15, name: 'D√©tecteur de rideau int√©rieur (radio)', description: '', price: 25.00 },
                { id: 16, name: 'Interphonie (radio sur secteur)', description: '', price: 120.00 },
                { id: 17, name: 'Sonde innondation (radio)', description: '', price: 25.00 },
                { id: 18, name: 'Sir√®ne d√©port√©e (radio)', description: '', price: 35.00 },
                { id: 19, name: 'T√©l√©commande (radio)', description: '', price: 120.00 }
            ];
            
            catalog['alarm-installation'] = [
                { id: 20, name: 'Installation, param√©trages, tests, mise en service & formation des utilisateurs', description: '', price: 0 }
            ];
            
            catalog['alarm-admin'] = [
                { id: 21, name: 'Carte SIM + activation', description: '', price: 50.00 },
                { id: 22, name: 'Frais de dossier', description: '', price: 190.00 }
            ];
            
            // Mat√©riel Cam√©ra
            catalog['camera-material'] = [
                { id: 23, name: 'Bullet Mini', description: '', price: 390.00 },
                { id: 24, name: 'Bullet XL Varifocale Night', description: '', price: 640.00 },
                { id: 25, name: 'Bullet Zone Alarme', description: '', price: 740.00 },
                { id: 26, name: 'Bullet Zoom x23', description: '', price: 990.00 },
                { id: 27, name: 'Cam√©ra de comptage', description: '', price: 860.00 },
                { id: 28, name: 'Coffret NVR 4P', description: '', price: 240.00 },
                { id: 29, name: 'Coffret NVR 8P', description: '', price: 360.00 },
                { id: 30, name: 'Disque dur 4 To', description: '', price: 270.00 },
                { id: 31, name: 'D√¥me Antivandale', description: '', price: 390.00 },
                { id: 32, name: 'D√¥me Mini Antivandale', description: '', price: 390.00 },
                { id: 33, name: 'D√¥me Night', description: '', price: 540.00 },
                { id: 34, name: 'D√¥me Plat Motoris√©', description: '', price: 390.00 },
                { id: 35, name: 'D√¥me XL Varifocale', description: '', price: 590.00 },
                { id: 36, name: 'D√¥me Zone Alarme', description: '', price: 740.00 },
                { id: 37, name: 'HDMI Ext.', description: '', price: 190.00 },
                { id: 38, name: 'Modem 4G', description: '', price: 290.00 },
                { id: 39, name: 'Moniteur Vid√©o 22"', description: '', price: 190.00 },
                { id: 40, name: 'Moniteur Vid√©o 28" 4K', description: '', price: 460.00 },
                { id: 41, name: 'Moniteur Vid√©o 32"', description: '', price: 490.00 },
                { id: 42, name: 'Onduleur 1000 - 60min', description: '', price: 360.00 },
                { id: 43, name: 'Onduleur 1500 - 90min', description: '', price: 600.00 },
                { id: 44, name: 'Onduleur 2200 - 120min', description: '', price: 830.00 },
                { id: 45, name: 'Onduleur 700 - 30min', description: '', price: 240.00 },
                { id: 46, name: 'Reo 4G + P.Solaire', description: '', price: 490.00 },
                { id: 47, name: 'Reo 4G motoris√© + P.solaire', description: '', price: 640.00 },
                { id: 48, name: 'Support Mural Articul√©', description: '', price: 100.00 },
                { id: 49, name: 'Switch POE', description: '', price: 270.00 }
            ];
            
            catalog['camera-installation'] = [
                { id: 50, name: 'Installation, param√©trages, tests, mise en service & formation des utilisateurs', description: 'pour 1/2 journ√©e', price: 690.00 }
            ];
            
            catalog['camera-remote'] = [
                { id: 51, name: 'Acc√®s √† distance s√©curis√© sur Modem ind√©pendant', description: '', price: 20.00 }
            ];
            
            catalog['camera-maintenance'] = [
                { id: 52, name: 'Assistance hotline, d√©placement(s), mat√©riels pi√®ce(s), main d\'≈ìuvre et support t√©l√©phonique', description: '', price: 0 },
                { id: 53, name: 'Garantie √©tendue 3 ans', description: 'Extension de garantie mat√©riel', price: 250.00 },
                { id: 54, name: 'Support technique', description: 'Assistance t√©l√©phonique 1 an', price: 100.00 }
            ];
            
            // Mettre √† jour l'affichage
            Object.keys(catalog).forEach(category => {
                updateCatalogDisplay(category);
            });
        }

        // Initialisation au chargement de la page
        window.addEventListener('DOMContentLoaded', function() {
            // Charger le catalogue sauvegard√© ou initialiser avec le catalogue r√©el
            loadCatalogFromStorage();
            
            // Si aucun catalogue sauvegard√©, charger le catalogue r√©el
            const hasData = Object.values(catalog).some(category => category.length > 0);
            if (!hasData) {
                initializeRealCatalog();
                saveCatalogToStorage(); // Sauvegarder le catalogue r√©el
            }
            
            // Initialiser les sections pour les deux types
            initializeSections('alarm');
            initializeSections('camera');
            
            console.log('G√©n√©rateur de devis initialis√© avec le design noir/jaune et TVA suisse');
        });

        // Gestion des erreurs globales
        window.addEventListener('error', function(event) {
            console.error('Erreur JavaScript:', event.error);
        });

        // Fermeture du modal en cliquant √† l'ext√©rieur
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('catalogModal');
            if (event.target === modal) {
                toggleCatalog();
            }
        });

        // Gestion des touches pour fermer le modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('catalogModal');
                if (modal.classList.contains('active')) {
                    toggleCatalog();
                }
            }
        });
    </script>
</body>
</html>
