<script>
  // --------- CATALOGUE PRODUITS (corrigé) ----------
  const catalog = {};

  // Alarme - Matériel
  catalog['alarm-material'] = [
    { id: 1,  name: "Bouton panique/Montre d’urgence (radio)", price: 35.00 },
    { id: 2,  name: "Barrière extérieure 2x12 mètres (radio)", price: 35.00 },
    { id: 3,  name: "Badge x 4", price: 25.00 },
    { id: 4,  name: "Centrale AX Pro", price: 6900.00 },
    { id: 5,  name: "Centrale Jablotron", price: 990.00 },
    { id: 6,  name: "Centrale Titane", price: 690.00 },
    { id: 7,  name: "Clavier (radio)", price: 45.00 },
    { id: 8,  name: "Détecteur volumétrique (radio)", price: 25.00 },
    { id: 9,  name: "Détecteur volumétrique caméra (radio)", price: 25.00 },
    { id: 10, name: "Détecteur d’ouverture (radio)", price: 25.00 },
    { id: 11, name: "Détecteur de choc (radio)", price: 25.00 },
    { id: 12, name: "Détecteur de bris de verre (radio)", price: 25.00 },
    { id: 13, name: "Détecteur de fumée (radio)", price: 120.00 },
    { id: 14, name: "Détecteur de mouvement extérieur (caméra)", price: 25.00 },
    { id: 15, name: "Détecteur de rideau intérieur (radio)", price: 25.00 },
    { id: 16, name: "Interphonie (radio sur secteur)", price: 120.00 },
    { id: 17, name: "Sonde innondation (radio)", price: 25.00 },
    { id: 18, name: "Sirène déportée (radio)", price: 35.00 },
    { id: 19, name: "Télécommande (radio)", price: 120.00 }
  ];

  // Alarme - Installation (OFFERT pris en charge)
  catalog['alarm-installation'] = [
    { id: 20, name: "Installation, paramétrages, tests, mise en service & formation des utilisateurs", price: 0.00, offered: true }
  ];

  // Alarme - Administratif
  catalog['alarm-admin'] = [
    { id: 21, name: "Carte SIM + activation", price: 50.00 },
    { id: 22, name: "Frais de dossier", price: 190.00 }
  ];

  // Caméra - Matériel
  catalog['camera-material'] = [
    { id: 23, name: "Bullet Mini", price: 390.00 },
    { id: 24, name: "Bullet XL Varifocale Night", price: 640.00 },
    { id: 25, name: "Bullet Zone Alarme", price: 740.00 },
    { id: 26, name: "Bullet Zoom x23", price: 990.00 },
    { id: 27, name: "Caméra de comptage", price: 860.00 },
    { id: 28, name: "Coffret NVR 4P", price: 240.00 },
    { id: 29, name: "Coffret NVR 8P", price: 360.00 },
    { id: 30, name: "Disque dur 4 To", price: 270.00 },
    { id: 31, name: "Dôme Antivandale", price: 390.00 },
    { id: 32, name: "Dôme Mini Antivandale", price: 390.00 },
    { id: 33, name: "Dôme Night", price: 540.00 },
    { id: 34, name: "Dôme Plat Motorisé", price: 390.00 },
    { id: 35, name: "Dôme XL Varifocale", price: 590.00 },
    { id: 36, name: "Dôme Zone Alarme", price: 740.00 },
    { id: 37, name: "HDMI Ext.", price: 190.00 },
    { id: 38, name: "Modem 4G", price: 290.00 },
    { id: 39, name: "Moniteur Vidéo 22\"", price: 190.00 },
    { id: 40, name: "Moniteur Vidéo 28\" 4K", price: 460.00 },
    { id: 41, name: "Moniteur Vidéo 32\"", price: 490.00 },
    { id: 42, name: "Onduleur 1000 - 60min", price: 360.00 },
    { id: 43, name: "Onduleur 1500 - 90min", price: 600.00 },
    { id: 44, name: "Onduleur 2200 - 120min", price: 830.00 },
    { id: 45, name: "Onduleur 700 - 30min", price: 240.00 },
    { id: 46, name: "Reo 4G + P.Solaire", price: 490.00 },
    { id: 47, name: "Reo 4G motorisé + P.solaire", price: 640.00 },
    { id: 48, name: "Support Mural Articulé", price: 100.00 },
    { id: 49, name: "Switch POE", price: 270.00 }
  ];

  // Caméra - Installation
  catalog['camera-installation'] = [
    { id: 50, name: "Installation, paramétrages, tests, mise en service & formation des utilisateurs", description: "pour 1/2 journée", price: 690.00 }
  ];

  catalog['camera-remote'] = [
    { id: 51, name: "Accès à distance sécurisé sur Modem indépendant", price: 20.00 }
  ];

  catalog['camera-maintenance'] = [
    { id: 52, name: "Assistance hotline, déplacement(s), matériels pièce(s), main d'œuvre et support téléphonique", price: 0.00, offered: true }
  ];

  // ---------- UI: Tabs ----------
  function showTab(tabName, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    const tab = document.getElementById(`${tabName}-tab`);
    if (tab) tab.classList.add('active');
    if (el) el.classList.add('active');
  }

  // ---------- Catalog Modal ----------
  function toggleCatalog() {
    document.getElementById('catalogModal').classList.toggle('active');
  }

  // Minimal render inside the catalog modal from our arrays
  function renderCatalogIntoModal() {
    const section = document.querySelector('.catalog-section > div:last-child');
    if (!section) return;

    // Build a simple list from alarm-material as an example (you can expand to all groups)
    const items = catalog['alarm-material'];
    section.innerHTML = items.map(p => `
      <div class="catalog-grid">
        <div class="product-item">
          <div class="product-name">${p.name}</div>
          <div class="product-description">${p.description ?? ""}</div>
        </div>
        <div>Qté: 1</div>
        <div><strong>${p.offered ? '<span class="free-label">OFFERT</span>' : (p.price.toFixed(2) + ' CHF')}</strong></div>
        <button class="btn btn-danger btn-small" disabled>Supprimer</button>
      </div>
    `).join('');
  }

  // ---------- Payment options ----------
  function wirePaymentOptions() {
    document.querySelectorAll('.payment-grid').forEach(grid => {
      grid.querySelectorAll('.payment-option').forEach(opt => {
        opt.addEventListener('click', () => {
          grid.querySelectorAll('.payment-option').forEach(s => s.classList.remove('active'));
          opt.classList.add('active');
        });
      });
    });
  }

  // ---------- jsPDF with Dialarme PNG logo ----------
  async function loadImageAsDataURL(url) {
    // Fetch image and convert to dataURL to avoid cross-origin issues in some contexts
    const res = await fetch(url, { mode: 'cors' });
    const blob = await res.blob();
    return await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }

  async function generatePDF(type) {
    const clientNameEl = document.getElementById('clientName');
    const commercialEl = document.getElementById('commercial');

    const clientName = clientNameEl ? (clientNameEl.value || 'Client') : 'Client';
    const commercial = commercialEl ? commercialEl.value : '';

    if (!commercial) {
      alert('Veuillez sélectionner un commercial avant de générer le PDF.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });

    // Add white page background
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), 'F');

    // Add Dialarme logo
    try {
      const logoDataUrl = await loadImageAsDataURL("https://dialarme.ch/wp-content/uploads/2024/11/LODO-MD.png");
      // Fit logo to ~140px width
      doc.addImage(logoDataUrl, 'PNG', 40, 32, 140, 50);
    } catch (e) {
      console.warn('Logo non chargé, poursuite sans logo', e);
    }

    // Header text
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text(`Devis ${type === 'camera' ? 'Caméra' : 'Alarme'}`, 200, 58);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Client : ${clientName}`, 200, 78);
    doc.text(`Commercial : ${commercial}`, 200, 94);
    doc.setDrawColor(244, 230, 0); // jaune Dialarme
    doc.setLineWidth(2);
    doc.line(40, 100, 555, 100);

    // (Démo) corps de PDF – à étendre selon vos sections/ totaux:
    doc.setFontSize(12);
    doc.text('Récapitulatif (démo) :', 40, 130);
    doc.text('- Contenu dynamique du devis à insérer ici', 60, 150);
    doc.text('- Sections : Matériel, Installation, Frais de dossier', 60, 170);
    doc.text('- Facilités de paiement : Comptant / 24 / 36 / 48 mois', 60, 190);

    // Footer
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text('Dialarme — Générateur de devis', 40, 800);

    doc.save(`Devis-${type}-${clientName}.pdf`);
  }

  // ---------- Modal close when clicking outside ----------
  document.addEventListener('click', (ev) => {
    const modal = document.getElementById('catalogModal');
    if (modal && ev.target === modal) toggleCatalog();
  });

  // ---------- ESC to close modal ----------
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape') {
      const modal = document.getElementById('catalogModal');
      if (modal && modal.classList.contains('active')) toggleCatalog();
    }
  });

  // ---------- On Ready ----------
  document.addEventListener('DOMContentLoaded', () => {
    wirePaymentOptions();
    renderCatalogIntoModal();
    console.log('Générateur de devis Dialarme chargé.');
  });

  // expose for HTML onclick
  window.showTab = showTab;
  window.toggleCatalog = toggleCatalog;
  window.generatePDF = generatePDF;
</script>
